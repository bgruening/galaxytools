<tool id="hclust2" name="hclust2" version="@VERSION@.0">
    <description>Plot heat-maps</description>
    <macros>
        <import>hclust2_macros.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="@VERSION@">hclust2</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    	hclust2.py
    		-i '$i'
    		#if $o == "png"
				-o 'output.png'
			#else if $o == "pdf"
				-o 'output.pdf'
			#else if $o == "svg"
				-o 'output.svg'
			#end if
        	--legend_file 'legend.png'

        	-t '$input_data.input_type.input_type_selector'
       		#if str($input_data.input_type.input_type_selector) == "data_matrix"
        		#if $input_data.input_type.out_table
        			--out_table '$out_table'
        		#end if
        	#end if

        	--fname_row '$input_data.fname_row'
        	--sname_row '$input_data.sname_row'
        	#if  $input_data.metadata_rows
        		--metadata_rows '$input_data.metadata_rows'
        	#end if
            #if $input_data.skip_rows
        	   --skip_rows '$input_data.skip_rows'
        	#end if
        	--sperc '$input_data.sperc'
        	--fperc '$input_data.fperc'
        	#if str($input_data.stop) != ''
        		--stop '$input_data.stop'
        	#end if
            #if str($input_data.ftop) != ''
        		--ftop '$input_data.ftop'
        	#end if
        	#if str($input_data.def_na) != ''
        		--def_na '$input_data.def_na'
        	#end if    

            --f_dist_f '$dist_param.f_dist_f'
        	--s_dist_f '$dist_param.s_dist_f'
			#if str($dist_param.load_dist_f_select.load_dist_f_selector) == "yes"
        		--load_dist_matrix_f '$dist_param.load_dist_f_select.load_dist_matrix_f'
        	#end if
        	#if str($dist_param.load_dist_s_select.load_dist_s_selector) == "yes"
        		--load_dist_matrix_s '$dist_param.load_dist_s_select.load_dist_matrix_s'
        	#end if
        	#if str($dist_param.load_pickled_dist_f_select.load_pickled_dist_f_selector) == "yes"
        		--load_pickled_dist_matrix_f '$dist_param.load_pickled_dist_f_select.load_pickled_dist_matrix_f'
        	#end if
        	#if str($dist_param.load_pickled_dist_s_select.load_pickled_dist_s_selector) == "yes"
        		--load_pickled_dist_matrix_s '$dist_param.load_pickled_dist_s_select.load_pickled_dist_matrix_s'
        	#end if

			#if $dist_param.save_pickled_dist_matrix_f
        		--save_pickled_dist_matrix_f '$save_pickled_dist_matrix_f'
        	#end if
        	#if $dist_param.save_pickled_dist_matrix_s
        		--save_pickled_dist_matrix_s '$save_pickled_dist_matrix_s'
        	#end if

        	$clust_param.no_fclustering
			$clust_param.no_sclustering        			
            --flinkage '$clust_param.flinkage'
        	--slinkage '$clust_param.slinkage'

        	--dpi '$heatmap_opt.dpi'
        	$heatmap_opt.log_scale
        	#if str($heatmap_opt.title)
        		--title '$heatmap_opt.title'
        	#end if
        	$heatmap_opt.sqrt_scale
			$heatmap_opt.no_slabels 
			$heatmap_opt.no_flabels        		
            #if str($heatmap_opt.minv) != ''
        		--minv '$heatmap_opt.minv'
        	#end if
        	#if str($heatmap_opt.maxv) != ''
        		--maxv '$heatmap_opt.maxv'
        	#end if        	
            --max_slabel_len '$heatmap_opt.max_slabel_len'
        	--max_flabel_len '$heatmap_opt.max_flabel_len'
        	--flabel_size '$heatmap_opt.flabel_size'
        	--slabel_size '$heatmap_opt.slabel_size'
        	--fdend_width '$heatmap_opt.fdend_width'
        	--sdend_height '$heatmap_opt.sdend_height'
        	--metadata_height '$heatmap_opt.metadata_height'
        	--metadata_separation '$heatmap_opt.metadata_separation'
        	--image_size '$heatmap_opt.image_size'
        	--cell_aspect_ratio '$heatmap_opt.cell_aspect_ratio'
        	-c '$heatmap_opt.c'        		
            #if $heatmap_opt.bottom_c
        		--bottom_c '$heatmap_opt.bottom_c'
        	#end if
        	#if $heatmap_opt.top_c
        		--top_c '$heatmap_opt.top_c'
        	#end if
        	#if $heatmap_opt.nan_c
        		--nan_c '$heatmap_opt.nan_c'
        	#end if

    ]]></command>
    <inputs>
        <param argument="-i" type="data" format="tabular" label="The input matrix"/>
       	<param argument="-o" type="select" label="Format for the output image">
        	<option value="png">PNG</option>
        	<option value="pdf">PDF</option>
        	<option value="svg">SVG</option>
        </param>
    	<section name="input_data" title="Input data matrix parameters" expanded="True">
        	<conditional name="input_type">
		    	<param name="input_type_selector" type="select" label="The input type can be a data matrix or distance matrix" help="(-t)">
		      		<option value="data_matrix" selected="true">Data Matrix</option>
		      		<option value="distance_matrix">Distance Matrix</option>
		    	</param>
		    	<when value="data_matrix">
		      			<param argument="--out_table" type="boolean" checked="false" truevalue="--out_table" falsevalue="" label="Write processed data matrix to file?" />
		    	</when>
    	        <when value="distance_matrix"> </when>
  		    </conditional>
			<param argument="--fname_row" type="integer" value="0" label="Row number containing the names of the features" help="Specify -1 if no names are present in the matrix"/>
			<param argument="--sname_row" type="integer" value="0" label="Column number containing the names of the samples" help="Specify -1 if no names are present in the matrix"/>
			<param argument="--sperc" type="integer" value="90" label="Percentile of sample value distribution for sample selection"/>
			<param argument="--fperc" type="integer" value="90" label=" Percentile of feature value distribution for feature selection"/>
			<param argument="--metadata_rows" type="text" optional="true" label="Row numbers to use as metadata" help="No input means no metadata"/>
			<param argument="--skip_rows" type="text" optional="true" label="Row numbers to skip (0-indexed, comma separated) from the input file" help="No input means no rows skipped" />
			<param argument="--stop" type="integer" value="" optional="true" label="Number of top samples to select" help="Ordering based on percentile specified by percentile of sample value distribution"/>
			<param argument="--ftop" type="integer" value="" optional="true" label="Number of top features to select" help="Ordering percentile specified by percentile of feature value distribution"/>
			<param argument="--def_na" type="float" value="" optional="true" label="Set the default value for missing values" help="No input means no replacement"/>
		</section>
		<section name="dist_param" title="Distance parameters" expanded="True">
			<param argument="--f_dist_f" type="select" label="Distance function for features">
				<option value="correlation" selected="true">Correlation</option>
	    		<expand macro="dist_options" />
	    	</param>
			<param argument="--s_dist_f" type="select" label="Distance function for sample">
				<option value="euclidean" selected="true">Euclidean</option>
				<expand macro="dist_options" />	
	    	</param>
	    	<conditional name="load_dist_f_select">
	    		<param name="load_dist_f_selector" type="select" label="Load distance matrix to be used for features?">
	    			<option value="yes">Yes</option>
		      		<option value="no" selected="true">No</option>
		      	</param>
		      	<when value="yes">
		      			<param argument="--load_dist_matrix_f" type="data" format="tabular" label="Distance matrix to be used for features" />
		    	</when>
    	        <when value="no"> </when>
  		    </conditional>

  		    <conditional name="load_dist_s_select">
	    		<param name="load_dist_s_selector" type="select" label="Load distance matrix to be used for samples?">
	    			<option value="yes">Yes</option>
		      		<option value="no" selected="true">No</option>
		      	</param>
		      	<when value="yes">
		      			 <param argument="--load_dist_matrix_s" type="data" format="tabular" label="Distance matrix to be used for samples"/>
		    	</when>
    	        <when value="no"> </when>
  		    </conditional>
  		    <conditional name="load_pickled_dist_f_select">
	    		<param name="load_pickled_dist_f_selector" type="select" label="Load distance matrix to be used for features as previously saved as pickle file using hclust2 itself?">
	    			<option value="yes">Yes</option>
		      		<option value="no" selected="true">No</option>
		      	</param>
		      	<when value="yes">
		      			 <param argument="--load_pickled_dist_matrix_f" type="data" format="tabular" label="Distance matrix to be use for features"/>
		    	</when>
    	        <when value="no"> </when>
  		    </conditional>
  		    <conditional name="load_pickled_dist_s_select">
	    		<param name="load_pickled_dist_s_selector" type="select" label="Load distance matrix to be used for samples as previously saved as pickle file using hclust2 itself?">
	    			<option value="yes">Yes</option>
		      		<option value="no" selected="true">No</option>
		      	</param>
		      	<when value="yes">
		      			 <param argument="--load_pickled_dist_matrix_s" type="data" format="tabular" label="Distance matrix to be used for samples"/>
		    	</when>
    	        <when value="no"> </when>
  		    </conditional>
			<param argument="save_pickled_dist_matrix_f" type="boolean" checked="false" truevalue="save_pickled_dist_matrix_f" falsevalue="" label="Save the distance matrix for features" />
			<param argument="--save_pickled_dist_matrix_s" type="boolean" checked="false" truevalue="--save_pickled_dist_matrix_s generate_pickled_dist_matrix_s" falsevalue="" label="Save the distance matrix for samples" />
		</section>
		<section name="clust_param" title="Clustering parameters" expanded="True">
			<param argument="--no_fclustering" type="boolean" checked="false" truevalue="--no_fclustering" falsevalue="" label="Avoid clustering features"/>
			<param argument="--no_sclustering" type="boolean" checked="false" truevalue="--no_sclustering" falsevalue="" label="Avoid clustering samples"/>
	    	<param argument="--flinkage" type="select" label="Linkage method for feature clustering">
	    		<expand macro="linkage_options" />
			</param>
			<param argument="--slinkage" type="select" label="Linkage method for sample clustering">
	    		<expand macro="linkage_options" />
			</param>
		</section>
		<section name="heatmap_opt" title="Heatmap options" expanded="True">
			<param argument="--title" type="text" optional="true" label="Title of the plot"/>
			<param argument="--dpi" type="integer" value="150" label="Image resolution in dpi"/>
			<param argument="--log_scale" type="boolean" checked="false" truevalue="--log_scale" falsevalue="" label="Log scale"/>
	        <param argument="--sqrt_scale" type="boolean" checked="false" truevalue="--sqrt_scale" falsevalue="" label="Square root scale"/>
			<param argument="--no_slabels" type="boolean" checked="false" truevalue="--no_slabels" falsevalue="" label="Do not show sample labels"/>
			<param argument="--no_flabels" type="boolean" checked="false" truevalue="--no_flabels" falsevalue="" label="Do not show feature labels"/>
			<param argument="--minv" type="float" value="" optional="true" label="Minimum value to display in the color map"/>
			<param argument="--maxv" type="float" value="" optional="true" label="Maximum value to display in the color map"/>
			<param argument="--max_slabel_len" type="integer" value="15" label="Max number of chars to report for sample labels"/>
			<param argument="--max_flabel_len" type="integer" value="15" label="Max number of chars to report for feature labels"/>
			<param argument="--flabel_size" type="integer" value="10" label="Feature label font size"/>
			<param argument="--slabel_size" type="integer" value="10" label="Sample label font size"/>
			<param argument="--fdend_width" type="float" value="1" label="Width of the feature dendrogram" help="1 meaning 100% of default heatmap width"/>
			<param argument="--sdend_height" type="float" value="1" label="Height of the sample dendrogram" help="1 meaning 100% of default heatmap height"/>
			<param argument="--metadata_height" type="float" value="0.05" label="Height of the metadata panel" help="0.05 meaning 5% of default heatmap height"/>
			<param argument="--metadata_separation" type="float" value="0.001" label="Distance between the metadata and data panels" help="0.001 meaning 0.1% of default heatmap height"/>
			<param argument="--image_size" type="float" value="8" label="Size of the largest between width and eight size for the image in inches"/>
			<param argument="--cell_aspect_ratio" type="float" value="1.0" label="Aspect ratio between width and height for the cells of the heatmap"/>
			<param argument="-c" type="select" label="Color Map [default bbcry]">
				<option value="bbcry" selected="true">bbcry</option>
				<expand macro="color_options" />
			</param>
			<param argument="--bottom_c" type="text" optional="true" label="Color to use for cells below the minimum value of the scale" help="No input means no bottom color of the scale" />
			<param argument="--top_c" type="text" optional="true" label="Color to use for cells below the maximum value of the scale" help="No input means no top color of the scale" />
			<param argument="--nan_c" type="text" optional="true" label="Color to use for nan cells" help="No input means no color for nan cells" />
		</section>
    </inputs>
    <outputs>
		<data format="png" name="out_png" from_work_dir="output.png" label="${tool.name} on ${on_string}: Output image file">
			 <filter>o == "png"</filter>
		</data>
        <data format="pdf" name="out_pdf" from_work_dir="output.pdf" label="${tool.name} on ${on_string}: Output image file">
			 <filter>o == "pdf"</filter>
		</data>
		<data format="svg" name="out_svg" from_work_dir="output.svg" label="${tool.name} on ${on_string}: Output image file">
			 <filter>o == "svg"</filter>
		</data>			 
    	<data format="png" name="legend_file" from_work_dir="legend.png" label="${tool.name} on ${on_string}: Output legend file"/>
    	<data format="tabular" name="out_table" label="${tool.name} on ${on_string}: Out table">
      		<filter>input_type['input_type_selector'] == 'data_matrix' and input_data.input_type.out_table ==True</filter>
      	</data>
      	<data format="tabular" name="save_pickled_dist_matrix_f" label="${tool.name} on ${on_string}: Pickled distance matrix for features">
      		<filter>dist_param.save_pickled_dist_matrix_f == True</filter>
      	</data>
      	<data format="tabular" name="save_pickled_dist_matrix_s" label="${tool.name} on ${on_string}: Pickled distance matrix for samples">
      		<filter>dist_param.save_pickled_dist_matrix_s == True</filter>
      	</data>	
    </outputs>
    <tests>
        <test>
            <param name="i" value="HMP.species.txt" ftype="tabular"/>
            <param name="o" value="png"/>
        	<section name="input_data">
	            <conditional name="input_type">
	        	    <param name="input_type_selector" value="data_matrix"/>
		            <param name="out_table" value="True" />
	            </conditional>
	            <param name="fname_row" value="0"/>
	            <param name="sname_row" value="0"/>
	            <param name="metadata_rows" value="2,3,4"/>
	            <param name="skip_rows" value="1"/>
	            <param name="sperc" value="90"/>
	            <param name="fperc" value="99"/>
	            <param name="stop" value=""/>
	            <param name="ftop" value="50"/>
	            <param name="def_na" value=""/>
        	</section>
	        <section name="dist_param">
	            <param name="f_dist_f" value="correlation"/>
	            <param name="s_dist_f" value="braycurtis"/>
	            <conditional name="load_pickled_dist_f_select">
	            	<param name="load_pickled_dist_f_selector" value="yes" />
	            	<param name="load_pickled_dist_matrix_f" value="dist_f.tabular" />
	            </conditional>
	            <conditional name="load_pickled_dist_s_select">
	            	<param name="load_pickled_dist_s_selector" value="yes" />
	            	<param name="load_pickled_dist_matrix_s" value="dist_s.tabular" />
	            </conditional>
	            <param name="save_pickled_dist_matrix_f" value="True"/>
	            <param name="save_pickled_dist_matrix_s" value="True"/>
	        </section>
	        <section name="clust_param">
	            <param name="no_fclustering" value=""/>
	            <param name="no_sclustering" value=""/>
	            <param name="flinkage" value="average"/>
	            <param name="slinkage" value="complete"/>
	        </section>
	        <section name="heatmap_opt">
	            <param name="dpi" value="300"/>
	            <param name="log_scale" value=""/>
	            <param name="sqrt_scale" value="True"/>
	            <param name="title" value=""/>
	            <param name="no_slabels" value="True"/>
	            <param name="no_flabels" value=""/>
	            <param name="minv" value="0.01"/>
	            <param name="maxv" value=""/>
	            <param name="max_slabel_len" value="15"/>
	            <param name="max_flabel_len" value="100"/>
	            <param name="flabel_size" value="4"/>
	            <param name="slabel_size" value="10"/>
	            <param name="fdend_width" value="1"/>
	            <param name="sdend_height" value="1"/>
	            <param name="metadata_height" value="0.075"/>
	            <param name="metadata_separation" value="0.001"/>
	            <param name="image_size" value="8.0"/>
	            <param name="cell_aspect_ratio" value="9"/>
	            <param name="c" value="bbcry"/>
	            <param name="bottom_c" value=""/>
	            <param name="top_c" value=""/>
	            <param name="nan_c" value=""/>
	        </section>
            <output name="out_png" file="HMP.sqrt_scale.png" ftype="png"/>
            <output name="legend_file" file="HMP.sqrt_scale.legend.png" ftype="png"/>
            <output name="out_table" file="out_table.tabular" ftype="tabular"/>
            <output name="save_pickled_dist_matrix_f" file="dist_f.tabular" ftype="tabular" />
            <output name="save_pickled_dist_matrix_s" file="dist_s.tabular" ftype="tabular" />
        </test>

        <test>
            <param name="i" value="HMP.species.txt" ftype="tabular"/>
            <param name="o" value="png"/>
        	<section name="input_data">
	            <param name="fname_row" value="0"/>
	            <param name="sname_row" value="0"/>
	            <param name="metadata_rows" value="2,3,4"/>
	            <param name="skip_rows" value="1"/>
	            <param name="sperc" value="90"/>
	            <param name="fperc" value="99"/>
	            <param name="stop" value=""/>
	            <param name="ftop" value="50"/>
	            <param name="def_na" value=""/>
        	</section>
	        <section name="dist_param">
	            <param name="f_dist_f" value="correlation"/>
	            <param name="s_dist_f" value="braycurtis"/>
	            <param name="save_pickled_dist_matrix_f" value=""/>
	            <param name="save_pickled_dist_matrix_s" value=""/>
	        </section>
	        <section name="clust_param">
	            <param name="no_fclustering" value=""/>
	            <param name="no_sclustering" value=""/>
	            <param name="flinkage" value="average"/>
	            <param name="slinkage" value="complete"/>
	        </section>
	        <section name="heatmap_opt">
	            <param name="dpi" value="300"/>
	            <param name="log_scale" value="True"/>
	            <param name="sqrt_scale" value=""/>
	            <param name="title" value=""/>
	            <param name="no_slabels" value="True"/>
	            <param name="no_flabels" value=""/>
	            <param name="minv" value="0.01"/>
	            <param name="maxv" value=""/>
	            <param name="max_slabel_len" value="15"/>
	            <param name="max_flabel_len" value="100"/>
	            <param name="flabel_size" value="4"/>
	            <param name="slabel_size" value="10"/>
	            <param name="fdend_width" value="1"/>
	            <param name="sdend_height" value="1"/>
	            <param name="metadata_height" value="0.075"/>
	            <param name="metadata_separation" value="0.001"/>
	            <param name="image_size" value="8.0"/>
	            <param name="cell_aspect_ratio" value="9"/>
	            <param name="c" value="bbcry"/>
	            <param name="bottom_c" value="green"/>
	            <param name="top_c" value="blue"/>
	            <param name="nan_c" value="red"/>
	        </section>
            <output name="out_png" file="HMP.log_scale.png" ftype="png"/>
            <output name="legend_file" file="HMP.log_scale.legend.png" ftype="png"/>
        </test>
    </tests>

    <help><![CDATA[

    **What it does**

    Hclust2 is a handy tool for plotting heat-maps with several useful options to produce high quality figures that can be used in publication. For more information, check ` <https://bitbucket.org/nsegata/hclust2>`_.
    ]]></help>

    <citations>
		<citation type="doi">TODO</citation>
    </citations>
</tool>