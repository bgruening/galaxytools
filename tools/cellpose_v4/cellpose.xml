<tool id="cellpose" name="Run superhuman generalization for cellular segmentation" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.2">
    <description>with Cellpose SAM</description>
    <macros>
        <token name="@TOOL_VERSION@">4.0.7</token>
        <token name="@VERSION_SUFFIX@">1</token>
    </macros>
    <requirements>
	    <!-- TODO: uncomment below line when container become available. It was already merged into biocontainer-->
	    <!-- <container type="docker">quay.io/biocontainers/cellpose:@TOOL_VERSION@</container>-->
    </requirements>
    <stdio>
        <exit_code range="1:" level="fatal" description="Error occurred. Please check Tool Standard Error"/>
    </stdio>
    <version_command>echo "@VERSION@"</version_command>
    <command detect_errors="exit_code">
         <![CDATA[
        export MKL_NUM_THREADS=1 &&
        export CELLPOSE_LOCAL_MODELS_PATH='cellpose_models' &&
        ln -s '${img_in}' ./image.${img_in.ext} &&
	
	cellpose --image_path ./image.${img_in.ext} 
	#if $save_png
           --save_png 
        #end if
       #if $save_tif
          --save_tif 
	#end if
        #if $save_flows
          --save_flows 
        #end if
	#if $save_outlines
           --save_outlines 
        #end if
        #if $use_gpu
	   --use_gpu 
        #end if
        #if $no_norm
           --no_norm 
        #end if
        #if $diameter
            --diameter $diameter 
        #end if
        #if $no_resample
           --no_resample 
        #end if
        --flow_threshold $flow_threshold 
       --cellprob_threshold $cellprob_threshold 
       --niter $niter 
       --anisotropy $anisotropy 
       #if $do_3D
          --do_3D 
       #end if
       #if $transformer 
           --transformer
       #end if
        
        ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
    </configfiles>
    <inputs>
        <param name="img_in" type="data" format="ome.tiff,tiff,jpg,png" label="Choose the image file for segmention (usually after registration)"/>
	<param name="save_png" type="boolean" checked="true" label="Save masks as png?"/>
	<param name="save_tif" type="boolean" checked="false" label="Save masks as tiff?"/>
	<param name="save_flows" type="boolean" checked="false" label="Save RGN images of flows when masks are saved?"/>
        <param name="save_outlines" type="boolean" checked="false" label="Save RGB outline images when masks are saved"/>

	<param name="use_gpu" type="boolean" checked="false" label="Whether to use GPU?" />

	<section name="options" title="Advanced Options" expanded="False">
            <param argument="no_norm" type="boolean" label="Do not normalize images" checked="false"/>
            <param argument="diameter" type="float" optional="true" label="Cell or nuclei diameter in pixels" help="Leave blank for automated estimation."/>
	    <param name="no_resample" type="boolean" checked="false" label="Disables flows/cellprob resampling to original image size before computing masks."
                help="Using this flag will make more masks more jagged with larger diameter settings."/>
            <param argument="flow_threshold" type="float" min="0" value="0.4" label="Flow error threshold (all cells with errors below threshold are kept) (not used for 3D)"/>
            <param argument="cellprob_threshold" type="float" value="0.0" label="Cell probability threshold (all pixels with prob above threshold kept for masks)"/>
            <param argument="niter" type="integer" min="0" value="0" label="Number of iterations"
		    help="By defalut, sets the number of iterations to be proportional to the ROI diameter. For longer ROIs, more iterations might be needed."/>
            <param argument="anisotropy" type="float" min="0" value="1.0" label="Anisotropy of volume in 3D"
                help="By defalut, sets the number of iterations to be proportional to the ROI diameter. For longer ROIs, more iterations might be needed."/>
	    <param argument="do_3D" type="boolean" truevalue="booltrue" falsevalue="boolfalse" checked="false" label="Whether to run 3D segmentation on 4D image input?"/>
            <param argument="transformer" type="boolean" truevalue="booltrue" falsevalue="boolfalse" checked="false" label="Whether to use transformer backnone" help="pretrained model from Cellpose3 is transformer_cp3"/>
        </section>
    </inputs>
    <outputs>
	    <data format="tiff" name="cp_tiff" from_work_dir="cp_masks.tif" label="Cellpose SAM masks in TIFF">
		    <filter>save_tiff</filter>
	    </data>
	    <data format="png" name="cp_png" from_work_dir="cp_masks.png" label="Cellpose SAM masks in PNG">
		    <filter>save_png</filter>
	    </data>
            <data format="tiff" name="cp_flows" from_work_dir="cp_mask_flows.tif" label="RGB images of flows">
                    <filter>save_flows</filter>
	    </data>
	    <data format="tiff" name="cp_flows_dp" from_work_dir="cp_masks_flows_dp.tif" label="RGB images of flows(dP)">
                    <filter>save_flows</filter>
            </data>
            <data format="png" name="cp_outlines" from_work_dir="cp_outlines.png" label="RGB outline images">
                    <filter>save_outlines</filter>
            </data>

    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="img_in" value="img02.png"/>
	    <param name="save_png" value="true" />
	    <param name="save_tif" value="true"/>
            <output name="cp_tiff" file="img02_cp_masks_cpsam.tif" compare="image_diff"/>
            <output name="cp_png" file="img02_cp_masks_cpsam.png" compare="image_diff"/>
        </test>
        <test expect_num_outputs="4">
            <param name="img_in" value="img02.png"/>
	    <param name="save_flows" value="true"/>
	    <param name="save_outlines" value="true" />
	    <output name="cp_png" file="img02_cp_masks_cpsam.png" compare="image_diff"/>
            <output name="cp_flows" file="img02_flows_cp_masks_cpsam.tif" compare="image_diff"/>
	    <output name="cp_flows_dp" file="img02_dP_cp_masks_cpsam.tif" compare="image_diff"/>
	    <output name="cp_outlines" file="img02_outlines_cp_masks_cpsam.png" compare="image_diff"/>
        </test>
	<test expect_num_outputs="1">
           <param name="img_in" value="img02.png" />
           <param name="save_png" value="true" />
           <section name="options">
                <param name="no_norm" value="false" />
                <param name="no_resample" value="false" />
                <param name="diameter" value="10" />
                <param name="flow_threshold" value="0.5" />
                <param name="cellprob_threshold" value="0.0" />
                <param name="niter" value="10" />
                <param name="anisotropy" value="1.0" />
                <param name="do_3D" value="false" />
	        <param name="transformer" value="false" />
            </section>
            <output name="cp_png" file="image02_cp_masks.png" ftype="png"/>
        </test>
    </tests>
    <help>
        <![CDATA[
        Cellpose-SAM: superhuman generalization for cellular segmentation
        ]]>
    </help>
    <citations>
        <citation type="doi">https://doi.org/10.1101/2025.04.28.651001</citation>
    </citations>
</tool>
