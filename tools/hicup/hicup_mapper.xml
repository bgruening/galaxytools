<tool id="hicup_mapper" name="HiCUP Mapper" version="0.1.0">
    <requirements>
        <requirement>hicup</requirement>    
        <requirement>bowtie2</requirement>
        <requirement>samtools</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        ##set BOWTIE_PATH = '$(whereis bowtie2 | awk '{split($0,a); print a[2]}')'
        ##BOWTIE_PATH="$(whereis bowtie2 | awk '{split($0,a," "); print a[2]}')" &&
        #set BOWTIE_PATH = '/home/joachim/miniconda2/bin/bowtie2'
        #set index_path = ''
        #if str($reference_genome.source) == "history":
            bowtie2-build "$reference_genome.own_file" genome &amp;&amp;
            ln -s "$reference_genome.own_file" genome.fa &amp;&amp;
            #set index_path = 'genome'
        #else:
            #set index_path = $reference_genome.index.fields.path
        #end if
        hicup_mapper
        --index $index_path 
        --bowtie2 $BOWTIE_PATH
        
        #if $advanced_options.format
            --format $advanced_options.format
        #end if 
        --threads $advanced_options.threads
        $advanced_options.zip 
        #for $sequence_file in $input_sequences_to_map:
            $sequence_file
        #end for
    ]]></command>
    <inputs>
        <param name="input_sequences_to_map" type="data" format="txt" label="Sequence files to map" multiple="true"/>
        <conditional name="reference_genome">
            <param name="source" type="select" label="Will you select a reference genome from your history or use a built-in index?" help="Built-ins were indexed using default options. See `Indexes` section of help below">
                <option value="indexed">Use a built-in genome index</option>
                <option value="history">Use a genome from the history and build index</option>
            </param>
            <when value="indexed">
                <param name="index" type="select" label="Select reference genome" help="If your genome of interest is not listed, contact the Galaxy team">
                <options from_data_table="bowtie2_indices">
                    <filter type="sort_by" column="2"/>
                    <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                </options>
                </param>
            </when>
            <when value="history">
                <param name="own_file" type="data" format="fasta" metadata_name="dbkey" label="Select reference genome" />
            </when>
        </conditional>
        <section name="advanced_options" title="Advanced options">        
            <param argument="--format" type="select" label="Data format:" help="Specify FASTQ format
                Options: Sanger, Solexa_Illumina 1.0, Illumina 1.3, Illumina 1.5">
                <option value="" selected="true">Automatic detection</option>
                <option value="Sanger" selected="true">Sanger</option>
                <option value="Solexa_Illumina_1.0">Solexa_Illumina 1.0</option>
                <option value="Illumina_1.3">Illumina 1.3</option>
                <option value="Illumina_1.5">Illumina 1.5</option>
            </param>
            <param argument="--threads" type="integer" value="1" label="Threads" help="Specify the number of threads, allowing simultaneous processing of multiple files"/>
            <param argument="--zip" type="boolean" value="false" truevalue="--zip" falsevalue="" label="Compress output" help="Compress the output with zip"/>
        </section>
    </inputs>
    <outputs>
    <data format="" name="hicup_mapper_summary">
        <discover_datasets pattern="__designation_and_ext__" visible="true" />
    </data>
    </outputs>
    <help><![CDATA[
       Valid Hi-C ligation products comprise two restriction fragments from different regions of the genome ligated together. This program maps Hi-C di-tags against a reference genome to determine from where each restriction fragment is derived. Following mapping the forward and reverse reads are paired i.e. two input files result in one output file.

HiCUP Mapper uses the sequence alignment programs Bowtie or Bowtie2 to perform the mapping.
Bowtie mapping parameters:

-p 1 -n 1 -m 1 –best

-p 1: launches Bowtie with only one search thread. Although limiting the search to one processor is slower on multi-core machines, it ensures the order of the returned mapped reads is the same as found in the input file (ignoring omitted unmapped sequences), essential for the correct functioning of HiCUP. (Bowtie actually defaults to -p 1, but this has been made explicit in the Perl script due to the importance of preserving the read order.)

-n 1: alignments may have no more than 1 mismatch in the first 28 bases (seed) and the sum of the Phred quality values at all mismatched positions (not just in the seed) may not exceed 70. Bowtie rounds quality values to the nearest 10, saturating at 30.

-m 1: report only unique alignments

–best: reports alignments in best-to-worst order

The configuration file sets the parameters for HiCUP Mapper, it contains: i) names of files to be mapped; ii) local path to Bowtie; iii) path to the relevant reference genome Bowtie indices; iv) the sequence format.
Bowtie2 Mapping Parameters:

–very-sensitive: slower but a more sensitive and more accurate option

–no-unal: suppress SAM records for reads that failed to align.

-p 1: same as for Bowtie (see above)
    ]]></help>
</tool>