<tool id="hicup_mapper" name="Mapper" version="0.1.0">
    <requirements>
            <requirement type="package" version="0.5.9">hicup</requirement>
            <requirement type="package" version="2.2.6">bowtie2</requirement>
            <requirement type="package" version="1.2">samtools</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        BOWTIE_PATH_BASH="\$(which bowtie2)" &&
        #set index_path = ''
        #if str($reference_genome.source) == "history":
           bowtie2-build "$reference_genome.own_file" genome &&
           ln -s "$reference_genome.own_file" genome.fa &&
           #set index_path = 'genome'
        #else:
           #set index_path = $reference_genome.index.fields.path
        #end if
        hicup_mapper
        --index '$index_path' 
        --bowtie2 \$BOWTIE_PATH_BASH
        
        #if $advanced_options.format
            --format '$advanced_options.format'
        #end if 
        #for $sequence_file in $input_sequences_to_map:
            $sequence_file
        #end for
        && mv hicup_mapper_summary* hicup_mapper_summary.txt &&
        mv *.pair.sam result.pair.sam
    ]]></command>
    <inputs>
        <param name="input_sequences_to_map" type="data" format="trunc" label="Sequence files to map" multiple="true"/>
        <conditional name="reference_genome">
            <param name="source" type="select" label="Will you select a reference genome from your history or use a built-in index?" help="Built-ins were indexed using default options. See `Indexes` section of help below">
                <option value="indexed">Use a built-in genome index</option>
                <option value="history">Use a genome from the history and build index</option>
            </param>
            <when value="indexed">
                <param name="index" type="select" label="Select reference genome" help="If your genome of interest is not listed, contact the Galaxy team">
                <options from_data_table="bowtie2_indices">
                    <filter type="sort_by" column="2"/>
                    <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                </options>
                </param>
            </when>
            <when value="history">
                <param name="own_file" type="data" format="fasta" metadata_name="dbkey" label="Select reference genome" />
            </when>
        </conditional>
        <section name="advanced_options" title="Advanced options">        
            <param argument="--format" type="select" label="Data format:" help="Specify FASTQ format
                Options: Sanger, Solexa_Illumina 1.0, Illumina 1.3, Illumina 1.5">
                <option value="" selected="true">Automatic detection</option>
                <option value="Sanger">Sanger</option>
                <option value="Solexa_Illumina_1.0">Solexa_Illumina 1.0</option>
                <option value="Illumina_1.3">Illumina 1.3</option>
                <option value="Illumina_1.5">Illumina 1.5</option>
            </param>
        </section>
    </inputs>
    <outputs>
    <!--<data format="" name="hicup_mapper">
        <discover_datasets pattern="__designation_and_ext__" visible="true" />
    </data>-->
        <data name="hicup_mapper_summary" format="txt" from_work_dir="hicup_mapper_summary.txt"/>
        <data name="result.pair" format="sam" from_work_dir="result.pair.sam"/>
        <data name="Rplots" format="pdf" from_work_dir="Rplots.pdf"/>
    
    </outputs>
     <tests>
        <test>
            <param name="input_first_sequence" value="dataset1.trunc.fastq" ftype="fastq"/>
            <param name="input_second_sequence" value="dataset2.trunc.fastq" ftype="fastq"/>
            <param name="reference_genome" value="history"/>
            <param name="own_file" value="ch1_reduced.fa"/>
            
            
            <output name="Rplots" file="Rplots.pdf"/>
            <output name="hicup_mapper_summary" file="hicup_mapper_summary.txt"/>
            <output name="dataset1_2.pair.sam" file="dataset1_2.pair.sam"/>
            
        </test>
    </tests>
    <help><![CDATA[

    For help please consult the documentation of HiCUP: http://www.bioinformatics.babraham.ac.uk/projects/hicup/overview/

    To get more information about the mapper visit: http://www.bioinformatics.babraham.ac.uk/projects/hicup/scripts_description/#Mapper
    ]]></help>
    <citations>
        <citation type="bibtex">
            @article{wingett2015hicup,
                title={HiCUP: pipeline for mapping and processing Hi-C data},
                author={Wingett, Steven and Ewels, Philip and Furlan-Magaril, Mayra and Nagano, Takashi and Schoenfelder, Stefan and Fraser, Peter and Andrews, Simon},
                journal={F1000Research},
                volume={4},
                year={2015},
                publisher={Faculty of 1000 Ltd}
                }
        </citation>
    </citations>
</tool>