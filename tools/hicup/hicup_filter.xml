<tool id="hicup_filter" name="Filter" version="0.1.0">
    <requirements>
        <requirement type="package" version="0.5.9">hicup</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        hicup_filter --digest '$digest'
        #if $advanced_options.longest:
            --longest '$advanced_options.longest'
        #end if
        #if $advanced_options.shortest:
            --shortest '$advanced_options.shortest'
        #end if
        #for $file in $inputFiles:
            $file
        #end for
        && mv hicup_filter_ditag_rejects* hicup_filter_ditag_rejects
        && mv *filt.sam dataset.filt.sam
        && mv hicup_filter_summary* hicup_filter_summary.txt
        && mv hicup_filter_ditag_rejects/*contiguous.filter.sam hicup_filter_ditag_rejects/dataset.contiguous.filter.sam
        && mv hicup_filter_ditag_rejects/*re_ligation.filter.sam  hicup_filter_ditag_rejects/dataset.re_ligation.filter.sam 
        && mv hicup_filter_ditag_rejects/*same_dangling_ends.filter.sam hicup_filter_ditag_rejects/dataset.same_dangling_ends.filter.sam
        && mv hicup_filter_ditag_rejects/*invalid.filter.sam hicup_filter_ditag_rejects/dataset.invalid.filter.sam 
        && mv hicup_filter_ditag_rejects/*same_circularised.filter.sam hicup_filter_ditag_rejects/dataset.same_circularised.filter.sam
        && mv hicup_filter_ditag_rejects/*same_internal.filter.sam hicup_filter_ditag_rejects/dataset.same_internal.filter.sam
        #if $advanced_options.longest or $advanced_options.shortest: 
        && mv hicup_filter_ditag_rejects/*wrong_size.filter.sam hicup_filter_ditag_rejects/dataset.wrong_size.filter.sam
        #end if
    ]]></command>
    <inputs>
        <param name="inputFiles" type="data" multiple="true" format="bam,sam" label="Input"/>
        <param argument="--digest" type="data" format="txt" label="Genome digest file" help="Specify the genome digest file (created by hicup_digester)"/>
        <section name="advanced_options" title="Advanced options">
            <param argument="--longest" type="text" value="" label="Max insert size" help="Maximum allowable insert size (bps)"/>
            <param argument="--shortest" type="text" value="" label="Min insert size" help="Minimum allowable insert size (bps)"/>
        </section>
    </inputs>
    <outputs>
        <data name="dataset_filt" format="sam" from_work_dir="dataset.filt.sam" label="filt.sam"/>
        <data name="hicup_filter_summary" format="txt" from_work_dir="hicup_filter_summary.txt" label="hicup_filter_summary.txt"/>
        <data name="contiguous_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.contiguous.filter.sam" label="contiguous.filter.sam"/>
        <data name="re_ligation_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.re_ligation.filter.sam" label="re_ligation.filter.sam"/>
        <data name="same_dangling_ends_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_dangling_ends.filter.sam" label="same_dangling_ends.filter.sam"/>
        <data name="invalid_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.invalid.filter.sam" label="invalid.filter.sam"/>
        <data name="same_circularised_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_circularised.filter.sam" label="same_circularised.filter.sam"/>
        <data name="same_internal_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_internal.filter.sam" label="same_internal.filter.sam"/>
        <data name="wrong_size_filter" format="sam" from_work_dir="hicup_filter_ditag_rejects/dataset.wrong_size.filter.sam" label="wrong_size.filter.sam"/>
    </outputs>
    <tests>
        <test>
            <param name="digest" value="digester_file.txt" ftype="txt"/>
            <param name="inputFiles" value="dataset1_2.pair.sam" ftype="sam"/>
            <param name='advanced_options|longest' value="800"/>
            <param name='advanced_options|shortest' value="150">
            <output name="hicup_filter_summary" file="hicup_filter_summary.txt" />
            <output name="dataset_filt" file="dataset1_2.filt.sam" compare="sim_size" delta="50"/>
            <output name="contiguous_filter" file="dataset1_2.contiguous.filter.sam" compare="sim_size" delta="50"/>
            <output name="re_ligation_filter" file="dataset1_2.re_ligation.filter.sam" compare="sim_size" delta="50"/>
            <output name="same_dangling_ends_filter" file="dataset1_2.same_dangling_ends.filter.sam" compare="sim_size" delta="50"/>
            <output name="invalid_.filter" file="dataset1_2.invalid.filter.sam" compare="sim_size" delta="50"/>
            <output name="same_circularised_filter" file="dataset1_2.same_circularised.filter.sam" compare="sim_size" delta="50"/>
            <output name="same_internal_filter" file="dataset1_2.same_internal.filter.sam" compare="sim_size" delta="50"/>
            <output name="wrong_size_filter" file="dataset1_2.wrong_size.filter.sam" compare="sim_size" delta="50"/>
        </test>
    </tests>
    <help><![CDATA[

    For help please consult the documentation of HiCUP: http://www.bioinformatics.babraham.ac.uk/projects/hicup/overview/

    To get more information about the filter visit: http://www.bioinformatics.babraham.ac.uk/projects/hicup/scripts_description/#Filter
    ]]></help>
    <citations>
        <citation type="bibtex">
            @article{wingett2015hicup,
                title={HiCUP: pipeline for mapping and processing Hi-C data},
                author={Wingett, Steven and Ewels, Philip and Furlan-Magaril, Mayra and Nagano, Takashi and Schoenfelder, Stefan and Fraser, Peter and Andrews, Simon},
                journal={F1000Research},
                volume={4},
                year={2015},
                publisher={Faculty of 1000 Ltd}
                }
        </citation>
    </citations>
</tool>
