<tool id="hicup_filter" name="Hicup Filter" version="@VERSION@.0">
    <description>classifies read pairs, identifying valid Hi-C di-tags.</description>
    <macros>
        <import>hicup_macros.xml</import>
    </macros>
    <expand macro="requirements_hicup" />
    <command detect_errors="exit_code"><![CDATA[
        #for $i, $file in enumerate($inputFiles):
            #if $file.ext == 'bam':
                samtools view -h -o ./${i}.sam '$file' &&
            #end if
        #end for



        hicup_filter --digest '$digest'
        #if $advanced_options.longest:
            --longest '$advanced_options.longest'
        #end if
        #if $advanced_options.shortest:
            --shortest '$advanced_options.shortest'
        #end if

        #for $i, $file in enumerate($inputFiles):
            #if $file.ext == 'bam':
                ./${i}.sam
            #else:
                '$file'
            #end if
        #end for

        && mv hicup_filter_ditag_rejects* hicup_filter_ditag_rejects
        && samtools view -bS *filt.sam | samtools sort - -o dataset.filt.bam
        && mv hicup_filter_summary* hicup_filter_summary.txt
        && samtools view -bS hicup_filter_ditag_rejects/*contiguous.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.contiguous.filter.bam
        && samtools view -bS hicup_filter_ditag_rejects/*re_ligation.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.re_ligation.filter.bam 
        && samtools view -bS hicup_filter_ditag_rejects/*same_dangling_ends.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.same_dangling_ends.filter.bam
        && samtools view -bS hicup_filter_ditag_rejects/*invalid.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.invalid.filter.bam
        && samtools view -bS hicup_filter_ditag_rejects/*same_circularised.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.same_circularised.filter.bam
        && samtools view -bS hicup_filter_ditag_rejects/*same_internal.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.same_internal.filter.bam

        #if $advanced_options.longest or $advanced_options.shortest:
            && samtools view -bS hicup_filter_ditag_rejects/*wrong_size.filter.sam | samtools sort - -o hicup_filter_ditag_rejects/dataset.wrong_size.filter.bam
        #end if

    ]]></command>
    <inputs>
        <param name="inputFiles" type="data" multiple="true" format="sam,bam" label="Input files in BAM or SAM fomat"/>
        <param argument="--digest" type="data" format="txt" label="Genome digest file" help="Specify the genome digest file (created by hicup_digester)"/>
        <section name="advanced_options" title="Advanced options">
            <expand macro="filter_longest_shortest" />
        </section>
    </inputs>
    <outputs>
        <data name="dataset_filt" format="bam" from_work_dir="dataset.filt.bam" label="filt.bam" />
        <data name="hicup_filter_summary" format="txt" from_work_dir="hicup_filter_summary.txt" label="hicup_filter_summary.txt" />
        <data name="contiguous_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.contiguous.filter.bam" label="contiguous.filter.bam" />
        <data name="re_ligation_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.re_ligation.filter.bam" label="re_ligation.filter.bam" />
        <data name="same_dangling_ends_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_dangling_ends.filter.bam" label="same_dangling_ends.filter.bam" />
        <data name="invalid_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.invalid.filter.bam" label="invalid.filter.bam" />
        <data name="same_circularised_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_circularised.filter.bam" label="same_circularised.filter.bam" />
        <data name="same_internal_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.same_internal.filter.bam" label="same_internal.filter.bam" />
        <data name="wrong_size_filter" format="bam" from_work_dir="hicup_filter_ditag_rejects/dataset.wrong_size.filter.bam" label="wrong_size.filter.bam"/>
        <data name="filter_piechart" format="svg" from_work_dir="*filter_piechart.svg" label="Filter piechart" />
    </outputs>
    <tests>
        <test>
            <param name="inputFiles" value="result.pair.bam" ftype="bam" />
            <param name="digest" value="digester_file.txt" ftype="txt" />
            <output name="hicup_filter_summary" file="hicup_filter_summary.txt" lines_diff="12"/>
            <output name="dataset_filt" file="dataset.filt.bam" lines_diff="8" />
            <output name="contiguous_filter" file="dataset.contiguous.filter.bam" lines_diff="8" />
            <output name="re_ligation_filter" file="dataset.re_ligation.filter.bam" lines_diff="8" />
            <output name="same_dangling_ends_filter" file="dataset.same_dangling_ends.filter.bam" lines_diff="8" />
            <output name="invalid_filter" file="dataset.invalid.filter.sam"  lines_diff="8" />
            <output name="same_circularised_filter" file="dataset.same_circularised.filter.bam" lines_diff="8" />
            <output name="same_internal_filter" file="dataset.same_internal.filter.bam" lines_diff="8" />
            <output name="filter_piechart" file="filter_piechart.svg" ftype="svg" lines_diff="1000" />
        </test>
    </tests>
    <help><![CDATA[

    For help please consult the documentation of HiCUP: http://www.bioinformatics.babraham.ac.uk/projects/hicup/overview/

    To get more information about the filter visit: http://www.bioinformatics.babraham.ac.uk/projects/hicup/scripts_description/#Filter
    ]]></help>
    <expand macro="citation_hicup" />
</tool>
