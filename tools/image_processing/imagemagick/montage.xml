<tool id="imagemagick_image_montage" name="Image Montage" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="23.1">
    <description>with ImageMagick</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="aggressive">
<![CDATA[

    #set $list_inputs = []
    #if $label_options.label=="true" and $label_options.label_indexes=="false" :
        #for $idx, $data in enumerate($images):
            #set $file=$data.input
            ln -s $file "${file.element_identifier}.${file.ext}" &&
            $list_inputs.append("%s.%s" % ($file.element_identifier, $file.ext))
        #end for
    #else: 
        #for $idx, $data in enumerate($images):
            #set $file=$data.input
            #set $prefix=str($idx+1)
            ln -s $file "${prefix}.${file.element_identifier}.${file.ext}" &&
            $list_inputs.append("%s.%s.%s" % ($prefix, $file.element_identifier, $file.ext))
        #end for
    #end if 

    fontfile=\$(fc-list | grep DejaVuSans.ttf | head -n 1 | cut -d: -f1) &&

    magick montage
        -geometry +0+0
        -background white
        -font \$fontfile
        -pointsize $pointsize
        -tile ${width}x
        -resize ${resize}% 
        #if $label_options.label ==  "true":
            -label "%t"
        #end if 
        #if $title:
            -title '$title'
        #end if 
        #for $i in $list_inputs:
             "$i" 
        #end for
        output.png
]]>
    </command>

    <inputs>
        <repeat name="images" title="Dataset">
            <param name="input" type="data" format="jpg,png,bmp,gif,svg,eps,tiff" label="Image"/>
        </repeat>
        <param name="width" type="integer" value="4" label="# of images wide"/>
        <param name="resize" type="integer" value="100" label="Resize the image (in percent of the original size)"/>
        <param name="title" type="text" optional="true" label="Add a Title to the image"/>
        
        <conditional name="label_options">
            <param name="label" type="select" label="Add the name of the files as image labels.">
                <option value="false" selected="true">No</option>
                <option value="true">Yes</option>
            </param>
            <when value="true">
                <param name="label_indexes" type="boolean" value="false" label="Add the dataset index to the label. (Necessary if you have duplicate names among the images)."/>
            </when>
            <when value="false" />
        </conditional>
        
        <param name="pointsize" type="integer" value="14" optional="true" label="Point size of the labels and/or title."/>
    </inputs>
    <outputs>
        <data format="png" name="output" from_work_dir="output.png" />
    </outputs>
    <tests>
        <test>
            <repeat name="images">
                <param name="input" value="donald.jpg" />
            </repeat>
            <repeat name="images">
                <param name="input" value="donald.jpg" />
            </repeat>
            <repeat name="images">
                <param name="input" value="Mirror Donald.png" />
            </repeat>
            <repeat name="images">
                <param name="input" value="Mirror Donald.png" />
            </repeat>
            <param name="width" value="3" />
            <output name="output" file="result_image_montage_1.png" compare="sim_size" />
        </test>
        <test>
            <repeat name="images">
                <param name="input" value="donald.jpg" />
            </repeat>
            <repeat name="images">
                <param name="input" value="Mirror Donald.png" />
            </repeat>
            <repeat name="images">
                <param name="input" value="donald.jpg" />
            </repeat>
            <repeat name="images">
                <param name="input" value="Mirror Donald.png" />
            </repeat>
            <param name="width" value="2" />
            <param name="resize" value="90" />
            <conditional name="label_options">
                <param name="label" value="true" />
                <param name="label_indexes" value="true" />
            </conditional>
            <param name="title" value="A bunch of Donalds" />
            <output name="output" file="result_image_montage_2.png" compare="sim_size" />
        </test>
        <test>
            <repeat name="images">
                <param name="input" value="donald.jpg" />
            </repeat>
            <repeat name="images">
                <param name="input" value="Mirror Donald.png" />
            </repeat>
            <param name="width" value="2" />
            <conditional name="label_options">
                <param name="label" value="true" />
                <param name="label_indexes" value="false" />
            </conditional>
            <param name="title" value="Donald Duo" />
            <output name="output" file="result_image_montage_3.png" compare="sim_size" />
        </test>
    </tests>
    <help>
<![CDATA[

**What it does**

Montage composites multiple images into a single, larger image. You may need to resize large images before you attempt to montage them.

The width parameter controls how many images wide the montage will be. With a width of 4, and 8 images selected, you will get 2 rows of 4 images. If you have 6 images selected, the first row will have 4 images, and the second will only have two.


]]>
    </help>
    <expand macro="citations" />
</tool>
