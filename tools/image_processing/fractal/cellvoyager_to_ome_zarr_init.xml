<tool id="fractal_cellvoyager_to_ome_zarr" name="CellVoyager image to OME-Zarr" version="1.4.3" profile="24.2">
    <description>Create OME-Zarr images from Cellvoyager images</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="aggressive">
    <![CDATA[
	mkdir -p tmp/input_images tmp/zarr_output && 

        #for $i, $filename in enumerate($input_images):
            ln -s '$filename' 'tmp/input_images/${filename.element_identifier}' &&
        #end for

        version=$(python3 --version | awk '{print tolower($1) substr($2, 1, 4)}') &&
        path=$(which python) &&
        base="${path%/*/*}" &&
	new_path="$base/lib/$version/site-packages/fractal_tasks_core/tasks/" &&
        echo "$new_path" &&

    
       cli_cmd="/cellvoyager_to_ome_zarr_init.py" && 
       init_execute="$new_path$cli_cmd" &&
       echo $init_execute &&
       
        
	python3 $init_execute && 

        python3 $__tool_directory__/cellvoyager_to_ome_zarr_init.py 
	    --image_dirs 'tmp/input_images'
	    --zarr_dir 'tmp/zarr_output' 
            --allowed_channels '${allowed_channels}' 
            --num_levels ${num_levels} 
            --coarsening_xy ${coarsening_xy} 
            --image_extension '${image_extension}' 
            --output_json '${output_json}' &&
    
        cp -r tmp/zarr_output/* $zarr_plate.extra_files_path
        ]]>
    </command>



    <inputs>
        <param name="input_images" type="data" multiple="true" format="@FORMATS@" label="Images" />
        <param name="allowed_channels" type="data" format="json" label="Allowed Channels in JSON format" />
        <param name="num_levels" type="integer" value="5" label="Number of pyramid levels" help="Number of resolution-pyramid levels. If set to 5, there will be the full-resolution level and 4 levels of downsampled images."/>
        <param name="coarsening_xy" type="integer" value="2" label="" help="Linear coarsening factor between subsequent levels. If set to `2`, level 1 is 2x downsampled, level 2 is 4x downsampled etc."/>
	    <param name="image_extension" type="text" value="tif" label="Image extension" help="Filename extension of images (e.g. tif or png)"/>
	    <param name="overwrite" type="boolean" value="false" label="Overwrite" help="If True, overwrite the output" />
      </inputs>
    <outputs>
        <data name="zarr_plate" format="zarr" label="Zarr Plate" />
        <data name="output_json" format="json" label="Parallelization list in JSON" />
    </outputs>
    <tests>
      <test>
        <param name="input_images" location="https://zenodo.org/records/8287221/files/20200812-CardiomyocyteDifferentiation14-Cycle1_B03_T0001F001L01A01Z01C01.png,https://zenodo.org/records/8287221/files/20200812-CardiomyocyteDifferentiation14-Cycle1_B03_T0001F001L01A01Z02C01.png,https://zenodo.org/records/8287221/files/20200812-CardiomyocyteDifferentiation14-Cycle1_B03_T0001F002L01A01Z01C01.png,https://zenodo.org/records/8287221/files/20200812-CardiomyocyteDifferentiation14-Cycle1_B03_T0001F002L01A01Z02C01.png,https://zenodo.org/records/8287221/files/MeasurementData.mlf,https://zenodo.org/records/8287221/files/MeasurementDetail.mrf" />
        <param name="allowed_channels" value="allowed_channels.json"/>
        <param name="num_levels" value="2"/>
        <param name="coarsening_xy" value="2"/>
	    <param name="image_extension" value="png"/>
	    <output name="zarr_plate" file="output.zarr" compare="" />
        <!-- <output name="output_json" file="parallelization_list.json" compare="sim_size" delta_frac="0.1"/> -->
         <!-- <output name="output_json">
            <assert_contents>
                <has_json_property_with_text property="zarr_url" text="tmp/zarr_output/20200812-CardiomyocyteDifferentiation14-Cycle1.zarr/B/03/0" />
            </assert_contents>
         </output> -->
        </test>
    </tests>
    <help>
        <![CDATA[
        **What it does**
         This tool convert the CellVoyager images into OME_Zarr.
        ]]>
    </help>
    <expand macro="citations" />
</tool>
