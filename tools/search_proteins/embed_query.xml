<tool id="search_protein_embed_query" name="Embed Query Sequences" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="25.0">
    <description>Convert protein sequences into embeddings using GLM2</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p results &&
        python /app/embed_query.py
            --query_sequences '$query_sequences'
            --output results
            #if $force_cpu:
                --force_cpu
            #end if
            -F
    ]]></command>
    <inputs>
        <param name="query_sequences" type="data" format="fasta" label="Query sequences (FASTA)" help="Input FASTA file with protein sequences to embed" />
        <param name="force_cpu" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Force CPU usage" help="Force CPU usage even if GPU is available. GPU acceleration takes ~1s/query vs 120s/query on CPU" />
    </inputs>
    <outputs>        
        <data name="query_embeddings_npy" format="npy" from_work_dir="results/intermediate_files/query_embeddings.npy" label="${tool.name} on ${on_string}: Embeddings (npy)" />
        <data name="query_embeddings_names" format="txt" from_work_dir="results/intermediate_files/query_embeddings.names.txt" label="${tool.name} on ${on_string}: Embedding names" />
    </outputs>
    
    <tests>
        <test expect_num_outputs="2">
            <param name="query_sequences" value="queries.fasta"/>
            <param name="force_cpu" value="true"/>
            <output name="query_embeddings_npy" ftype="npy">
                <assert_contents>
                    <has_size size="80" delta="10"/>
                </assert_contents>
            </output>
            <output name="query_embeddings_names" file="query_embeddings.names.txt"/>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

This tool converts protein sequences into embeddings using the GLM2 model. The embeddings are vector representations of proteins that can be used for fast similarity searching with FAISS.

This is the first step in a two-step protein search pipeline:

1. **Embed queries** - Convert protein sequences into embeddings
2. **Search database** - Find similar sequences using FAISS index and align with MMseqs2

**Input**

- **Query sequences**: A FASTA file containing protein sequences to be embedded

**Parameters**

- **Force CPU usage**: By default, CPU will be used. Disable this option to use GPU instead if available.

**Outputs**

- **query_embeddings.npy**: NumPy array containing the embeddings
- **query_embeddings.names.txt**: Text file with sequence names corresponding to embeddings

    ]]></help>
    <expand macro="citations"/>
    <expand macro="creator"/>
</tool>