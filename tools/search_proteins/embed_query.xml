<tool id="search_protein_embed_query" name="Embed Query Sequences" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="25.0">
    <description>Convert protein sequences into embeddings using GLM2</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p results &&
        python embed_query.py
            --query_sequences '$query_sequences'
            --output results
            #if $force_cpu:
                --force_cpu
            #end if
    ]]></command>
    
    <inputs>
        <param name="query_sequences" type="data" format="fasta" label="Query sequences (FASTA)" help="Input FASTA file with protein sequences to embed" />
        <param name="force_cpu" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Force CPU usage" help="Force CPU usage even if GPU is available. GPU acceleration takes ~1s/query vs 120s/query on CPU" />
    </inputs>
    <outputs>        
        <data name="query_embeddings_npy" format="npy" from_work_dir="results/intermediate_files/query_embeddings.npy" label="${tool.name} on ${on_string}: Embeddings (npy)" />
        <data name="query_embeddings_names" format="txt" from_work_dir="results/intermediate_files/query_embeddings.names.txt" label="${tool.name} on ${on_string}: Embedding names" />
    </outputs>
    
    <tests>
        <test>
            <!-- TODO -->
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

This tool converts protein sequences into embeddings using the GLM2 model. The embeddings are vector representations 
of proteins that can be used for fast similarity searching with FAISS.

This is the first step in a two-step protein search pipeline:

1. **Embed queries** (this tool) - Convert protein sequences into embeddings
2. **Search database** - Find similar sequences using FAISS index and align with MMseqs2

**Input**

- **Query sequences**: A FASTA file containing protein sequences to be embedded

**Parameters**

- **Force CPU usage**: By default, GPU will be used if available. Enable this option to force CPU usage.
  Note: GPU acceleration is much faster (~1s per query vs 120s per query on CPU)

**Outputs**

- **query_embeddings.npy**: NumPy array containing the embeddings
- **query_embeddings.names.txt**: Text file with sequence names corresponding to embeddings

**Next Steps**

Use the output embeddings with the "Search Database" tool to find similar sequences in a pre-built FAISS database.

    ]]></help>
    <expand macro="citations"/>
</tool>