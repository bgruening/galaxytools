<tool id="cleaverna" name="CleaveRNA" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>scoring candidate cleavage sites of DNAzyme</description>
    <creator>
        <person givenName="Reyhaneh" familyName="Tavakoli Koopaei" email="rey.ta.kop.biochem@gmail.com"/>
        <person givenName="Björn" familyName="Gruening" email="bjoern.gruening@gmail.com"/>
        <person givenName="Martin" familyName="Raden" email="martin.raden@uni-tuebingen.de"/>
    </creator>
    <macros>
        <import>macros.xml</import>
        <expand macro="requirements"/>
    </macros>
    <expand macro="requirements"/>
    <required_files>
        <include path="data/HPV.fasta"/>
        <include path="data/BCL-1.fasta"/>
        <include path="data/BCL-2.fasta"/>
        <include path="data/BCL-3.fasta"/>
        <include path="data/BCL-4.fasta"/>
        <include path="data/BCL-5.fasta"/>
        <include path="data/1.fasta"/>
        <include path="data/2.fasta"/>
        <include path="data/3.fasta"/>
        <include path="data/4.fasta"/>
        <include path="data/5.fasta"/>
        <include path="data/6.fasta"/>
        <include path="data/7.fasta"/>
        <include path="data/8.fasta"/>
        <include path="data/9.fasta"/>
        <include path="data/10.fasta"/>
        <include path="data/11.fasta"/>
        <include path="data/12.fasta"/>
        <include path="data/13.fasta"/>
        <include path="data/14.fasta"/>
        <include path="data/15.fasta"/>
        <include path="data/16.fasta"/>
        <include path="data/17.fasta"/>
        <include path="data/18.fasta"/>
        <include path="data/19.fasta"/>
        <include path="data/20.fasta"/>
        <include path="data/template.fasta"/>
        <include path="data/HPBC_user_merged_num.csv"/>
        <include path="data/HPBC_training_scores.csv"/>
        <include path="data/SARS_user_merged_num.csv"/>
        <include path="data/SARS_training_scores.csv"/>
        <include path="data/training_param.csv"/>
        <include path="data/selected_region_param.csv"/>
        <include path="data/specific_cleavage_sites_param.csv"/>
        <include path="data/specific_DNAzyme_param.csv"/>
        <include path="data/training_scores.csv"/>
    </required_files>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p outputs &&
        #if $mode_selection.mode == "training":
            #if $mode_selection.training_source.training_type == "HPBC":
                echo "LA,RA,CS,Tem,CA" > HPBC_default_params.csv && \
                echo "9,9,\"AU,GU,AC,GC\",37,GGCUAGCUACAACGA" >> HPBC_default_params.csv && \
                cleaverna \
                --model_name "${mode_selection.training_source.model_name}" \
                --target_files_training '${__tool_directory__}/data/HPV.fasta' '${__tool_directory__}/data/BCL-1.fasta' '${__tool_directory__}/data/BCL-2.fasta' '${__tool_directory__}/data/BCL-3.fasta' '${__tool_directory__}/data/BCL-4.fasta' '${__tool_directory__}/data/BCL-5.fasta' \
                --params HPBC_default_params.csv \
                --prediction_mode default \
                --output_dir outputs && \
                cp HPBC_default_params.csv outputs/HPBC_default_params.csv
            #elif $mode_selection.training_source.training_type == "SARS":
                echo "LA,RA,CS,Tem,CA" > SARS_default_params.csv && \
                echo "16,8,\"AU,GU\",23,GGCUAGCUACAACGA" >> SARS_default_params.csv && \
                cleaverna \
                --model_name "${mode_selection.training_source.model_name}" \
                --target_files_training '${__tool_directory__}/data/1.fasta' '${__tool_directory__}/data/2.fasta' '${__tool_directory__}/data/3.fasta' '${__tool_directory__}/data/4.fasta' '${__tool_directory__}/data/5.fasta' '${__tool_directory__}/data/6.fasta' '${__tool_directory__}/data/7.fasta' '${__tool_directory__}/data/8.fasta' '${__tool_directory__}/data/9.fasta' '${__tool_directory__}/data/10.fasta' '${__tool_directory__}/data/11.fasta' '${__tool_directory__}/data/12.fasta' '${__tool_directory__}/data/13.fasta' '${__tool_directory__}/data/14.fasta' '${__tool_directory__}/data/15.fasta' '${__tool_directory__}/data/16.fasta' '${__tool_directory__}/data/17.fasta' '${__tool_directory__}/data/18.fasta' '${__tool_directory__}/data/19.fasta' '${__tool_directory__}/data/20.fasta' \
                --params SARS_default_params.csv \
                --prediction_mode default \
                --output_dir outputs && \
                cp SARS_default_params.csv outputs/SARS_default_params.csv
            #else:
                #if $mode_selection.training_source.advanced_dnazyme_params.param_source.param_mode == "manual":
                    echo "LA,RA,CS,Tem,CA" > temp_params.csv &&
                    #set $cs_list = ','.join($mode_selection.training_source.advanced_dnazyme_params.param_source.CS)
                    echo "${mode_selection.training_source.advanced_dnazyme_params.param_source.LA},${mode_selection.training_source.advanced_dnazyme_params.param_source.RA},\"${cs_list}\",${mode_selection.training_source.advanced_dnazyme_params.param_source.Tem},${mode_selection.training_source.advanced_dnazyme_params.param_source.CA}" >> temp_params.csv &&
                #end if
                cleaverna \
                --model_name "${mode_selection.training_source.model_name}" \
                --target_files_training '$mode_selection.training_source.training_target_files' \
                #if $mode_selection.training_source.advanced_dnazyme_params.param_source.param_mode == "manual":
                    --params temp_params.csv \
                #else:
                    --params '$mode_selection.training_source.advanced_dnazyme_params.param_source.params_file' \
                #end if
                --prediction_mode default \
                --output_dir outputs && \
                            cp temp_params.csv outputs/temp_params.csv
            #end if
        #end if
        #if $mode_selection.mode == "prediction":
            ## Create parameters file based on feature generation mode
            #if $mode_selection.prediction_mode.pred_mode == "target_check":
                #if $mode_selection.prediction_mode.param_source_conditional.param_mode == "manual":
                    ## Generate custom parameter file from user-defined rows
                    echo "Row_Name,LA,RA,CS,Start_End_Index,Tem,CA" > prediction_params.csv &&
                    #for $row in $mode_selection.prediction_mode.param_source_conditional.rows:
                        #set $cs_list = ','.join($row.CS)
                        #set $start_end_index = $row.target_sequence_name + ":" + str($row.start_index) + "-" + str($row.end_index)
                        echo "${row.row_name},${row.LA},${row.RA},\"${cs_list}\",${start_end_index},${row.Tem},${row.CA}" >> prediction_params.csv &&
                    #end for
                #else:
                    ## User uploaded parameter file for target check mode
                    cp '$mode_selection.prediction_mode.param_source_conditional.params_file' prediction_params.csv &&
                #end if
            #elif $mode_selection.prediction_mode.pred_mode == "target_screen":
                ## Target screen mode - check if using row-based configuration or uploaded file
                #if $mode_selection.prediction_mode.param_source_conditional.param_mode == "manual":
                    echo "Row_Name,LA,RA,CS,CS_Index,Tem,CA" > prediction_params.csv &&
                    #for $row in $mode_selection.prediction_mode.param_source_conditional.rows:
                        #set $cs_list = ','.join($row.CS)
                        echo "${row.row_name},${row.LA},${row.RA},\"${cs_list}\",${row.CS_Index},${row.Tem},${row.CA}" >> prediction_params.csv &&
                    #end for
                #else:
                    ## User uploaded parameter file for target screen mode
                    cp '$mode_selection.prediction_mode.param_source_conditional.params_file' prediction_params.csv &&
                #end if
            #elif $mode_selection.prediction_mode.pred_mode == "specific_query":
                ## Specific query mode - handle DNAzyme sequences and cleavage site information
                #if $mode_selection.prediction_mode.param_source_conditional.param_mode == "manual":
                    echo "DNAzyme_Name,LA_seq,RA_seq,CS,CS_Index_query,Tem,CA" > prediction_params.csv &&
                    #for $row in $mode_selection.prediction_mode.param_source_conditional.rows:
                        #set $cs_list = ','.join($row.CS)
                        echo "${row.row_name},${row.LA_seq},${row.RA_seq},\"${cs_list}\",${row.CS_Index_query},${row.Tem},${row.CA}" >> prediction_params.csv &&
                    #end for
                #else:
                    ## User uploaded parameter file for specific query mode
                    cp '$mode_selection.prediction_mode.param_source_conditional.params_file' prediction_params.csv &&
                #end if
            #else:
                ## Default and other modes - use standard parameter configuration
                #if $mode_selection.prediction_mode.param_source_conditional.param_mode == "manual":
                    #set $cs_list = ','.join($mode_selection.prediction_mode.param_source_conditional.CS)
                    echo "LA,RA,CS,Tem,CA" > prediction_params.csv &&
                    echo "${mode_selection.prediction_mode.param_source_conditional.LA},${mode_selection.prediction_mode.param_source_conditional.RA},\"${cs_list}\",${mode_selection.prediction_mode.param_source_conditional.Tem},${mode_selection.prediction_mode.param_source_conditional.CA}" >> prediction_params.csv &&
                #else:
                    cp '$mode_selection.prediction_mode.param_source_conditional.params_file' prediction_params.csv &&
                #end if
            #end if
            cleaverna \
            --model_name "${mode_selection.model_name}" \
            --target_files_prediction '$mode_selection.target_files' \
            --prediction_mode <expand macro=prediction_prediction_mode> \
            --params prediction_params.csv \
            ## Training configuration for prediction mode
            #if $mode_selection.training_source.training_type_conditional.training_type == "HPV_BCl_dataset":
                --training_file '${__tool_directory__}/data/HPBC_user_merged_num.csv' \
                --training_scores '${__tool_directory__}/data/HPBC_training_scores.csv' \
            #elif $mode_selection.training_source.training_type_conditional.training_type == "SARS_CoV_2_dataset":
                --training_file '${__tool_directory__}/data/SARS_user_merged_num.csv' \
                --training_scores '${__tool_directory__}/data/SARS_training_scores.csv' \
            #elif $mode_selection.training_source.training_type_conditional.training_type == "custom_upload":
                --training_file '$mode_selection.training_source.training_file' \
                --training_scores '$mode_selection.training_source.training_scores' \
            #end if
            --output_dir outputs
        #end if
    ]]></command>
    <inputs>
        <conditional name="mode_selection">
            <param name="mode" type="select" display="radio" label="Analysis Mode">
                <option value="training">Training Mode (For New Datasets)</option>
                <option value="prediction" selected="true">Prediction Mode</option>
            </param>
            <!-- ================= TRAINING MODE ================= -->
            <when value="training">
                <conditional name="training_source">
                    <param name="training_type" type="select" label="Training Dataset">
                        <option value="HPBC_default">HPBC bundled model</option>
                        <option value="SARS_default">SARS bundled model</option>
                        <option value="custom_upload">Custom files (advanced)</option>
                    </param>
                    <when value="HPBC_default">
                        <expand macro="model_name_param" label="Uses bundled HPBC FASTA and fixed parameters: LA=9, RA=9, CS=AU,GU,AC,GC, Temp=37°C"/>
                    </when>
                    <when value="SARS_default">
                        <expand macro="model_name_param" label="Uses bundled SARS FASTA and fixed parameters: LA=16, RA=8, CS=AU,GU, Temp=23°C"/>
                    </when>
                    <when value="custom_upload">
                        <section name="training_fasta_files" title="Training FASTA Files" expanded="true">
                            <expand macro="fasta_training"/>
                        </section>
                        <section name="advanced_dnazyme_params" title="DNAzyme Parameters" expanded="false">
                            <expand macro="param_source_conditional"/>
                        </section>
                        <expand macro="model_name_param"/>
                    </when>
                </conditional>
            </when>
            <!-- ================= PREDICTION MODE ================= -->
            <when value="prediction">
                <!-- Target FASTA files -->
                <section name=" RNA_substrate_fasta_files" title="RNA Substrate FASTA Files" expanded="true">
                    <expand macro="fasta_targets"/>
                </section>
                <!-- Prediction Mode Selection -->
                <conditional name="prediction_mode">
                    <param name="pred_mode" type="select" label="Prediction Mode">
                        <option value="default" selected="true">All Cleavage Sites</option>
                        <option value="target_check">Selected Region Cleavage Sites</option>
                        <option value="target_screen">Specific Cleavage Sites</option>
                        <option value="specific_query">Specific DNAzymes</option>
                    </param>
                    <!-- DEFAULT MODE -->
                    <when value="default">
                        <section name="default_dnazyme_params" title="DNAzyme Parameters" expanded="true">
                            <expand macro="param_source_conditional"/>
                        </section>
                    </when>
                    <!-- TARGET CHECK MODE -->
                    <when value="target_check">
                        <!-- DNAzyme parameter source selection -->
                        <section name="target_check_dnazyme_params" title="DNAzyme Parameters" expanded="true">
                            <conditional name="param_source_conditional">
                                <param name="param_mode" type="select" label="Parameter Source">
                                    <option value="manual" selected="true">Manual parameters</option>
                                    <option value="file">Upload CSV file</option>
                                </param>
                                <!-- Manual input: repeat rows for each target region -->
                                <when value="manual">
                                    <repeat name="rows" title="Target Region Rows" min="1">
                                        <expand macro="dnazyme_basic_params"/>
                                        <param name="target_sequence_name" type="text" label="Target FASTA Name"/>
                                        <param name="start_index" type="integer" label="Start Nucleotide"/>
                                        <param name="end_index" type="integer" label="End Nucleotide"/>
                                    </repeat>
                                </when>
                                <!-- File input: upload parameter CSV -->
                                <when value="file">
                                    <param name="params_file" type="data" format="csv" label="Upload Parameter File (CSV)" help="Download the template &lt;a href='data/selected_region_param.csv' target='_blank'&gt;here&lt;/a&gt;. Edit it with your own parameters and upload it above."/>
                                </when>
                            </conditional>
                        </section>
                    </when>
                    <!-- TARGET SCREEN MODE -->
                    <!-- TARGET SCREEN MODE -->
                    <when value="target_screen">
                        <!-- DNAzyme parameter source selection -->
                        <section name="target_screen_dnazyme_params" title="DNAzyme Parameters" expanded="true">
                            <conditional name="param_source_conditional">
                                <param name="param_mode" type="select" label="Parameter Source">
                                    <option value="manual" selected="true">Manual parameters</option>
                                    <option value="file">Upload CSV file</option>
                                </param>
                                <!-- Manual input: repeat rows for each cleavage site -->
                                <when value="manual">
                                    <repeat name="rows" title="Cleavage Site Rows" min="1">
                                        <expand macro="dnazyme_basic_params"/>
                                        <param name="CS_Index" type="text" label="CS Index (file:start-end)" help="Example for BCl.fasta is: BCl.fasta:17-18"/>
                                    </repeat>
                                </when>
                                <!-- File input: upload parameter CSV -->
                                <when value="file">
                                    <param name="params_file" type="data" format="csv" label="Upload Parameter File (CSV)" help="Download the template &lt;a href='data/selected_region_param.csv' target='_blank'&gt;here&lt;/a&gt;. Edit it with your own parameters and upload it above."/>
                                </when>
                            </conditional>
                        </section>
                    </when>
                    <!-- SPECIFIC QUERY MODE -->
                    <when value="specific_query">
                        <!-- DNAzyme parameter source selection -->
                        <section name="specific_query_dnazyme_params" title="DNAzyme Parameters" expanded="true">
                            <conditional name="param_source_conditional">
                                <param name="param_mode" type="select" label="Parameter source">
                                    <option value="manual" selected="true">Manual parameters</option>
                                    <option value="file">Upload CSV file</option>
                                </param>
                                <!-- Manual input: repeat rows for each DNAzyme -->
                                <when value="manual">
                                    <repeat name="rows" title="DNAzyme Rows" min="1">
                                        <param name="LA_seq" type="text" label="Left Arm Sequence (LA_seq)"/>
                                        <param name="RA_seq" type="text" label="Right Arm Sequence (RA_seq)"/>
                                        <expand macro="cleavage_sites_param"/>
                                        <param name="CS_Index_query" type="text" label="CS Index on Substrate" help="Input the FASTA source and CS nucleotide index as filename:position (e.g., HPV.fasta:24-25)"/>
                                        <param name="Tem" type="integer" value="37" label="Temperature (°C)"/>
                                        <param name="CA" type="text" value="GGCUAGCUACAACGA" label="Catalytic Core (CA)"/>
                                    </repeat>
                                </when>
                                <!-- File input: upload parameter CSV -->
                                <when value="file">
                                    <param name="params_file" type="data" format="csv" label="Upload Parameter File (CSV)" help="Download the template &lt;a href='data/specific_DNAzyme_param.csv' target='_blank'&gt;here&lt;/a&gt;. Edit it with your own parameters and upload it above."/>
                                </when>
                            </conditional>
                        </section>
                    </when>
                </conditional>
                <!-- Training Configuration for Prediction -->
                <!-- Training Configuration for Prediction -->
                <section name="training_source" title="Training data source" expanded="true">
                    <conditional name="training_type_conditional">
                        <param name="training_type" type="select" label="Select training dataset">
                            <option value="HPV_BCl_dataset">HPV_BCl dataset</option>
                            <option value="SARS_CoV_2_dataset">SARS_CoV_2 dataset</option>
                            <option value="custom_upload">Custom upload dataset</option>
                        </param>
                        <when value="HPV_BCl_dataset"/>
                        <when value="SARS_CoV_2_dataset"/>
                        <when value="custom_upload">
                            <param name="training_file" type="data" format="csv" label="Training Features (CSV)" help="Run training mode first, then upload the resulting output file here."/>
                            <param name="training_scores" type="data" format="csv" label="Training Scores (CSV)" help="Download the template &lt;a href='data/training_scores.csv' target='_blank'&gt;here&lt;/a&gt;. Edit it with your own parameters and upload it above."/>
                        </when>
                    </conditional>
                </section>
                <!-- Model Name (only once) -->
                <expand macro="model_name_param"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <!-- ================= TRAINING MODE ================= -->
        <data name="user_merged_features" format="csv" from_work_dir="outputs/${mode_selection.training_source.model_name}_user_merged_num.csv" label="Training features File">
            <filter>mode_selection['mode'] == 'training'</filter>
        </data>
        <!-- HPBC default parameters (when training with HPBC dataset) -->
        <data name="hpbc_params" format="csv" from_work_dir="outputs/HPBC_default_params.csv" label="${tool.name} on ${on_string}: HPBC Default Parameters">
            <filter>mode_selection['mode'] == 'training' and mode_selection['training_source']['training_type'] == 'HPBC'</filter>
        </data>
        <data name="parameters_config_train" format="txt" from_work_dir="outputs/parameters.cfg" label="Training parameters file">
            <filter>mode_selection['mode'] == 'training'</filter>
        </data>
        <!-- ================= PREDICTION MODE ================= -->
        <data name="ml_metrics" format="csv" from_work_dir="outputs/${mode_selection.model_name}_ML_metrics.csv" label="ML Metrics">
            <filter>mode_selection['mode'] == 'prediction'</filter>
        </data>
        <data name="ml_train" format="csv" from_work_dir="outputs/${mode_selection.model_name}_ML_train.csv" label="ML Train">
            <filter>mode_selection['mode'] == 'prediction'</filter>
        </data>
        <data name="ml_train_feature_set" format="csv" from_work_dir="outputs/${mode_selection.model_name}_ML_train_feature_set.csv" label="ML Train Feature Set">
            <filter>mode_selection['mode'] == 'prediction'</filter>
        </data>
        <data name="balanced_classification" format="csv" from_work_dir="outputs/${mode_selection.model_name}_balanced_classification.csv" label="Balanced Classification">
            <filter>mode_selection['mode'] == 'prediction'</filter>
        </data>
        <data name="cleavage_predictions" format="csv" from_work_dir="outputs/${mode_selection.model_name}_CleaveRNA_output.csv" label="Cleavage predictions">
            <filter>mode_selection['mode'] == 'prediction'</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="mode_selection|mode" value="training"/>
            <param name="mode_selection|training_source|training_type" value="HPBC_default"/>
            <param name="mode_selection|training_source|model_name" value="test"/>
            <output name="user_merged_features">
                <assert_contents>
                    <has_text text="AC"/>
                </assert_contents>
            </output>
            <output name="parameters_config_train">
                <assert_contents>
                    <has_text text="temperature"/>
                </assert_contents>
            </output>
            <output name="hpbc_params">
                <assert_contents>
                    <has_text text="LA,RA,CS,Tem,CA"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
        This tool performs DNAzyme cleavage site prediction on RNA sequences using machine learning models. It supports both training and prediction modes with customizable parameters for DNAzyme design and target sequence analysis.

        **Training Mode:**
        - Input RNA sequences in FASTA format.
        - Generate training feature matrices based on specified DNAzyme parameters.
        - Output training features for model development.

        **Prediction Mode:**
        - Input RNA sequences in FASTA format.
        - Choose from multiple analysis modes: Default, Target Check, Target Screen, and Specific Query.
        - Customize DNAzyme parameters or upload parameter files for feature generation.
        - Output cleavage site predictions along with machine learning metrics.

        For detailed instructions and parameter descriptions, please refer to the tool documentation.
    </help>
    <expand macro="citations"/>
</tool>
