<tool id="locarna_pairwise_p" name="LocARNA Pairwise Probability Aligner" version="@VERSION@.0">
    <description>
        Partition Function and Probabilities from Pairwise Simultaneous Alignment and Folding of RNAs (LocARNA-P)
    </description>

    <macros>
        <import>macros.xml</import>
    </macros>
    
    <expand macro="requirements" />

    <expand macro="stdio" />
    
    <expand macro="version" />
   
    <command><![CDATA[
    locarna_p
    
    '$inputA'
    '$inputB'
    
    --width 60
    
    ## -------------------- scoring parameters
    
    --indel $Scoring.indel
    --indel-opening $Scoring.indel_opening
    --struct-weight $Scoring.struct_weight
    --tau $Scoring.tau
    
    #if str($Scoring.sequence_score.sequence_score_selector) == "match"
        --match $Scoring.sequence_score.match
        --mismatch $Scoring.sequence_score.mismatch
    #else if str($Scoring.sequence_score.sequence_score_selector) == "ribosum"
        --use-ribosum true
    #else if str($Scoring.sequence_score.sequence_score_selector) == "ribofit"
        --ribofit true
    #end if

    ## -------------------- folding parameters

    #if float($Folding.rnafold_temperature) != 37.0
        --rnafold-temperature $Folding.rnafold_temperature
    #end if

    ## -------------------- heuristic parameters
    -p $Heuristics.min_prob
    
    #if str($Heuristics.max_diff_mode.max_diff_mode_selector) == "off"
        --max-diff -1
    #elif str($Heuristics.max_diff_mode.max_diff_mode_selector) == "max-diff"
        --max-diff $Heuristics.max_diff_mode.max_diff
    #elif str($Heuristics.max_diff_mode.max_diff_mode_selector) == "max-diff-at-am"
        --max-diff -1
        --max-diff-at-am $Heuristics.max_diff_mode.max_diff_at_am
    #elif str($Heuristics.max_diff_mode.max_diff_mode_selector) == "max-diff-aln"
        --max-diff $Heuristics.max_diff_mode.max_diff
        --max-diff-aln '$Heuristics.max_diff_mode.max_diff_aln'
        $Heuristics.max_diff_mode.max_diff_relax
    #end if
    
    --max-diff-am $Heuristics.max_diff_am

    #if float($Heuristics.max_bps_length_ratio) != 0.0
        --max-bps-length-ratio $Heuristics.max_bps_length_ratio
    #end if

    #if float($Heuristics.pf_scale) != 1.0
       --pf-scale $Heuristics.pf_scale
    #end if

    ## -------------------- other parameters
        
    #if $Constraints.maxBPspan != -1
        --maxBPspan $Constraints.maxBPspan
    #end if

    $Constraints.ignore_constraints

    ## -------------------- probability parameters
    $Probabilities.include_am_in_bm
    #if float($Probabilities.min_bm_prob) != 0.0005
       --min-bm-prob $Probabilities.min_bm_prob
    #end if
    #if float($Probabilities.min_am_prob) != 0.0005
       --min-am-prob $Probabilities.min_am_prob
    #end if

    ## -------------------- output

    #if not $arc_match_probs is None
        --write-arcmatch-probs=$arc_match_probs
    #end if
    
    #if not $base_match_probs is None
        --write-basematch-probs=$base_match_probs
    #end if
    
    $stdout_verbosity

    #if str($stdout_verbosity) != "--quiet":
        > '$stdout'
    #end if

    ]]></command>

    <inputs>
        <param name="inputA" type="data" format="fasta,clustal,txt" label="Sequence A"
               help="First sequence in fasta, clustal, dp_ps, or PP2.0 format"
               />
        <param name="inputB" type="data" format="fasta,clustal,txt" label="Sequence B"
               help="Second sequence in fasta, clustal, dp_ps, or PP2.0 format"
               />
        
        <param name="outputs" type="select" display="checkboxes" multiple="True" 
               label="Output options">
            <option value="base_match_probs" selected="True">
            Output base match probabilities</option>
            <option value="arc_match_probs" selected="True">
            Output arc match probabilities</option> 
       </param>
        
        <param name="stdout_verbosity" type="select" label="Standard output verbosity">
            <option value="--quiet">Don't report standard
            output</option>
            <option value="">Non verbose</option>
            <option value="--verbose">Verbose</option>
        </param>
               
        <section name="Probabilities" title="Probability parameters">
            <param name="include_am_in_bm" argument="include-am-in-bm"
                   type="boolean"
                   truevalue="--include-am-in-bm" falsevalue=""
                   label="Include arc match cases in computation of base match probabilities" />
            <param name="min_bm_prob" argument="min-bm-prob" 
                   type="float"
                   value="0.0005" min="0.0" max="1.0"
                   label="Minimal base match probability"
                   />
            <param name="min_am_prob" argument="min-am-prob" 
                   type="float"
                   value="0.0005" min="0.0" max="1.0"
                   label="Minimal arc match probability"
                   />                  
        </section>

        <section name="Scoring" title="Scoring parameters">
            <expand macro="common_scoring_parameters" />
        </section>
        
        <section name="Folding" title="RNA folding parameters">
            <expand macro="common_folding_parameters" />
            <expand macro="alifold_consensus_parameter" />
            <param name="consensus_structure" type="select" label="Consensus structure type"
                   help="Type of consensus structures written to screen and stockholm output"
                   >
                <!-- <option value="mea">mea</option>-->
                <option value="none">none</option>
                <option value="alifold">alifold</option>
            </param>
        </section>

        <section name="Heuristics" title="Heuristic parameters">
            <expand macro="common_heuristic_parameters" />
            <expand macro="max_diff_parameters" />
            <param name="pf_scale" argument="pf-scale"
                   type="float" value="1.0"
                   label="Scaling of the partition function."
                   help="Use (only) if standard scaling overflows." />
        </section>

        <section name="Constraints" title="Constraint parameters">
            <expand macro="common_constraint_parameters" />
        </section>

    </inputs>
    
    <outputs>
        <data format="txt" name="stdout" label="${tool.name} std out on ${on_string}">
            <filter>stdout_verbosity != '--quiet'</filter>
        </data>
        <data format="table" name="base_match_probs" label="${tool.name} base match probabilties on ${on_string}">
            <filter>'base_match_probs' in outputs</filter>
        </data>
        <data format="table" name="arc_match_probs" label="${tool.name} arc match probabilties on ${on_string}">
            <filter>'arc_match_probs' in outputs</filter>
        </data>
    </outputs>
    
    <tests>
        <test>
            <param name="inputA" value="tRNA_2-1.fa" />
            <param name="inputB" value="tRNA_2-2.fa" />
            <param name="outputs" value="arc_match_probs,base_match_probs"/>
            <param name="min_bm_prob" value="0.01" />
            <param name="min_am_prob" value="0.01" />
            <output name="base_match_probs" file="tRNA_2.bmprobs" />
            <output name="arc_match_probs" file="tRNA_2.amprobs" />
        </test>
    </tests>

    <help><![CDATA[ **LocARNA -- Pairwise probability alignment of RNAs**

Pairwise probability alignment tool of the LocARNA suite. This tool
computes base and arc match probabilities from simultaneous RNA
folding and alignment. It can be adapted to specific needs by a broad
range of parameters:

* *scoring* of the alignment, e.g. influencing the cost of
  insertions/deletions and the weight of sequence vs. structure
  similarity.

* *RNA folding*, which control the secondary RNA structure prediciton.

* *heuristics*, which trade alignment accuracy vs. computation
  speed. The huge complexity of simultaneous alignment and folding
  generally requires some heuristics for reasonable computation times.
  Some alignment instances and alignment modes will require relaxation
  of the default heuristics; in particular, local, constrained, and free end gap
  alignment, will often require turning off the "maximal difference for
  alignment traces" heuristic.
  
* *constraints*, which can be applied to include prior knowledge to
  improve the quality of results and/or speed of computation.

**Input.**

Input consists of two sequences or alignments, which are specified in
fasta, clustal, stockholm, or LocARNA pp format.

Optionally, one can specify structure and anchor constraints in these
input files.

**Output.**

The tool writes two tables of base match and arc match probabilities, respectively. Rows
in the base match probabilities table consist of

  i j p

where p is the probability of matching position i in the first sequence to position j in the second sequence. 

For arc matchs, the table contains rows

  i j k l p

where p is the probability of matching the base pair (i,j) of sequence one to (k,l) of sequence two.

Moreover, the partition function and further information can be written to standard out.

For more information, see     
.. __: http://www.bioinf.uni-freiburg.de/Software/LocARNA/
    ]]></help>

    <expand macro="citations" />
    
</tool>
