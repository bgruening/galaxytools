<tool id="rbpbench_enmo_nemo" name="RBPBench Enrichment" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@profile@">

    <description>and co-occurrence analysis on single motif or neighboring regions</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_REF@
        rbpbench $action_type.action_type_selector
            --in '$action_type.input_bed'
            --out ./
            --gtf '$action_type.gtf_file'
            --genome reference.fa
            #if $action_type.action_type_selector == 'nemo':
                $action_type.allow_overlaps
            #end if
            @RBP_LIST@
            @USER_RBP@
            @SORT_JS@
            @PLOTLY_JS@
            @COMMON_PARAMS@
    ]]>    </command>

    <inputs>
        <conditional name="action_type">
            <param name="action_type_selector" type="select" label="Select RBPBench program mode">
                <option value="enmo" selected="true">Enrichment and co-occurrence statistics on single motif level (enmo)</option>
                <option value="nemo">Motif enrichment analysis on neighboring regions (nemo)</option>
            </param>
            <when value="enmo">
                <param name="input_bed" type="data" format="bed" label="Input BED file" help="Regions or motif sites in BED format" />
                <param name="gtf_file" type="data" format="gtf" label="GTF file" help="Annotation file for background generation"/>
                <expand macro="select_rbp_db"/>
                <expand macro="user_rbp"/>
                <expand macro="reference_genome"/>
                <expand macro="search_options"/>
                <section name="output_options" title="Output options">
                    <param name="motif_enrich_table" type="boolean" checked="False" label="Output motif enrichment statistics table"/>
                    <param name="motif_cooc_table" type="boolean" checked="False" label="Output motif co-occurence statistics table"/>
                    <param name="sites_bed_fasta_out" type="boolean" checked="False" label="Output genomic regions BED + FASTA files" help="Output genomic regions BED/FASTA file used for plotting"/>
                </section>
                <section name="advanced_html_output_options" title="Advanced HTML report options">
                    <expand macro="advanced_html_output_options_sort_js"/>
                    <expand macro="advanced_html_output_options_plotly_js"/>
                </section>
            </when>
            <when value="nemo">

                <param name="input_bed" type="data" format="bed" label="Input BED file" help="Regions or motif sites in BED format" />
                <param name="gtf_file" type="data" format="gtf" label="GTF file" help="Annotation file for background generation"/>
                <expand macro="select_rbp_db"/>
                <expand macro="user_rbp"/>
                <expand macro="reference_genome"/>
                <param name="allow_overlaps" type="boolean" truevalue="--allow-overlaps" falsevalue="" checked="False" label="Allow overlaps" help="Allow overlaps of motif hit regions with provided inputsites. By default, motif hits overlapping with input sites are filtered out"/>
                <expand macro="search_options"/>
                <section name="output_options" title="Output options">
                    <param name="motif_enrich_table" type="boolean" checked="False" label="Output motif enrichment statistics table"/>
                    <param name="motif_cooc_table" type="boolean" checked="False" label="Output motif co-occurence statistics table"/>
                    <param name="sites_bed_fasta_out" type="boolean" checked="False" label="Output genomic regions BED + FASTA files" help="Output genomic regions BED/FASTA file used for plotting"/>
                </section>
                <section name="advanced_html_output_options" title="Advanced HTML report options">
                    <expand macro="advanced_html_output_options_sort_js"/>
                    <expand macro="advanced_html_output_options_plotly_js"/>
                </section>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="enmo_report_html" format="html" from_work_dir="report.rbpbench_enmo.html" label="${tool.name} on ${on_string}: Enmo report HTML">
            <filter>action_type["action_type_selector"] == "enmo"</filter>
        </data>
        <data name="nemo_report_html" format="html" from_work_dir="report.rbpbench_nemo.html" label="${tool.name} on ${on_string}: Nemo report HTML">
            <filter>action_type["action_type_selector"] == "nemo"</filter>
        </data>
        <data name="motif_enrichment_stats" format="tabular" from_work_dir="motif_enrichment_stats.tsv" label="${tool.name} on ${on_string}: Motif enrichment statistics table">
            <filter>action_type["output_options"]["motif_enrich_table"]</filter>
        </data>
        <data name="motif_cooc_stats" format="tabular" from_work_dir="motif_cooc_stats.tsv" label="${tool.name} on ${on_string}: Motif co-occurence statistics table">
            <filter>action_type["output_options"]["motif_cooc_table"]</filter>
        </data>
        <data name="plot_sites_bed_file" format="bed" from_work_dir="in_sites.filtered.bed" label="${tool.name} on ${on_string}: Genomic regions used for plotting BED">
            <filter>action_type["output_options"]["sites_bed_fasta_out"]</filter>
        </data>
        <data name="plot_sites_fa_file" format="fasta" from_work_dir="in_sites.filtered.fa" label="${tool.name} on ${on_string}: Genomic regions used for plotting FASTA">
            <filter>action_type["output_options"]["sites_bed_fasta_out"]</filter>
        </data>
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <conditional name="action_type">
                <param name="action_type_selector" value="enmo"/>
                <param name="input_bed" value="test_enmo.bed"/>
                <param name="gtf_file" value="test.gtf"/>
                <section name="output_options">
                    <param name="motif_enrich_table" value="true"/>
                </section>
            </conditional>
            <output name="motif_enrichment_stats" file="expected_enrich.tsv"/>
        </test>

    </tests>

    <help><![CDATA[
@HELP_HEADER@

-----

**RBPBench program modes**

*RBPBench Enrichment* on Galaxy provides the following main functions (choose on top via "Select RBPBench program mode"):   

- Enrichment and co-occurrence statistics on single motif level (enmo)  
- Motif enrichment analysis on neighboring regions (nemo)  


**Enrichment and co-occurrence statistics on single motif level (enmo)**

This mode takes motif hit sites (or other regions of interest) as input and tests for enrichment of specific RBPs/motifs in high-scoring vs. lower-scoring regions, co-occurrence between different RBP motifs within the same regions. The background is built automatically using transcript-based annotations (GTF file). You may optionally include user-defined RBP motifs or supply a custom motif database; output motif enrichment and co-occurrence tables, output FASTA/BED files of regions used for plotting. An interactive HTML report is generated, including enrichment scores, correlation plots, and co-occurrence heatmaps. This mode is suitable for assessing RBP motif enrichment in top-ranking CLIP-seq peaks; studying motif co-binding between RBPs; post-processing outputs from search (subtool *RBPBench Search*)  or searchrna (subtool *RBPBench Search Transcript*).


**Motif enrichment analysis on neighboring regions (nemo)**

This mode tests for positional enrichment of motifs in regions flanking the input regions (e.g., upstream/downstream of peaks). It performs enrichment analysis separately for motifs overlapping input regions (optional via `--allow-overlaps`), motifs in background windows outside the input sites. Useful for studying directional motif distribution around regulatory sites, assessing spatial motif enrichment patterns. Supports the same motif and annotation inputs as enmo mode. Outputs include enrichment and co-occurrence tables, FASTA/BED files for plotting, and a detailed HTML report with spatial profiles.

    ]]>    </help>
    <expand macro="citations"/>
    <expand macro="creator"/>
</tool>