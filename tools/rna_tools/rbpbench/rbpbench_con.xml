<tool id="rbpbench_con" name="RBPBench Conservation" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@profile@">
    <description>scores comparison between two sets of genomic sites</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio_tools"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        @PREPARE_PHASTCONS@
        @PREPARE_PHYLOP@
        rbpbench con
            --in '$in_bed_file'
            --ctrl-in '$ctrl_bed_file'
            --out ./
            #if $con_options.phastcons_file.cons_scores_file_selector != "no":
                --phastcons phastcons_file.bw
            #end if
            #if $con_options.phylop_file.cons_scores_file_selector != "no":
                --phylop phylop_file.bw
            #end if
            $con_options.con_use_regions
            $con_options.con_no_id_check
            --wrs-mode $con_options.con_wrs_mode
            $output_options.con_plot_pdf
            @SORT_JS@
    ]]>    </command>
    <inputs>
        <param name="in_bed_file" type="data" format="bed" label="Input genomic sites" help="Genomic regions of interest in BED format"/>
        <param name="ctrl_bed_file" type="data" format="bed" label="Control genomic sites" help="Control genomic regions for comparison in BED format"/>
        <section name="con_options" title="Conservation score analysis options">
            <conditional name="phastcons_file">
                <param name="cons_scores_file_selector" type="select" label="Select genomic .bigWig file with phastCons conservation scores">
                    <option selected="True" value="no">No</option>
                    <option value="builtin">Select built-in conservation score file</option>
                    <option value="history">Select conservation score file from history</option>
                </param>
                <expand macro="cons_scores_file"/>
            </conditional>
            <conditional name="phylop_file">
                <param name="cons_scores_file_selector" type="select" label="Select genomic .bigWig file with phyloP conservation scores">
                    <option selected="True" value="no">No</option>
                    <option value="builtin">Select built-in conservation score file</option>
                    <option value="history">Select conservation score file from history</option>
                </param>
                <expand macro="cons_scores_file"/>
            </conditional>
            <param name="con_use_regions" checked="False" type="boolean" truevalue="--use-regions" falsevalue="" label="Use regions as IDs" help="Use full genomic regions instead of BED column 4 as site IDs"/>
            <param name="con_no_id_check" type="boolean" truevalue="--no-id-check" falsevalue="" checked="False" label="Disable region ID checking" help="Do not check region IDs, overwrite if duplicated"/>
            <param name="con_wrs_mode" type="select" checked="True" label="Wilcoxon test mode" help="Define the alternative hypothesis for Wilcoxon rank-sum test">
                <option value="1" selected="true">Test whether input sites have higher scores than control sites</option>
                <option value="2">Test whether input sites have lower scores than control sites</option>
            </param>
        </section>
        <section name="output_options" title="Output options">
            <param name="con_plot_pdf" type="boolean" truevalue="--plot-pdf" falsevalue="" checked="False" label="Plot as PDF?" help="Output conservation plots as PDF"/>
            <param name="avg_con_sc" type="boolean" checked="False" label="Ouput input and control sites scores tables" />
        </section>
        <section name="advanced_html_output_options" title="Advanced HTML report options">
            <expand macro="advanced_html_output_options_sort_js"/>
        </section>
    </inputs>
    <outputs>
        <data name="conservation_html" format="html" from_work_dir="report.rbpbench_con.html" label="${tool.name} on ${on_string}: Conservation report HTML"/>
        <data name="phastcons_scores_png" format="png" from_work_dir="phastCons_scores.png" label="${tool.name} on ${on_string}: phastCons scores PNG">
            <filter>not output_options["con_plot_pdf"]</filter>
        </data>
        <data name="phastcons_scores_pdf" format="pdf" from_work_dir="phastCons_scores.pdf" label="${tool.name} on ${on_string}: phastCons scores PDF">
            <filter>output_options["con_plot_pdf"]</filter>
        </data>
        <data name="phylop_scores_png" format="png" from_work_dir="phyloP_scores.png" label="${tool.name} on ${on_string}: phyloP scores PNG">
            <filter>not output_options["con_plot_pdf"]</filter>
        </data>
        <data name="phylop_scores_pdf" format="pdf" from_work_dir="phyloP_scores.pdf" label="${tool.name} on ${on_string}: phyloP scores PDF">
            <filter>output_options["con_plot_pdf"]</filter>
        </data>
        <data name="in_regions_avg_con_sc" format="tabular" from_work_dir="in_regions.avg_con_sc.tsv" label="${tool.name} on ${on_string}: Input sites scores table">
            <filter>output_options["avg_con_sc"]</filter>
        </data>
        <data name="control_regions_avg_con_sc" format="tabular" from_work_dir="control_regions.avg_con_sc.tsv" label="${tool.name} on ${on_string}: Control sites scores table">
            <filter>output_options["avg_con_sc"]</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="5">
            <param name="in_bed_file" value="in.input_sites.bed"/>
            <param name="ctrl_bed_file" value="in.control_sites.bed"/>
            <section name="con_options">
                <conditional name="phastcons_file">
                    <param name="cons_scores_file_selector" value="history"/>
                    <param name="history_cons_scores_file" value="in.phastcons_test.bw"/>
                </conditional>
                <conditional name="phylop_file">
                    <param name="cons_scores_file_selector" value="no"/>
                </conditional>
                <param name="con_use_regions" value="false"/>
                <param name="con_no_id_check" value="false"/>
                <param name="con_wrs_mode" value="1"/>
            </section>
            <section name="output_options">
                <param name="con_plot_pdf" value="false"/>
                <param name="avg_con_sc" value="true"/>
            </section>
            <output name="conservation_html" file="out.report.rbpbench_con.html" compare="contains"/>
            <output name="in_regions_avg_con_sc" file="out.in_scores.rbpbench_con.tsv"/>
            <output name="control_regions_avg_con_sc" file="out.ctrl_scores.rbpbench_con.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

-----

**RBPBench program modes**

*RBPBench Conservation* on Galaxy provides the following main functions: 

- Conservation scores comparison between two sets of genomic sites

**Conservation scores comparison between two sets of genomic sites**

This tool compares evolutionary conservation scores between two sets of genomic regions using phastCons and/or phyloP, ideal for answering questions like: "Are my regions of interest more conserved than a matched control set?" The tool takes two BED files: input regions and control regions. For each region, average conservation scores are computed (across all positions). The Wilcoxon rank-sum test is used to compare the distributions. Supports either or both: phastCons (e.g., *hg38.phastCons100way.bw*), phyloP (e.g., *hg38.phyloP100way.bw*). Optionally, you can use full regions as IDs, disable duplicate ID checking. The tool outputs an interactive HTML report comparing the conservation distributions; boxplots and score histograms (PDF or PNG); tabular summaries of average scores per region set (optional).

    ]]>    </help>
    <expand macro="citations"/>
    <expand macro="creator"/>
</tool>