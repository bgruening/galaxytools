<tool id="cmsearch_deoverlap" name="CMsearch deoverlap" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>removes lower scoring overlaps from cmsearch results</description>
    <macros>
        <token name="@TOOL_VERSION@">0.09</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <xrefs>
        <xref type="bio.tools">cmsearch-deoverlap</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">cmsearch_tblout_deoverlap</requirement>
        <requirement type="package" version="4.8">sed</requirement>
    </requirements>
    <command><![CDATA[
        ln -s '$cmsearch_matches' cmsearch_matches &&
        #if str($clan_info_cond.clan_info_select) == "yes"
            ln -s '$clan_info_cond.clan_info_file' clan_info &&
        #end if
        cmsearch-deoverlap.pl
        #if str($clan_info_cond.clan_info_select) == "yes"
            --clanin clan_info $clan_info_cond.invclan
        #end if
        $s
        $maxkeep
        $input_type_cond.input_type_select
        #if str($input_type_cond.input_type_select) == "--hmmsearch"
            $input_type_cond.besthmm
        #end if
        cmsearch_matches
        #if str($overlapout) == "--overlapout"
            $overlapout '$overlap_output'
        #end if
        #if str($dirty) == "--dirty"
            $dirty &&
            sed "s/[[:blank:]]\+/\t/g" cmsearch_matches.sort > cmsearch_matches.sort.tabular &&
            mv cmsearch_matches.sort.tabular '$matches_sort'
        #end if
        &&
        sed "s/[[:blank:]]\+/\t/g" cmsearch_matches.deoverlapped > cmsearch_matches.deoverlapped.tabular &&
        mv cmsearch_matches.deoverlapped.tabular '$deoverlapped_matches'
    ]]></command>
    <inputs>
        <param name="cmsearch_matches" type="data" format="tabular" label="Matches output file from cmsearch/nhmmer/hmmsearch/cmscan"/>
        <conditional name="clan_info_cond">
            <param name="clan_info_select" type="select" label="Only remove overlaps within clans" help="Read clan info from file and only remove overlaps within clans">
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </param>
            <when value="yes">
                <param name="clan_info_file" type="data" format="txt" label="Clan information" help="Each row in the file contains an RNA clan and its corresponding family members"/>
                <param argument="--invclan" type="boolean" truevalue="--invclan" falsevalue="" label="Invert clan behavior" help="Do not remove overlaps within clans, remove all other overlaps"/>
            </when>
            <when value="no">
            </when>
        </conditional>
        <conditional name="input_type_cond">
            <param name="input_type_select" type="select" label="Input files are from">
                    <option value="--fcmsearch" selected="true">cmsearch</option>
                    <option value="--nhmmer">nhmmer v3.x</option>
                    <option value="--hmmsearch">hmmsearch v3.x</option>
                    <option value="--cmscan">cmscan v1.1x</option>
            </param>
            <when value="--fcmsearch">
            </when>
            <when value="--nhmmer">
            </when>
            <when value="--hmmsearch">
                <param argument="--besthmm" type="boolean" label="Sort by evalue/score of *best* single hit not evalue/score of full seq" truevalue="--besthmm" falsevalue=""/>
            </when>
            <when value="--cmscan">
            </when>
        </conditional>
        <param argument="-s" type="boolean" truevalue="-s" falsevalue="" label="sort hits by bit score [default: sort by E-value]"/>
        <param argument="--maxkeep" type="boolean" truevalue="--maxkeep" falsevalue="" label="Keep hits that only overlap with other hits that are not kept" help="If this option is not set, all hits with higher scoring overlap will be removed." />
        <param argument="--dirty" type="boolean" truevalue="--dirty" falsevalue="" label="Keep the intermediate sorted tblout file"/>
        <param argument="--overlapout" type="boolean" truevalue="--overlapout" falsevalue="" label="Generate a tabular file with overlap information"/>
    </inputs>
    <outputs>
        <data name="deoverlapped_matches" format="tabular" label="${tool.name} on ${on_string}: Deoverlapped matches"/>
        <data name="overlap_output" format="tabular" label="${tool.name} on ${on_string}: Overlap information">
            <filter>overlapout</filter>
        </data>
        <data name="matches_sort" format="tabular" label="${tool.name} on ${on_string}: Intermediate sorted matches">
            <filter>dirty</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="cmsearch_matches" value="2.cmsearch.tblout"/>
            <param name="s" value="false"/>
            <param name="maxkeep" value="false"/>
            <param name="dirty" value="false"/>
            <param name="overlapout" value="true"/>
            <conditional name="clan_info_cond">
                <param name="clan_info_select" value="no"/>
            </conditional>
            <conditional name="input_type_cond">
                <param name="input_type_select" value="--fcmsearch"/>
            </conditional>
            <output name="deoverlapped_matches" file="cmsearch_no_clan_deoverlapped_matches.tabular" ftype="tabular"/>
            <output name="overlap_output" file="cmsearch_no_clan_overlap_information.tabular" ftype="tabular"/>
        </test>
        <test expect_num_outputs="2">
            <param name="cmsearch_matches" value="1.cmsearch.tblout"/>
            <param name="s" value="true"/>
            <param name="maxkeep" value="true"/>
            <param name="dirty" value="true"/>
            <param name="overlapout" value="false"/>
            <conditional name="clan_info_cond">
                <param name="clan_info_select" value="yes"/>
                <param name="clan_info_file" value="ribo.clan_info"/>
                <param name="invclan" value="true"/>
            </conditional>
            <conditional name="input_type_cond">
                <param name="input_type_select" value="--cmscan"/>
            </conditional>
            <output name="deoverlapped_matches" file="cmscan_clan_deoverlapped_matches.tabular" ftype="tabular"/>
            <output name="matches_sort" file="cmscan_clan_intermediate_sorted_matches.tabular" ftype="tabular"/>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What this tool does**

This tool removes lower-scoring overlaps from cmsearch/nhmmer/hmmsearch/cmscan results. Given information about the clans and the cmsearch tbl output this tool returns a filtered cmsearch tbl output.

**clan.info:**

CL00111    SSU_rRNA_bacteria SSU_rRNA_archaea SSU_rRNA_eukarya SSU_rRNA_microsporidia SSU_trypano_mito

CL00112    LSU_rRNA_archaea LSU_rRNA_bacteria LSU_rRNA_eukarya LSU_trypano_mito 5_8S_rRNA

CL99999 5S_rRNA mtPerm-5S

**cmsearch.tblout:**

contig--2249925      -         SSU_rRNA_bacteria    RF00177   hmm       19      914        2      898      +     -    6 0.50   5.7  638.4  1.1e-189 !   -

contig--2255364      -         SSU_rRNA_bacteria    RF00177   hmm      325     1084      765        1      -     -    6 0.52   3.9  624.0  2.5e-185 !   -

contig--2369838      -         SSU_rRNA_bacteria    RF00177   hmm       90      938       20      855      +     -    6 0.52   7.0  609.3  6.6e-181 !   -

contig--2271497      -         SSU_rRNA_bacteria    RF00177   hmm        4      812      835        2      -     -    6 0.51   5.0  597.5  2.5e-177 !   -

contig--2369838      -         SSU_rRNA_archaea     RF01959   hmm       70      894       17      855      +     -    6 0.52   5.4  346.7  9.9e-102 !   -

**cmsearch.tblout.deoverlapped:**

contig--2249925      -         SSU_rRNA_bacteria    RF00177   hmm       19      914        2      898      +     -    6 0.50   5.7  638.4  1.1e-189 !   -

contig--2255364      -         SSU_rRNA_bacteria    RF00177   hmm      325     1084      765        1      -     -    6 0.52   3.9  624.0  2.5e-185 !   -

contig--2271497      -         SSU_rRNA_bacteria    RF00177   hmm        4      812      835        2      -     -    6 0.51   5.0  597.5  2.5e-177 !   -

contig--2369838      -         SSU_rRNA_bacteria    RF00177   hmm       90      938       20      855      +     -    6 0.52   7.0  609.3  6.6e-181 !   -

    ]]></help>
    <creator>
        <person givenName="Rand" familyName="Zoabi" url="https://github.com/RZ9082" identifier="https://orcid.org/0009-0000-2501-8053"/>
    </creator>
    <citations>
        <citation type="bibtex">
            @software{nawrocki_nawrockiecmsearch_tblout_deoverlap_2019,
            title = {nawrockie/cmsearch\_tblout\_deoverlap},
            url = {https://github.com/nawrockie/cmsearch_tblout_deoverlap},
            abstract = {Script that removes lower scoring overlaps from cmsearch v1.1x --tblout files.},
            author = {Nawrocki, Eric},
            year = {2019}}
        </citation>
    </citations>
</tool>
