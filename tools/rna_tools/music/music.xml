<tool id="music" name="MUSIC" version="0.1.0">
    <description>An algorithm for identification of enriched regions at multiple scales in the read depth signals from ChIP-Seq experiments</description>
    <requirements>
        <requirement type="package" version="1.0.0">music</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        mkdir mappability &&
        #for $mapp_infile in $mapp_infiles
            ln -s $mapp_infile mappability/ &&
        #end for
        mkdir SSERs &&
        mkdir ERs &&
        #if $control
            mkdir control &&
            mkdir control/preprocessed control/sorted control/pruned &&
            run_MUSIC.csh -preprocess $control_infile control/preprocessed &&
            run_MUSIC.csh -remove_duplicates control/preprocessed control/sorted control/pruned &&
        #end if

        mkdir chip &&
        mkdir chip/preprocessed chip/sorted chip/pruned &&
        #for $chip_infile in $chip_infiles
            run_MUSIC.csh -preprocess $chip_infile chip/preprocessed &&
        #end for
        run_MUSIC.csh -remove_duplicates chip/preprocessed chip/sorted chip/pruned &&

        #if str($options) == "-get_broad_ERs":
            MUSIC -get_per_win_p_vals_vs_FC -chip chip/pruned/ -control control/pruned/ -l_win_step $l_win_step -l_win_min $l_win_min -l_win_max $l_win_max &&
            MUSIC -get_multiscale_broad_ERs -l_p 0
        #elif  str($options) == "-get_punctate_ERs":
            MUSIC -get_multiscale_punctate_ERs -l_p $l_p
        #end if
        -chip chip/pruned/
        #if $control
            -control control/pruned/
        #end if
        -mapp mappability/
        -begin_l $begin_l
        -end_l $end_l
        -step $step
        -l_bin $l_bin
        -l_mapp $l_mapp
        -mapp_thr $mapp_thr
        -l_frag $l_frag
        -sigma $sigma
        -gamma $gamma
        -q_val $q_val
        &&
        mv SSERs*.bed SSERs/ &&
        mv ERs*.bed ERs/

    ]]></command>
    <inputs>
        <param name="options" type="select" label="Options">
            <option value="-get_broad_ERs">Broad ERs</option>
            <option value="-get_punctate_ERs">Punctate ERs</option>
        </param>
        <param type="data" name="chip_infiles" multiple="true" format="tagAlign.gz,tagAlign,bed.gz,bed,bowtie,bowtie.gz,sam,SAM,bam,BAM" help="ChIP input file"/>
        <param type="data" name="mapp_infiles" multiple="true" help="multi-mapability profiles"/>
        <param type="data" name="control_infile" format="tagAlign.gz,tagAlign,bed.gz,bed,bowtie,bowtie.gz,sam,SAM,bam,BAM" help="Control input file"/>
        <param name="control" type="boolean" checked="false" truevalue="-control" falsevalue="" help="Whether control is present or not"/>
        <param name="begin_l" type="integer" value="1000" help="First scale smoothing window length"/>
        <param name="end_l" type="integer" value="16000" help="Last scale smoothing window length"/>
        <param name="step" type="float" value="1.5" help="Multiplicative window length step"/>
        <param name="l_bin" type="integer" value="5" help="Bin size in nucleotides"/>
        <param name="l_mapp" type="integer" value="50" help="Read length of multi-mapability profiles"/>
        <param name="mapp_thr" type="float" value="1.2" help="Multi-mapability signal threshold used in correction"/>
        <param name="l_frag" type="integer" value="200" help="Fragment length"/>
        <param name="l_c" type="integer" value="2000" help="Mapability correction window length"/>
        <param name="l_p" type="integer" value="0" help="Normalization window length for p-value computation"/>
        <param name="sigma" type="float" value="0.5" help="min(Fore/Back, Back/Fore)"/>
        <param name="gamma" type="integer" value="4" help="Min threshold for unsmoothed/smoothed"/>
        <param name="q_val" type="float" value="0.1" help="Maximum q-value for the reported ERs"/>
        <param name="l_win_min" type="integer" value="200" help="Minimum p-val window length"/>
        <param name="l_win_max" type="integer" value="5000" help="Maximum p-val window length"/>
        <param name="l_win_step" type="integer" value="50" help="p-val window length step"/>
    </inputs>
    <outputs>
        <data format="bed" name="SSERs_report">
            <discover_datasets pattern="__designation_and_ext__" directory="SSERs" visible="true" />
        </data>
        <data format="bed" name="ERs_report">
            <discover_datasets pattern="__designation_and_ext__" directory="ERs" visible="true" />
        </data>
    </outputs>
    <tests>
        <test>
            <param name="chip_infiles" value="GM12878_H3K27ac.sam"/>
            <param name="control_infile" value="GM12878_Control.sam"/>
            <param name="mapp_infiles" value="22.bin"/>
            <param name="options" value="-get_punctate_ERs"/>
            <param name="l_p" value="-1500"/>
            <param name="q_val" value="0.05"/>
            <output_collection name="SSERs_report" count="8"/>
            <output_collection name="ERs_report" count="0"/>
        </test>
    </tests>
    <help>
<![CDATA[

MUSIC is an algorithm for identification of enriched regions at multiple scales in the read depth signals from ChIP-Seq experiments.
It takes as input:
- Mapped ChIP and control reads (optional),
- Smoothing scale window lengths (in base pairs),

and outputs:
- Enriched regions at multiple scales,
- Significantly enriched regions from all the scales.

Unlike other ER identification methods, MUSIC allows analyzing the scale length spectrum of ChIP-Seq datasets and also selecting a user specific slice in the scale length spectrum with custom granularity and generates the enriched regions at each length scale.
MUSIC does not strictly require a control experiment (for example mock IP, input DNA) to be performed. It is, however, strongly advised to generate control datasets matching the sample of interest (See Landt et al 2012).

USAGE: MUSIC [options] [arguments]

Options:
    Read Preprocessing:
        -preprocess [File format ("SAM"/"ELAND"/"bowtie"/"tagAlign"/"BED5"/"BED6")] [Mapped reads file path ("stdin" for piped input)] [Output directory]
        -sort_reads [Reads directory] [Output directory]
        -remove_duplicates [Sorted reads directory] [Max # of duplicates per position] [Output directory]
    Peak Selection:
        -get_multiscale_broad_ERs [Options/Values]
        -get_multiscale_punctate_ERs [Options/Values]
        -get_TF_peaks [Options/Values]
    Profile Outputs:
        -write_MS_decomposition [Options/Values]
        -write_logR_signal [Options/Values]
    Parametrization Options:
        -get_per_win_p_vals_vs_FC [Options/Values]
        -get_scale_spectrum [Options/Values]
    Recreative Options (Fun with ChIP-Seq):
        -get_multiscale_music [Options/Values]

Parameters that work with all the options:
    -chip [ChIP reads directory]
    -control [control reads directory]
    -mapp [multi-mapability profiles directory] (please check http://hgdownload.cse.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeMapability/ and http://archive.gersteinlab.org/proj/MUSIC/multimap_profiles/)
    -begin_l [First scale smoothing window length (1000)]
    -end_l [Last scale smoothing window length (16000)]
    -step [Multiplicative window length step (1.5)]
    -l_bin [Bin size in nucleotides (5)]
    -l_mapp [Read length of multi-mapability profiles]
    -mapp_thr [Multi-mapability signal threshold used in correction (1.2)]
    -l_frag [Fragment length (200)]
    -l_c [Mapability correction window length (2000)]
    -l_p [Normalization window length for p-value computation]
    -sigma [min(Fore/Back, Back/Fore) (.5)]
    -gamma [Min threshold for unsmoothed/smoothed (4)]
    -q_val [Maximum q-value for the reported ERs]
Parameters for -get_per_win_p_vals_vs_FC:
    -l_win_min [Minimum p-val window length (100)]
    -l_win_max [Maximum p-val window length (5000)]
    -l_win_step [p-val window length step (250)]

]]>
    </help>
    <citations>
        <citation type="doi">10.1186/s13059-014-0474-3</citation>
    </citations>
</tool>
