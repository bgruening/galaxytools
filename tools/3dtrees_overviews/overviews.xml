<tool id="3dtrees_overviews" name="3Dtrees: Overviews" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.2">
  <description>Generate 3D point cloud overview images from LAZ/LAS datasets</description>
  <macros>
    <token name="@TOOL_VERSION@">1.2.0</token>
    <token name="@VERSION_SUFFIX@">0</token>
  </macros>
  <requirements>
    <container type="docker">ghcr.io/3dtrees-earth/tool_overviews:@TOOL_VERSION@</container>
  </requirements>
  
  <command detect_errors="exit_code"><![CDATA[
        mkdir -p input_files &&
        #for $f in $input
            ln -s '$f' input_files/'${f.element_identifier}.laz' &&
        #end for
        mkdir -p ./output_dir/ &&
        python -u /src/run.py 
        --input-dir input_files
        --max-total-points '$max_total_points'
        --section-width '$section_width' 
        --image-width '$image_width' 
        --image-height '$image_height' 
        --top-views-deg '$top_views_deg' 
        --cmap '$cmap' 
        --camera-distance '$camera_distance' 
        --output-dir ./output_dir/
        2>&1
        ]]>
</command>
  <inputs>
    <param name="input" type="data" multiple="true" format="laz" label="Point Cloud Collection" help="Collection of LAZ/LAS files. All files will be aggregated into a single overview."/>
    
    <param name="max_total_points" type="integer" value="40000000" min="1000000" max="1000000000" label="Max Total Points" help="Maximum total points when aggregating. Points are sampled proportionally from each file."/>
    
    <param name="section_width" type="integer" value="10" min="1" max="100" label="Section Width" help="Width of section views in meters"/>
    
    <param name="image_width" type="integer" value="1024" min="128" max="4096" label="Image Width" help="Width of output images in pixels"/>
    
    <param name="image_height" type="integer" value="768" min="64" max="2048" label="Image Height" help="Height of output images in pixels"/>
    
    <param name="top_views_deg" type="integer" value="180" min="1" max="360" label="Top View Rotation Step" help="Angular step size for top view rotation in degrees (180 = 2 views, 120 = 3 views, 90 = 4 views)"/>
    
    <param name="cmap" type="select" label="Color Map" help="Colormap for point cloud visualization">
      <option value="turbo">Turbo</option>
      <option value="viridis" selected="True">Viridis</option>
      <option value="plasma">Plasma</option>
      <option value="inferno">Inferno</option>
      <option value="magma">Magma</option>
      <option value="cividis">Cividis</option>
      <option value="coolwarm">Cool Warm</option>
      <option value="rainbow">Rainbow</option>
      <option value="jet">Jet</option>
      <option value="hot">Hot</option>
      <option value="cool">Cool</option>
      <option value="copper">Copper</option>
      <option value="bone">Bone</option>
      <option value="pink">Pink</option>
      <option value="spring">Spring</option>
      <option value="summer">Summer</option>
      <option value="autumn">Autumn</option>
      <option value="winter">Winter</option>
    </param>
    <param name="camera_distance" type="float" value="35.0" min="1.0" max="200.0" label="Camera Distance" help="Distance of camera from point cloud center"/>
  </inputs>
  <outputs>
    <collection name="top_views" type="list" label="Top View Images">
      <discover_datasets pattern="(?P&lt;name&gt;top_view_.*\.png)" directory="./output_dir/" recurse="false" visible="false" format="png"/>
    </collection>
    <collection name="section_views" type="list" label="Section View Images">
      <discover_datasets pattern="(?P&lt;name&gt;section_.*\.png)" directory="./output_dir/" recurse="false" visible="false" format="png"/>
    </collection>
  </outputs>
  <tests>
    <test expect_num_outputs="2">
      <param name="input" value="mikro.laz"/>
      <param name="max_total_points" value="1000000"/>
      <param name="section_width" value="5"/>
      <param name="image_width" value="512"/>
      <param name="image_height" value="384"/>
      <param name="top_views_deg" value="45"/>
      <param name="cmap" value="viridis"/>
      <param name="camera_distance" value="25.0"/>
      <output_collection name="top_views" type="list">
        <element name="top_view_00.png" ftype="png">
          <assert_contents>
            <has_size size="160000" delta="100000"/>
          </assert_contents>
        </element>
      </output_collection>
    </test>
  </tests>
  <help format="markdown">

**What it does**

This tool generates 3D overview visualizations from point cloud datasets. It creates:

1. **Top View Images**: A series of top-down views rotated around the point cloud center
2. **Section Views**: Cross-sectional views from north-south and east-west directions

When given a collection with multiple files, the tool automatically aggregates all point clouds into a single visualization, sampling proportionally from each file to stay within resource limits.

-----

**Input**

- **Point Cloud Collection**: Collection of LAZ or LAS format point cloud files
- **Max Total Points**: Maximum total points when aggregating (default: 50M points). Points are sampled proportionally from each file.
- **Section Width**: Width of cross-sectional views in meters
- **Image Dimensions**: Width and height of output images in pixels
- **Top View Rotation**: Degree step for rotation views (180° = 2 views, 90° = 4 views)
- **Color Map**: Color scheme for visualization
- **Camera Distance**: Distance multiplier for camera positioning

-----

**Output**

- **Top Views Collection**: PNG images of top-down views at different rotation angles
- **Section Views Collection**: PNG images of cross-sectional views

-----

**Example**

For a forest point cloud dataset (single or multiple files), this tool will generate:
- 2 top view images (every 180 degrees by default)
- 2 section view images (north-south and east-west cuts)

The images use height-based coloring to show terrain and vegetation structure.

</help>
  <creator>
    <person name="Julian Frey" email="julian.frey@wwd.uni-freiburg.de" url="https://orcid.org/0000-0001-7895-702X"/>
    <person name="Kilian Gerberding" email="kilian.gerberding@geosense.uni-freiburg.de" url="https://orcid.org/0009-0002-5001-2571"/>
    <organization name="3Dtrees-Team, University of Freiburg" url="https://github.com/3dTrees-earth"/>
  </creator>
  <citations>
    <citation type="bibtex">@misc{3dtrees_overviews, title = {3Dtrees Overview Generator}, author = {3Dtrees Project}, year = {2025}}</citation>
  </citations>
</tool>
