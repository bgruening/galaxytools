<tool id="chicago_make_design_files" name="Create design files for CHiCAGO" version="0.1.0">
    <requirements>
        <requirement type="package" version="1.2.0">Chicago</requirement>
        <requirement type="package" version="1.2.0">chicagotools</requirement>
        <requirement type="package" version="2.24">bedtools</requirement>
        <requirement type="package" version="2.3.1">cran</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
        ln -s "$rmapfile" data.rmap &&
        ln -s "$baitmapfile" data.baitmap &&
        
        makeDesignFiles.py data.rmap data.baitmap
        #if $advanced_options.minFragLen
                --minFragLen $advanced_options.minFragLen
        #end if
        #if $advanced_options.maxFragLen
                --maxFragLen $advanced_options.maxFragLen
        #end if
        #if $advanced_options.maxLBrownEst
                --maxLBrownEst $advanced_options.maxLBrownEst
        #end if
        #if $advanced_options.binsize
                --binsize $advanced_options.binsize
        #end if
        #if $advanced_options.removeb2b
                --removeb2b $advanced_options.removeb2b
        #end if
        #if $advanced_options.removeAdjacent
                --removeAdjacent $advanced_options.removeAdjacent
        #end if
    ]]></command>
    <inputs>
        <param argument="--rmapfile" type="data" format="rmap" label="RMAP file" help="A tab-separated file of the format 'chr' 'start' 'end' 'numeric ID', describing the restriction digest (or 'virtual digest' if pooled fragments are used). These numeric IDs are referred to as 'otherEndID' in Chicago. All fragments mapping outside of the digest coordinates will be disregarded by both these scripts and Chicago."/>
        <param argument="--baitmapfile" type="data" format="baitmap" label="Baitmap file" help="a tab-separated file of the format 'chr' 'start' 'end' 'numeric ID' 'annotation', listing the coordinates of the baited/captured restriction fragments (should be a subset of the fragments listed in rmapfile), their numeric IDs (should match those listed in rmapfile for the corresponding fragments) and their annotations (such as, for example, the names of baited promoters). The numeric IDs are referred to as 'baitID' in Chicago." />
        <section name="advanced_options" title="Advanced options">
            <param argument="--minFragLen" type="integer" value="150" label="Min fragment length" help="The min fragment length cutoff." />
            <param argument="--maxFragLen" type="integer" value="40000" label="Max fragment length" help="The max fragment length cutoff." />
            <param argument="--maxLBrownEst" type="integer" value="1500000" label="Max distance range for noise" help="the 'proximal distance range' for estimating Brownian noise" />
            <param argument="--binsize" type="integer" value="20000" label="Size of the bins in bps" help="The size of the bins (in bps) for pooling restriction fragments"/>
            <param argument="--removeb2b" type="boolean" value="True" label="Remove bait-to-bait interactions" help="True, meaning that bait-to-bait interactions should not be counted when computing the total numbers of fragments at a given distance."/>
            <param argument="--removeAdjacent" type="boolean" value="True" label="Remove fragments adjacent to baits" help="True, meaning that fragments immediately adjacent to bait should not be counted."/>
        </section>
    </inputs>
    <outputs>
       <data format="txt" name="chicago_design_files_result">
            <discover_datasets pattern="__designation_and_ext__" visible="true" />
        </data>
    </outputs>
    <tests>
        <test>
            <param name="rmap_file_test" value="test-data/h19_chr20and21.rmap" ftype="rmap" />
            <param name="baitmap_file_test" value="test-data/h19_chr20and21.baitmap" ftype="baitmap" />
            <param name="output_nperbin_file" value="test-data/h19_chr20and21.npb" ftype="npb" />
            <param name="output_nbaitsperbin_file" value="test-data/h19_chr20and21.nbpb" ftype="nbpb" />
            <param name="output_proxoe_file" value="test-data/h19_chr20and21.poe" ftype="poe" />
        </test>
    </tests>
    <help><![CDATA[
    A new set of design files needs to be generated for each combination of restriction enzyme and captured baits i.e., when .baitmap and/or .rmap files are updated. Note that it is possible to also create "virtual digests" in the same way, where the actual restriction fragments are pooled into larger "virtual" fragments.

**Important**: The create design files for CHiCAGO tool needs to be re-run when updating the experimental design with respect to either restriction enzyme, capture design or Chicago settings with respect to binning, proximal distance range and/or restriction fragment filtering.

**Output**:

- NPerBin file (.npb): <Total no. valid restriction fragments in distance bin 1> ... , where the bins map within the "proximal" distance range from each bait (0; maxLBrownEst] and bin size is defined by the binsize parameter.
- NBaitsPerBin file (.nbpb): <Total no. valid baits in distance bin 1> ... , where the bins map within the "proximal" distance range from each other end (0; maxLBrownEst] and bin size is defined by the binsize parameter.
- Proximal Other End (ProxOE) file (.poe): for all combinations of baits and other ends that map within the "proximal" distance range from each other (0; maxLBrownEst]. Data in each file is preceded by a comment line listing the input parameters used to generate them.


    ]]></help>
</tool>
<!-- TODO: designDir, outputfile -->