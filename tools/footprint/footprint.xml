<?xml version="1.0" encoding="UTF-8"?>
<tool id="footprint" name="footprint" version="1.0.0">
    <requirements>
        <requirement type="package" version="1.0.0">footprint</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command><![CDATA[
            find_footprints.sh
            
            '$bam_file'
            
            $chrom_sizes
            
            $motif_coords
            
            $genome_fasta
            
            $factor_name
            
            #if $bias_file == "ATAC":
                $__tool_directory__/SeqBias_ATAC.txt
            #elif  $bias_file == "DNase double hit":
                $__tool_directory__/SeqBias_DNase_doublehit.txt
            #elif $bias_file == "DNase single hit":
                $__tool_directory__/SeqBias_DNase_singlehit.txt
            #end if 
            
            $peak_file
            
            $no_of_components
            
            $background
            
            $fixed_bg
            
            &&
            mv \$(find \$(pwd) -type f -name "*.PARAM") PARAM
            
            &&
            mv \$(find \$(pwd) -type f -name "*.RESULTS") RESULTS
            
            &&
            mv \$(find \$(pwd) -type f -name "*.plot2.png") plot2.png
            
            &&
            mv \$(find \$(pwd) -type f -name "*.plot1.png") plot1.png
            ]]></command>
    <inputs>
        <param name="bam_file" type="data" format="BAM" label="" help="" />
        <param name="chrom_sizes" type="data" format="tablular" label="" help="" />
        <param name="motif_coords" type="data" format="BED" label="" help="" />
        <param name="genome_fasta" type="data" format="fasta" label="" help="" />
        <param name="factor_name" type="text" label="" help="" />
        <param name="bias_file" type="select" label="">
            <option value="ATAC" selected="true">ATAC</option>
            <option value="DNase double hit">DNase double hit</option>
            <option value="DNase single hit">DNase single hit</option>
        </param>
        <param name="peak_file" type="data" format="tabular" label="" help="" />
        <param name="no_of_components" type="select" label="">
            <option value="2" selected="true">2</option>
            <option value="3">3</option>
        </param>
        <param name="background" type="select" label="">
            <option value="Flat" selected="true">Flat</option>
            <option value="Seq">Seq</option>
        </param>
        <param name="fixed_bg" type="select" label="">
            <option value="TRUE" selected="true">TRUE</option>
            <option value="FALSE">FALSE</option>
        </param>
    </inputs>
    <outputs>
        <data name="RESULTS" format="tabular" from_work_dir="RESULTS" label="${tool.name} on ${on_string}: TODO" />
        <data name="PARAM" format="txt" from_work_dir="PARAM" label="${tool.name} on ${on_string}: TODO" />
        <data name="plot1" format="png" from_work_dir="plot1.png" label="${tool.name} on ${on_string}: TODO" />
        <data name="plot2" format="png" from_work_dir="plot2.png" label="${tool.name} on ${on_string}: TODO" />
    </outputs>
    <tests>
        <test>
            <param name="bam_file" value="input_ATAC_HEK293_hg19_chr1.bam" />
            <param name="chrom_sizes" value="input_hg19.chr1.chrom.size" />
            <param name="motif_coords" value="input_CTCF_motifs_hg19_chr1.bed" />
            <param name="genome_fasta" value="input_hg19_chr1.fa" />
            <param name="factor_name" value="CTCF" />
            <param name="bias_file" value="ATAC" />
            <param name="peak_file" value="input_CTCF_HEK293_chip_hg19_chr1.bed" />
            <param name="no_of_components" value="2" />
            <param name="background" value="Seq" />
            <param name="fixed_bg" value="TRUE" />
            <output name="RESULTS" file="output.RESULTS" ftype="tabular" />
            <output name="PARAM" file="output.PARAM" ftype="txt" />
            <output name="plot1" file="output_plot1.png" ftype="png" />
            <output name="plot2" file="output_plot2.png" ftype="png" />
        </test>
    </tests>
    <help><![CDATA[.. class:: infomark

**Purpose**

This is a pipeline to find transcription factor footprints in ATAC-seq or DNase-seq data.


-----

.. class:: infomark

**Inputs**

bam_file: The bam file from the ATAC-seq or DNase-seq experiment.
chrom_sizes: A tab delimited file with 2 columns, where the first column is the chromosome name and the second column is the chromosome length for the appropriate organism and genome build.
motif_coords: A 6-column bed file with the coordinates of motif matches (eg resulting from scanning the genome with a PWM) for the transcription factor of interest. The 6 columns should contain chromosome, start coordinate, end coordinate, name, score and strand information in this order. The coordinates should be closed (1-based).
genome_fasta: A multi-fasta format file that contains the whole genome sequence for the appropriate organism and genome build. This file should be indexed (eg by using samtools faidx) and placed in the same directory.
factor_name: The name of the transcription factor of interest supplied by the user. This is used in the naming of the output files.
bias_file: A file listing the cleavage/transposition bias of the different protocols, for all 6-mers. Provided options: ATAC, DNase double hit or DNase single hit protocols.
peak_file: A file with the coordinates of the ChIP-seq peaks for the transcription factor of interest. The format is flexible as long as the first 3 columns (chromosome, start coordinate, end coordinate) are present.
no_of_components: Total number of footprint and background components that should be learned from the data. Options are 2 (1 fp and 1 bg) and 3 (2 fp and 1 bg) components.
background: The mode of initialization for the background component. Options are "Flat" or "Seq". Choosing "Flat" initializes this component as a uniform distribution. Choosing "Seq" initializes it as the signal profile that would be expected solely due to the protocol bias (given by the bias_file parameter).
fixed_bg: Whether the background component should be kept fixed. Options are TRUE/T or FALSE/F. Setting "TRUE" keeps this component fixed, whereas setting "FALSE" lets it be reestimated during training.   

-----

.. class:: infomark

**Outputs**

File with the ".RESULTS" extension: Gives the results of the footprinting analysis. The first 6 columns harbor the motif information (identical to the motif_coords input file). The 7th column has the footprint score (log-odds of footprint versus background) for each motif instance. The following columns show the probabilities for the individual footprint and background components.
File with the ".PARAM" extension: Gives the trained parameters for the footprint and background components. It includes as many lines as components (eg the first line has the parameters for the first component).   
Png file named "plot1": A plot with two panels, showing the initial components above and the final trained components below. The plotted values for the final components are given in the .PARAM output file explained above.
Png file named "plot2": A plot only with the final trained components. In a model where 2 components are used, this plot is identical to the bottom panel in plot1. When 3 components are used, this plot shows the weighted average of the 2 footprint components as the final footprint profile. 

]]></help>
    <citations>
        <citation type="doi">10.1093/nar/gkx120</citation>
    </citations>
</tool>
