<tool id="methylkit" name="methylKit" version="0.99.2">
  <description>A method for DNA methylation analysis and annotation</description>
  <requirements>
    <requirement type="package" version="0.99.2">bioconductor-methylkit</requirement>
  </requirements>
  <command>
<![CDATA[
      r_wrapper.sh $script_file
]]>
  </command>
  <configfiles>
    <configfile name="script_file">
        library("methylKit")

        test_files = list()
        control_files = list()

        test_ids = list()
        control_ids = list()

        #for $i, $s in enumerate( $test_series )
          test_ids[${i}] = past("test", ${i}, sep="")
          test_files[${i}] = "${s.input.file_name}"
        #end for

        #for $i, $s in enumerate( $control_series )
          control_ids[${i}] = past("control", ${i}, sep="")
          control_files[${i}] = "${s.input.file_name}"
        #end for

        input_files = append(test_files, control_files)
        sample_ids = append(test_ids, control_ids)
        treatment_tag = c(rep.int(1, length(test_ids)), rep.int(0, length(control_ids)))

        myobj=methRead(input_files, sample.id=sample_ids, assembly="${assembly}",
                    pipeline="${pipeline}", treatment=treatment_tag)

        ## unite function
        methidh=unite(myobj)

        #if $choice in ["all", "differential_methylation"]:
            ## the last two arguments slim, weighted.mean
            ## have the redundant counterparts in effect and adjust,
            ## so turning them off to avoide the possible conflict.
            myDiff = calculateDiffMeth(methidh, overdispersion="${input_type.overdispersion}",
            adjust="${input_type.adjust}", effect="${input_type.effect}", test="${input_type.test}",
            slim=FALSE, weighted.mean=FALSE)

            bedgraph(myDiff, file.name="output_myDiff.bed", col.name="meth.diff",
                     unmeth=FALSE, log.transform=FALSE, negative=FALSE, add.on="")

            MethPerChr = diffMethPerChr(myDiff, plot=FALSE,
                                        qvalue.cutoff=${input_type.qvalue_cutoff},
                                        meth.cutoff=${input_type.meth_cutoff})
            write.table(MethPerChr, sep="\t", row.names=FALSE, quote=FALSE, file="output_MethPerChr.csv")

            MethylDiff = getMethylDiff(myDiff, difference=${input_type.meth_cutoff},
                                        qvalue=${input_type.qvalue_cutoff}, type="${input_type.type}")
            bedgraph(MethylDiff, file.name="output_MethylDiff.bed", col.name="meth.diff",
                     unmeth=FALSE,log.transform=FALSE,negative=FALSE,add.on="")
        #end if

        #if $choice in ["all", "clustering"]:
            pdf( "output_clustering.pdf" )
            methClust = clusterSamples(methidh, dist="${input_type.dist}", method="${input_type.method}")
            devname = dev.off()

            pdf( "output_PCA.pdf" )
            PCASamples(methidh)
            devname = dev.off()
        #end if

        #if $choice in ["all", "segmentation"]:
            ## methSeg works for methylRaw or methylDiff with resolution region,
            ## so methylBase has to be tiled before
            tileRaw = tileMethylCounts(myobj[[1]])
            tileBase = tileMethylCounts(methidh)
            tileDiff = calculateDiffMeth(tileBase)

            ## methseg generates Granges
            segRaw = methSeg(tileRaw, diagnostic.plot = FALSE)
            segDiff = methSeg(tileDiff, diagnostic.plot = FALSE)

            ## and can be exported as BED
            methSeg2bed(segments = segRaw, filename = "output_seg_raw.bed")
            methSeg2bed(segments = segDiff, filename = "output_seg_diff.bed")
        #end if
    </configfile>
  </configfiles>

  <inputs>
    <repeat name="test_series" title="Test samples" min="1">
                <param name="input" type="data" format="txt" label="Add a file"
                    help="Such input file may be obtained from AMP pipeline for aligning RRBS reads." />
    </repeat>
    <repeat name="control_series" title="Control samples" min="1">
                <param name="input" type="data" format="txt" label="Add a file"
                    help="Such input file may be obtained from AMP pipeline for aligning RRBS reads." />
    </repeat>
    <param name="assembly" type="text"
        value="hg18" label="assembly"
        help="A string that defines the genome assembly such as
        hg18, mm9 (default: amp).">
    </param>
    <param name="pipeline" type="select"
        label="pipeline"
        help="name of the alignment pipeline (default: amp)">
        <option value="amp" selected="True">
        amp
        </option>
        <option value="bismark">
        bismark
        </option>
        <option value="bismarkCoverage">
        bismarkCoverage
        </option>
        <option value="bismarkCytosineReport">
        bismarkCytosineReport
        </option>
    </param>
    <conditional name="input_type">
        <param name="choice" type="select"
            label="Analysis to carry out:"
            help="The analysis you wish to carry out.">
            <option value="all" selected="True">
            All provided analysis
            </option>
            <option value="differential_methylation">
            Differential methylation
            </option>
            <option value="clustering">
            Clustering
            </option>
            <option value="segmentation">
            Segmentation
            </option>
        </param>
        <when value="all">
            <param name="overdispersion" type="select"
                label="overdispersion"
                help="if set to 'none' (default), no overdispersion
                correction will be attempted. 'MN' applies a scaling
                parameter to variance estimated by the model.
                If set to 'shrinkMN' (experimental parameter),
                scaling parameter will be shrunk towards a common value">
                <option value="none" selected="True">
                    none
                </option>
                <option value="MN">
                    MN
                </option>
                <option value="shrinkMN">
                    shrinkMN
                </option>
            </param>
            <param name="adjust" type="select"
                label="adjust"
                help="different methods to correct the p-values
                for multiple testing (default: SLIM).">
                <option value="SLIM" selected="True">
                    SLIM
                </option>
                <option value="holm">
                    holm
                </option>
                <option value="hochberg">
                    hochberg
                </option>
                <option value="hommel">
                    hommel
                </option>
                <option value="bonferroni">
                    bonferroni
                </option>
                <option value="BH">
                    BH
                </option>
                <option value="BY">
                    BY
                </option>
                <option value="fdr">
                    fdr
                </option>
                <option value="none">
                    none
                </option>
                <option value="qvalue">
                    qvalue
                </option>
            </param>
            <param name="effect" type="select"
                label="effect"
                help="method to calculate the mean methylation different
                between groups using read coverage as weights (default: wmean).
                When set to 'mean', the generic mean is applied and when
                set to 'predicted', predicted means from the logistic
                regression model is used for calculating the effect.">
                <option value="wmean" selected="True">
                    wmean
                </option>
                <option value="mean">
                    mean
                </option>
                <option value="predicted">
                    predicted
                </option>
            </param>
            <param name="test" type="select"
                label="test"
                help="the statistical test used to determine
                the methylation differences (default: Chisq-test).
                The F-test can be chosen
                if overdispersion control is applied.">
                <option value="Chisq" selected="True">
                    Chisq
                </option>
                <option value="F">
                    F
                </option>
            </param>
            <param name="qvalue_cutoff" type="float"
                value="0.01" label="qvalue.cutoff"
                help="cutoff for qvalue of differential methylation statistic (default:0.01)">
                <validator type="in_range"
                    message="Minimum 0 and maximum 1" min="0" max="1"/>
            </param>
            <param name="meth_cutoff" type="float"
                value="25" label="meth.cutoff"
                help="cutoff for absolute value of methylation percentage change between test and control (default:25)">
                <validator type="in_range"
                    message="Minimum 0 and maximum 100" min="0" max="100"/>
            </param>
            <param name="type" type="select"
                label="type"
                help="For retrieving
                hyper-methylated regions/bases type='hyper',
                for hypo-methylated type='hypo' (default:'all')">
                <option value="all" selected="True">
                    all
                </option>
                <option value="hyper">
                    hyper
                </option>
                <option value="hypo">
                    hypo
                </option>
            </param>
            <param name="dist" type="select"
                label="dist"
                help="the distance measure to be used.
                (default: correlation)">
                <option value="correlation" selected="True">
                    correlation
                </option>
                <option value="euclidean">
                    euclidean
                </option>
                <option value="maximum">
                    maximum
                </option>
                <option value="manhattan">
                    manhattan
                </option>
                <option value="canberra">
                    canberra
                </option>
                <option value="binary">
                    binary
                </option>
                <option value="minkowski">
                    minkowski
                </option>
                <option value="euclidean">
                    euclidean
                </option>
            </param>
            <param name="method" type="select"
                label="method"
                help="the agglomeration method to be used.
                (default: ward)">
                <option value="ward" selected="True">
                    ward
                </option>
                <option value="single">
                    single
                </option>
                <option value="complete">
                    complete
                </option>
                <option value="average">
                    average
                </option>
                <option value="mcquitty">
                    mcquitty
                </option>
                <option value="median">
                    median
                </option>
                <option value="centroid">
                    centroid
                </option>
            </param>
        </when>
        <when value="differential_methylation">
            <param name="overdispersion" type="select"
                label="overdispersion"
                help="if set to 'none' (default), no overdispersion
                correction will be attempted. 'MN' applies a scaling
                parameter to variance estimated by the model.
                If set to 'shrinkMN' (experimental parameter),
                scaling parameter will be shrunk towards a common value">
                <option value="none" selected="True">
                    none
                </option>
                <option value="MN">
                    MN
                </option>
                <option value="shrinkMN">
                    shrinkMN
                </option>
            </param>
            <param name="adjust" type="select"
                label="adjust"
                help="different methods to correct the p-values
                for multiple testing (default: SLIM).">
                <option value="SLIM" selected="True">
                    SLIM
                </option>
                <option value="holm">
                    holm
                </option>
                <option value="hochberg">
                    hochberg
                </option>
                <option value="hommel">
                    hommel
                </option>
                <option value="bonferroni">
                    bonferroni
                </option>
                <option value="BH">
                    BH
                </option>
                <option value="BY">
                    BY
                </option>
                <option value="fdr">
                    fdr
                </option>
                <option value="none">
                    none
                </option>
                <option value="qvalue">
                    qvalue
                </option>
            </param>
            <param name="effect" type="select"
                label="effect"
                help="method to calculate the mean methylation different
                between groups using read coverage as weights (default: wmean).
                When set to 'mean', the generic mean is applied and when
                set to 'predicted', predicted means from the logistic
                regression model is used for calculating the effect.">
                <option value="wmean" selected="True">
                    wmean
                </option>
                <option value="mean">
                    mean
                </option>
                <option value="predicted">
                    predicted
                </option>
            </param>
            <param name="test" type="select"
                label="test"
                help="the statistical test used to determine
                the methylation differences (default: Chisq-test).
                The F-test can be chosen
                if overdispersion control is applied.">
                <option value="Chisq" selected="True">
                    Chisq
                </option>
                <option value="F">
                    F
                </option>
            </param>
            <param name="qvalue_cutoff" type="float"
                value="0.01" label="qvalue.cutoff"
                help="cutoff for qvalue of differential methylation statistic (default:0.01)">
                <validator type="in_range"
                    message="Minimum 0 and maximum 1" min="0" max="1"/>
            </param>
            <param name="meth_cutoff" type="float"
                value="25" label="meth.cutoff"
                help="cutoff for absolute value of methylation percentage change between test and control (default:25)">
                <validator type="in_range"
                    message="Minimum 0 and maximum 100" min="0" max="100"/>
            </param>
            <param name="type" type="select"
                label="type"
                help="For retrieving
                hyper-methylated regions/bases type='hyper',
                for hypo-methylated type='hypo' (default:'all')">
                <option value="all" selected="True">
                    all
                </option>
                <option value="hyper">
                    hyper
                </option>
                <option value="hypo">
                    hypo
                </option>
            </param>
        </when>
        <when value="clustering">
            <param name="dist" type="select"
                label="dist"
                help="the distance measure to be used.
                (default: correlation)">
                <option value="correlation" selected="True">
                    correlation
                </option>
                <option value="euclidean">
                    euclidean
                </option>
                <option value="maximum">
                    maximum
                </option>
                <option value="manhattan">
                    manhattan
                </option>
                <option value="canberra">
                    canberra
                </option>
                <option value="binary">
                    binary
                </option>
                <option value="minkowski">
                    minkowski
                </option>
                <option value="euclidean">
                    euclidean
                </option>
            </param>
            <param name="method" type="select"
                label="method"
                help="the agglomeration method to be used.
                (default: ward)">
                <option value="ward" selected="True">
                    ward
                </option>
                <option value="single">
                    single
                </option>
                <option value="complete">
                    complete
                </option>
                <option value="average">
                    average
                </option>
                <option value="mcquitty">
                    mcquitty
                </option>
                <option value="median">
                    median
                </option>
                <option value="centroid">
                    centroid
                </option>
            </param>
        </when>
        <when value="segmentation" />
    </conditional>
  </inputs>

  <outputs>
      <data name="output_myDiff" format="bed"
      from_work_dir="output_myDiff.bed"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'differential_methylation']</filter>
      </data>

      <data name="output_MethPerChr" format="tsv"
      from_work_dir="output_MethPerChr.csv"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'differential_methylation']</filter>
      </data>

      <data name="output_MethylDiff" format="bed"
      from_work_dir="output_MethylDiff.bed"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'differential_methylation']</filter>
      </data>

      <data name="output_clustering" format="pdf"
      from_work_dir="output_clustering.pdf"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'clustering']</filter>
      </data>

      <data name="output_PCA" format="pdf"
      from_work_dir="output_PCA.pdf"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'clustering']</filter>
      </data>

      <data name="output_seg_raw" format="bed"
      from_work_dir="output_seg_raw.bed"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'segmentation']</filter>
      </data>

      <data name="output_seg_diff" format="bed"
      from_work_dir="output_seg_diff.bed"
      label="${tool.name} on ${on_string}: ">
      <filter>input_type['choice'] in ['all', 'segmentation']</filter>
      </data>
  </outputs>

  <tests>
    <test>
        <repeat name="test_series">
            <param name="input" value="input_test1.myCpG.txt" ftype="txt" />
        </repeat>
        <repeat name="test_series">
            <param name="input" value="input_test2.myCpG.txt" ftype="txt" />
        </repeat>
        <repeat name="control_series">
            <param name="input" value="input_control1.myCpG.txt" ftype="txt" />
        </repeat>
        <repeat name="control_series">
            <param name="input" value="input_control2.myCpG.txt" ftype="txt" />
        </repeat>
        <param name="assembly" value="hg18" />
        <param name="pipeline" value="amp" />
        <param name="choice" value="all" />
        <param name="overdispersion" value="none" />
        <param name="adjust" value="SLIM" />
        <param name="effect" value="wmean" />
        <param name="test" value="Chisq" />
        <param name="qvalue_cutoff" value="0.01" />
        <param name="meth_cutoff" value="25" />
        <param name="type" value="all" />
        <param name="dist" value="correlation" />
        <param name="method" value="ward" />
        <output name="output_myDiff" file="output_myDiff.bed"
        ftype="bed"/>
        <output name="output_MethPerChr" file="output_MethPerChr.csv"
        ftype="tsv"/>
        <output name="output_MethylDiff" file="output_MethylDiff.bed"
        ftype="bed"/>
        <output name="output_clustering" file="output_clustering.pdf"
        ftype="pdf"/>
        <output name="output_PCA" file="output_PCA.pdf"
        ftype="pdf"/>
        <output name="output_seg_raw" file="output_seg_raw.bed"
        ftype="bed"/>
        <output name="output_seg_diff" file="output_seg_diff.bed"
        ftype="bed"/>
    </test>
  </tests>
<help>

</help>
<citations>
    <citation type="doi">10.1186/gb-2012-13-10-r87</citation>
</citations>
</tool>
