<tool id="3dtrees_py3dtiles" name="3Dtrees: Py3DTiles Converter" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.2">
    <description>Convert LAS/LAZ collection to Cesium 3D points_tiles</description>
    <macros>
        <token name="@TOOL_VERSION@">1.1.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <container type="docker">ghcr.io/3dtrees-earth/3dtrees_py3dtiles:@TOOL_VERSION@</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        export NUMBA_CACHE_DIR=\$TMPDIR &&
        mkdir -p input_files &&
        mkdir -p tiles_output &&
        #for $f in $input
            ln -s '$f' input_files/'${f.element_identifier}.laz' &&
        #end for
        python /src/run.py
        --input input_files
        --output-dir tiles_output
        #if $extra_fields
            --extra-fields '$extra_fields'
        #end if
        #if $srs_out
            --srs-out '$srs_out'
        #end if
        #if $overwrite
            --overwrite
        #end if
        2>&1
        ]]>
    </command>
    <inputs>
        <param name="input" type="data_collection" collection_type="list" format="laz" label="Point Cloud Collection" help="Collection of LAZ/LAS files to merge and convert to 3D Tiles" />
        <param name="extra_fields" type="text" optional="true" label="Extra Fields" help="Comma-separated list of extra fields to include in tiles (e.g., 'PredInstance' for segmentation visualization). Leave empty to include only standard fields." />
        <param name="srs_out" type="text" value="4978" label="Output CRS (EPSG code)" help="Output coordinate reference system. Default is 4978 (ECEF) for proper Cesium visualization. Leave empty to preserve original CRS." />        
        <param name="overwrite" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Overwrite existing output" help="Clear output directory before conversion if it already contains files" />
    </inputs>
    <outputs>
        <data name="tileset_json" format="json" label="tileset" from_work_dir="tiles_output/tileset.json"/>
        <data name="preview_pnts" format="pnts" label="preview" from_work_dir="tiles_output/preview.pnts"/>
        <collection name="points_tiles" type="list" label="points">
            <discover_datasets pattern="(?P&lt;designation&gt;r.*)\.pnts" directory="tiles_output" recurse="true" visible="false" format="pnts"/>
        </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="3">
            <param name="input">
                <collection type="list">
                    <element name="mikro.laz" value="mikro.laz"/>
                </collection>
            </param>
            <param name="srs_out" value="4978"/>
            <output name="tileset_json" ftype="json" compare="contains">
                <assert_contents>
                    <has_text text="root"/>
                    <has_text text="boundingVolume"/>
                    <has_text text="asset"/>
                    <has_text text="version"/>
                    <has_text text="geometricError"/>
                </assert_contents>
            </output>
            <output_collection name="points_tiles" type="list" min="1"/>
        </test>
    </tests>
    <help>

**What it does**

This tool converts a collection of LAS/LAZ point cloud files to a single Cesium 3D Tiles tileset using py3dtiles. 

**Key features:**

1. **Memory-efficient merging**: Uses streaming to merge multiple files with constant memory (~50MB) regardless of total dataset size
2. **Custom attributes**: Supports extra point attributes like PredInstance for segmentation visualization
3. **Automatic CRS transformation**: Transforms to ECEF (EPSG:4978) for proper Cesium visualization
4. **Out-of-core processing**: py3dtiles handles large merged files efficiently

-----

**Input**

- **Point Cloud Collection**: Collection of LAZ/LAS files (e.g., segmented outputs from the merge step)
- **Extra Fields**: Optional comma-separated list of extra point attributes to include (e.g., "PredInstance" for instance segmentation)
- **Output CRS**: EPSG code for output coordinates (default: 4978 for ECEF). Leave empty to keep original coordinates.
- **Overwrite**: Clear output directory before conversion

-----

**Output**

- **tileset.json**: The main tileset metadata file
- **preview.pnts**: Preview tile for quick loading
- **points collection**: All tile files (.pnts format) containing the point cloud data

The output can be directly hosted on a web server and visualized using CesiumJS.

-----

**Workflow Integration**

In the EndToEndPipeline workflow, this tool receives the segmented LAZ collection from the merge step and produces a single unified 3D Tiles tileset for the entire dataset.

    </help>
    <creator>
        <organization name="3Dtrees-Team, University of Freiburg" url="https://github.com/3dTrees-earth"/>
    </creator>
    <citations>
        <citation type="bibtex">@misc{py3dtiles, title = {Py3DTiles: Python library for 3D Tiles}, author = {py3dtiles Contributors}, year = {2024}, url = {https://gitlab.com/py3dtiles/py3dtiles}}</citation>
        <citation type="bibtex">
            @misc{3dtrees_py3dtiles, title = {3Dtrees: Py3DTiles}, author = {3Dtrees-Project}, year = {2025}}
        </citation>
    </citations>
</tool>
