<tool id="merge_files_on_column_fuzzy" name="Merge two files" version="1.0.0">
    <description>
        on column allowing a small difference
    </description>
    <requirements>
        <requirement type="package" version="3.6">python</requirement> 
    </requirements>
    <command>
    <![CDATA[
python '$__tool_directory__/merge_files_on_column_fuzzy.py'
--f1 '$f1'
--f2 '$f2'
--c1 $c1
--c2 $c2
--outfile '$merged_file'
$header
$add_distance
#if $merge_mode.merge_mode_select == 'closest':
    --closest
#else:
    --distance $merge_mode.distance
    --unit $merge_mode.units
#end if
    ]]>
    </command>
    <inputs>
        <param argument="--f1" type="data" optional="true" format="tabular" label="Tab separated file with values for matching in first column"
            help="file can have more columns but first column should have the values of interest"/>
        <param argument="--f2" type="data" optional="true" format="tabular" label="Tab separated file with values to which values in first files will be matched"
            help="file can have more columns but first column should contain values of interest"/>

        <param argument="--c1" type="data_column" data_ref="f1" label="Column from file one"/>
        <param argument="--c2" type="data_column" data_ref="f2" label="Column from file two"/>

        <param argument="--header" type="boolean" checked="false" truevalue="--header" falsevalue="" label="Does the input files contain a header line" />
        <param argument="--add_distance" type="boolean" checked="false" truevalue="--add_distance" falsevalue="" label="Add an addional column with the calculated distance." />

        <conditional name="merge_mode">
            <param name="merge_mode_select" type="select" label="Choose the mode of merging.">
                <option value="closest" selected="True">Best match (in case of multiple best matches, only the first one is reported)</option>
                <option value="distance">Matching with a defined distance</option>
            </param>
            <when value="closest"/>
            <when value="distance">
                <param name="units" display="radio" type="select" value="ppm_value" label="Choose the metrics of your distance"
                    help="ppm is useful for very small differences">
                        <option value="absolute" selected="True">Absolute distance</option>
                        <option value="ppm" >Distance in ppm</option>
                </param>
                <param name="distance" value="0.2" type="float" label="Allowed distance between the two values that will trigger a merge" help=""/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="merged_file" format="tabular" />
    </outputs>

    <tests>
        <test>
            <param name="f1" value="file1.tab" ftype="tabular"/>
            <param name="f2" value="file2.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="merge_mode_select" value="distance"/>
            <param name="distance" value="0.1"/>
            <param name="units" value="absolute"/>
            <output name="merged_file" file="no_header_result1.tab" />
        </test>
        <test>
            <param name="f1" value="file1_header.tab" ftype="tabular"/>
            <param name="f2" value="file2_header.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="merge_mode_select" value="distance"/>
            <param name="distance" value="0.2"/>
            <param name="units" value="absolute"/>
            <param name="header" value="true"/>
            <output name="merged_file" file="header_result2.tab" />
        </test>
        <test>
            <param name="f1" value="file1_header.tab" ftype="tabular"/>
            <param name="f2" value="file2_header.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="header" value="true"/>
            <param name="closest" value="true"/>
            <output name="merged_file" file="header_closest_result3.tab" />
        </test>
        <test>
            <param name="f1" value="file1_ppm.tab" ftype="tabular"/>
            <param name="f2" value="file2_ppm.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="header" value="false"/>
            <param name="merge_mode_select" value="distance"/>
            <param name="distance" value="100"/>
            <param name="units" value="ppm"/>
            <output name="merged_file" file="no_header_ppm_result4.tab" />
        </test>
        <test>
            <param name="f1" value="file1_header.tab" ftype="tabular"/>
            <param name="f2" value="file2_header.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="header" value="true"/>
            <param name="closest" value="true"/>
            <param name="add_distance" value="true"/>
            <output name="merged_file" file="header_closest_result5.tab" />
        </test>
        <test>
            <param name="f1" value="file1_ppm.tab" ftype="tabular"/>
            <param name="f2" value="file2_ppm.tab" ftype="tabular"/>
            <param name="c1" value="1"/>
            <param name="c2" value="1"/>
            <param name="header" value="false"/>
            <param name="merge_mode_select" value="distance"/>
            <param name="distance" value="100"/>
            <param name="units" value="ppm"/>
            <param name="add_distance" value="true"/>
            <output name="merged_file" file="no_header_ppm_result6.tab" />
        </test>
    </tests>

    <help>

        <![CDATA[

This tool matches the closest values of two files together. The two input files should be tab separated with the values to compare and match in the first column. The second file should have at least another column, for example with the description of the values in column 1. The first file with the input values, can have more columns but this will be removed during matching.

When best match per input value is used, for each input value only the best outputvalue is given. In case there are multiple values which match, the last one in the list of potential matching values is taken. 

The "matching with filter criteria" option allows to get back all values which match with a certain criteria to the input values. Criteria can be the maximum absolute difference or the maximum difference in ppm. 

The output file contains the input values in the first column, then the matched values from the second file in the second column. The absolute difference and the ppm difference are in column 3 and 4. Then all columns , except the first column, from the second file are kept.

        ]]>
    </help>
    <citations>
    </citations>
</tool>

