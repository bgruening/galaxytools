<tool id="kmetashot" name="kMetaShot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>an alignment-free taxonomic classifier based on k-mer/minimizer counting</description>
    <macros>
        <token name="@TOOL_VERSION@">2.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@PROFILE@">25.0</token>
    </macros>
    <xrefs>
        <xref type="bio.tools">kmetashot</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">kmetashot</requirement>
    </requirements>
    <command detect_errors="exit_code">
    <![CDATA[

        mkdir -p output bins &&

        #if $fasta_input.input_type == "collection":
            #for $file in $fasta_input.bins_dir:
                ln -s '$file' 'bins/$file.element_identifier.$file.extension' &&
            #end for
        #else:
            ln -s '$fasta_input.contigs_file' 'bins/$fasta_input.contigs_file.element_identifier.$fasta_input.contigs_file.extension' &&
        #end if

        ls -la bins &&

        kMetaShot_classifier_NV.py
        #if $fasta_input.input_type == "collection":
            -b bins
        #else:
            -b 'bins/$fasta_input.contigs_file.element_identifier.$fasta_input.contigs_file.extension'
        #end if
            -o output 
            -r '$reference.fields.path' 
            -p \${GALAXY_SLOTS:-4}
            -a ${ass2ref}
    ]]>
    </command>
    <inputs>
        <conditional name="fasta_input">
            <param name="input_type"
                type="select"
                label="Input type">
                <option value="mags">Bin(s)/MAG(s)</option>
                <option value="contigs">Contigs/long reads FASTA(s)</option>
            </param>

            <when value="mags">
                <param name="bins_dir"
                    type="data_collection"
                    collection_type="list"
                    format="fasta,fasta.gz"
                    label="Bin(s)/MAG(s) FASTA file(s)"
                    help="Collection of FASTA files that are analyzed as bin(s)/MAG(s)"/>
            </when>

            <when value="contigs">
                <param name="contigs_file"
                    type="data"
                    format="fasta,fasta.gz"
                    label="Contigs fasta file"
                    help="FASTA file containing contigs or long reads (Better if >= 1kbp. You can also create a collection of FASTA files that can be classified as contigs/long reads."/>
            </when>
        </conditional> 
        <param argument="reference" type="select" label="Select a reference database.">
            <options from_data_table="kmetashot">
                <filter type="sort_by" column="2"/>
            </options>
            <validator type="no_options" message="No reference data for kMetaShot is installed. Please contact the Galaxy adminstrators to request one be installed."/>
        </param>
        <param argument="ass2ref" type="float" min="0.0"
               value="0.0" max="1.0"
               label="Set ass2ref parameter"
               help="Ass2ref is a ratio between the number of MAG minimizers and the reference minimizers. It is a reliability index for strain classification only. Strain and Species classification for MAGs with ass2ref \&lt;= user set threshold are zeroed"/>
    </inputs>
    <outputs>
        <data name="result_ass2ref_0"
            format="csv"
            label="${tool.name} on ${on_string}: Taxonomic Classification"
            from_work_dir="output/kMetaShot_classification_resume.csv" />
        <data name="result_ass2ref_not_0"
              format="csv"
              label="${tool.name} on ${on_string} with ass2ref ${ass2ref}: Taxonomic Classification"
              from_work_dir="output/kMetaShot_classification_resume_a2r*.csv">
            <filter>ass2ref != 0.0</filter>
        </data>
    </outputs>
    <tests>

        <!-- The tool needs a 20 gb ref. DB and at leatst 40gb memory, so tests
        need to be done locally -->
        <test expect_num_outputs="2">
            <conditional name="fasta_input">
                <param name="input_type" value="contigs"/>
                <param name="contigs_file" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            </conditional>
            <param name="ass2ref" value="0.2"/>
            <param name="reference" value="25-05-22"/>
            <output name="result_ass2ref_0" file="kMetaShot_classification_resume.csv" compare="sim_size"/>
            <output name="result_ass2ref_not_0" file="kMetaShot_classification_resume_a2r20.csv" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <conditional name="fasta_input">
                <param name="input_type" value="contigs"/>
                <param name="contigs_file" value="all_contig.fasta.gz" ftype="fasta.gz"/>
            </conditional>
            <param name="ass2ref" value="0.0"/>
            <param name="reference" value="25-05-22"/>
            <output name="result_ass2ref_0" file="kMetaShot_classification_resume.csv" compare="sim_size"/>
        </test>
    </tests>
    <help>
        <![CDATA[
        
            This tool is an alignment free taxonomic classifier for MAGs and/or contigs/long reads. It is suggested to use contigs mode classification for sequences longer than 1kbp.

            **Input**

            ***Bin(s)/MAG(s) classification***

            Select 'Bin(s)/MAG(s)' and create a file collection with one or more fasta/fasta.gz files (.fa, .fasta, .fna, .fa.gz, .fasta.gz, .fna.gz are allowed extensions)

            ***Contigs/long reads FASTA(s) classification***

            In this way each sequence in the FASTA file can be classified by kMetaShot. Select 'Contigs/long reads FASTA' file (.fa, .fasta, .fna, .fa.gz, .fasta.gz, .fna.gz are allowed extensions). It is possible to create collection of FASTA files and classify them as contigs/long reads.

            ***Ass2ref***

            Classification filter based on ass2ref parameter ranging between 0 and 1. Default 0. Ass2ref is a ratio between the number of MAG minimizers and the reference minimizers related to the assigned strain.

            **Reference**

            The reference data needed for this tool is provided from a data manager which always installed the latest version of the data

            **Output**

            The Output is a csv file(s) which contained the classification for the inputted bin(s)/MAG(s). In case ass2ref=0 you have only one output. In case ass2ref>0 you have two output, one for ass2ref=0 and one for ass2ref>0.

        ]]>
    </help>  
    <citations>
        <citation type="doi">10.1093/bib/bbae680</citation>
    </citations>
</tool>
