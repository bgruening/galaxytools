<tool id="bioimage_inference" name="Process image using model from BioImage Model Zoo" version="0.0.5">
    <description>with PyTorch</description>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">pytorch</xref>
        <xref type="biii">pytorch</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="3.9.12">python</requirement>
        <requirement type="package" version="2.1.2">pytorch</requirement>
        <requirement type="package" version="0.16.1">torchvision</requirement>
	<requirement type="package" version="3.0.8">cython</requirement>
	<requirement type="package" version="4.10.0">opencv</requirement>
	<requirement type="package" version="2.34.2">imageio</requirement>
	<requirement type="package" version="0.6.8">bioimageio.core</requirement>
    </requirements>
    <version_command>echo "@VERSION@"</version_command>
    <command detect_errors="aggressive">
<![CDATA[
        python '$__tool_directory__/main.py'

            --imaging_model '$input_imaging_model'
            --image_file '$input_image_file'
            --image_file_npy '$input_image_file_matrix'

]]>
    </command>
    <inputs>
        <param name="input_imaging_model" type="data" format="zip" label="BioImage model" help="Please load a BioImage model from file uploader"/>
	<param name="input_image_file" type="data" format="tiff" label="Image to be analysed" help="Please provide an image"/>
	<param name="input_image_file_matrix" type="data" format="npy" label="Image to be analysed" help="Please provide an image"/>

    </inputs>
    <outputs>
	<data format="png" name="output_predicted_image" from_work_dir="output_predicted_image.png" label="Predicted image"></data>
	<data format="npz" name="output_predicted_image_matrix" from_work_dir="output_predicted_image_matrix.npz" label="Predicted image matrix"></data>
    </outputs>
    <tests>
	<test>
	    <param name="input_imaging_model" value="input_imaging_model.zip" location="https://zenodo.org/api/records/6647674/files/weights-torchscript.pt/content"/>
	    <param name="input_image_file" value="input_image_file.npz" location="https://zenodo.org/api/records/6647674/files/test_input_0.npy/content"/>
	    <output name="output_predicted_image" file="output_nucleisegboundarymodel.png" compare="sim_size" delta="100" />
	    <output name="output_predicted_image_matrix" file="output_nucleisegboundarymodel_matrix.npz" compare="sim_size" delta="100" />
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**

The tool takes a BioImage model and an image to be analysed. Model makes a prediction and the predicted image becomes available as a PNG file.

**Description**
The tool takes a BioImage model and an image to be analysed. Model makes a prediction and the predicted image becomes available as a PNG file.

**Input files**
	- BioImage model: Add one of the model from Galaxy file uploader by choosing a "femote" file at "ML Models/bioimaging-models"
	- Image to be analysed: Pass an image in NPZ format

**Output file**
        - Predicted image: Predicted image using the Bioimage model
        - Predicted image matrix: Predicted image matrix in original dimensions
        ]]>
    </help>
    <citations>
        <citation type="bibtex">
            @ARTICLE{anuprulez_galaxytools,
                Author = {Anup Kumar and Beatriz Serrano-Solano and Björn Grüning},
                keywords = {imaging, deep learning},
                title = {{Inference using BioImage models}},
                url = {https://github.com/bgruening/galaxytools}
            }
        </citation>
    </citations>
</tool>
