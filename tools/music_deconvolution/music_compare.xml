<tool id="music_compare" name="MuSiC Compare" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@"
      profile="21.09" license="GPL-3.0-or-later" >
    <description>estimate cell type proportions in multiple bulk RNA-seq datasets</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code" ><![CDATA[
mkdir report_data &&
## Rscript --vanilla '$__tool_directory__/scripts/compare.R' '$conf'
cat '$conf'
]]></command>
    <configfiles>
        <configfile name="conf" >
null_str_vec = function(gstr){
   tokens = unlist(as.vector(strsplit(gstr, split=",")))
   if (length(tokens) == 0){
      return(NULL)
   }
   if (length(tokens) == 1){
      return(tokens[[1]])
   }
   return(tokens)
}

files = list(
#for $s, $scgroup in enumerate($scrna_groups):
    '$scgroup.name' = list(
        dataset = '$scgroup.scrna_eset',
        label_cell = '$scgroup.celltypes_label',
        label_sample = '$scgroup.samples_label',
        celltype = '$scgroup.celltypes',
        bulk = list(
    #for $b, $bulkgroup in enumerate($scgroup.bulk_groups):
            '$bulkgroup.name' = list(
                dataset = "$bulkgroup.bulk_eset",
                pheno_facts = "$bulkgroup.phenotype_factors",
                pheno_excl = "$bulkgroup.phenotype_factors_always_exclude"
        #if $b &lt; len($scgroup.bulk_groups) - 1:
            ),
        #else
            )
        #end if
    #end for
    #if $s &lt; len($scrna_groups) - 1:
        )
    ),
    #else
        )
    )
    #end if
#end for
)


        </configfile>
    </configfiles>
    <inputs>
        <!-- Define single cell groups for sets of bulk datasets -->
        <repeat name="scrna_groups" title="New scRNA Group"
                help="Cell type proportion comparisons are performed between bulk datasets
                      in each scRNA group. A second summary is performed comparing all cell
                      type proportions across all groups." >
            <!-- Single Cell Options -->
            <param name="name" label="Name of scRNA Dataset" type="text" value="" />
            <param name="scrna_eset" label="scRNA Dataset" type="data" format="@RDATATYPE@" />
            <param name="celltypes_label" type="text" value="cellType"
                   label="Cell Types Label from scRNA dataset" >
                <expand macro="validator_text" />
            </param>
            <param name="samples_label" type="text" value="sampleID"
                   label="Samples Identifier from scRNA dataset" >
                <expand macro="validator_text" />
            </param>
            <expand macro="celltypes_macro" />
            <repeat name="bulk_groups" title="Bulk Datasets in scRNA Group"
                    help="Choose bulk RNA datasets" >
                <!-- Bulk Options -->
                <param name="name" label="Name of Bulk Dataset" type="text" value="" />                
                <param name="bulk_eset" label="Bulk RNA Dataset" type="data" format="@RDATATYPE@" />
                <param name="phenotype_factors" type="text"
                       label="Phenotype factors"
                       help="List of phenotypes factors to be used in the linear regression. Please make sure that each factor has more than one unique value. Names correspond to column names in the bulk RNA dataset phenotype table. If blank, then treat all bulk phenotype columns as factors." >
                    <expand macro="validator_index_identifiers" />
                </param>
                <param name="phenotype_factors_always_exclude" type="text"
                       label="Excluded phenotype factors"
                       help="List of phenotype factors to always exclude in the analysis"
                       value="sampleID,SubjectName" >
                    <expand macro="validator_index_identifiers" />
                </param>
            </repeat>
        </repeat>
        <param name="est_methods" type="select" label="Method to use" help="One to compare across all" >
            <option value="MuSiC" selected="true" >MuSiC</option>
            <option value="NNLS" selected="true" >NNLS</option>
        </param>
    </inputs>
    <outputs>
        <data name="out_pdf" format="pdf" label="${tool.name} on ${on_string}: PDF Plots" />
        <data name="out_tab" format="tabular" label="${tool.name} on ${on_string}: Cell Proportions by Sample" >
            <filter>do["method"] == "dendrogram" and len(do["cluster_groups"]) >0</filter>
        </data>
        <collection name="props" type="list" label="${tool.name} on ${on_string}: Proportion Matrices" >
            <filter>do["method"] == "estimateprops"</filter>
            <discover_datasets pattern="prop_(?P&lt;designation&gt;.+)\.tabular" format="tabular" directory="report_data" />
        </collection>
        <collection name="summaries" type="list" label="${tool.name} on ${on_string}: Summaries and Logs">
            <filter>do["method"] == "estimateprops" and do["disease_factor"]["use"] == "yes"</filter>
            <discover_datasets pattern="summ_(?P&lt;designation&gt;.+)\.txt" format="txt" directory="report_data" />
            <discover_datasets pattern="varprop_(?P&lt;designation&gt;.+)\.tabular" format="tabular" directory="report_data" />
            <discover_datasets pattern="rsquared_(?P&lt;designation&gt;.+)\.tabular" format="tabular" directory="report_data" />
            <discover_datasets pattern="weightgene_(?P&lt;designation&gt;.+)\.tabular" format="tabular" directory="report_data" />
        </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="1" >
            <!-- Dendrogram test 1 -->
            <param name="bulk_eset" value="Mousebulkeset.rds" />
            <param name="scrna_eset" value="Mousesubeset.degenesonly2.half.rds" />
            <conditional name="do" >
                <param name="method" value="dendrogram" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="celltypes" value="Endo,Podo,PT,LOH,DCT,CD-PC,CD-IC,Fib,Macro,Neutro,B lymph,T lymph,NK" />
            </conditional>
            <output name="out_pdf" value="dendro_1.pdf" compare="sim_size" />
        </test>
        <test expect_num_outputs="2" >
            <!-- Dendrogram test 2 -->
            <param name="bulk_eset" value="Mousebulkeset.rds" />
            <param name="scrna_eset" value="Mousesubeset.degenesonly2.half.rds" />
            <conditional name="do" >
                <param name="method" value="dendrogram" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="celltypes" value="Endo,Podo,PT,LOH,DCT,CD-PC,CD-IC,Fib,Macro,Neutro,B lymph,T lymph,NK" />
                <repeat name="cluster_groups" >
                    <param name="cluster_id" value="C1" />
                    <param name="celltypes" value="Neutro" />
                </repeat>
                <repeat name="cluster_groups" >
                    <param name="cluster_id" value="C2" />
                    <param name="celltypes" value="Podo" />
                </repeat>
                <repeat name="cluster_groups" >
                    <param name="cluster_id" value="C3" />
                    <param name="celltypes" value="Endo,CD-PC,LOH,CD-IC,DCT,PT" />
                    <param name="marker_name" value="Epithelial" />
                    <param name="marker_list" value="epith.markers" />
                </repeat>
                <repeat name="cluster_groups" >
                    <param name="cluster_id" value="C4" />
                    <param name="celltypes" value="Macro,Fib,B lymph,NK,T lymph" />
                    <param name="marker_name" value="Immune" />
                    <param name="marker_list" value="immune.markers" />
                </repeat>
            </conditional>
            <output name="out_pdf" value="dendro.pdf" compare="sim_size" />
            <output name="out_tab">
                <assert_contents>
                    <has_text_matching expression="^\s+Neutro\s+Podo\s+Endo" />
                    <has_text text="APOL1.GNA78M"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="2" >
            <!-- Estimate Proportions: no disease factor, no fitting reports, only NNLS -->
            <param name="bulk_eset" value="GSE50244bulkeset.subset.rds" />
            <param name="scrna_eset" value="EMTABesethealthy.subset.rds" />
            <conditional name="do" >
                <param name="method" value="estimateprops" />
                <param name="est_methods" value="NNLS" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="disease_factor" value="no" />
            </conditional>
            <output name="out_pdf" value="default_output_no_disease_nnls.pdf" compare="sim_size" />
        </test>
        <test expect_num_outputs="2" >
            <!-- Estimate Proportions: no disease factor, no fitting reports -->
            <param name="bulk_eset" value="GSE50244bulkeset.subset.rds" />
            <param name="scrna_eset" value="EMTABesethealthy.subset.rds" />
            <conditional name="do" >
                <param name="method" value="estimateprops" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="disease_factor" value="no" />
            </conditional>
            <output name="out_pdf" value="default_output_no_disease.pdf" compare="sim_size" />
        </test>
        <test expect_num_outputs="3" >
            <!-- Estimate Proportions test -->
            <param name="bulk_eset" value="GSE50244bulkeset.subset.rds" />
            <param name="scrna_eset" value="EMTABesethealthy.subset.rds" />
            <conditional name="do" >
                <param name="method" value="estimateprops" />
                <param name="celltypes_label" value="cellType" />
                <param name="samples_label" value="sampleID" />
                <param name="celltypes" value="alpha,beta,delta,gamma,acinar,ductal" />
                <conditional name="disease_factor" >
                    <param name="use" value="yes" />
                    <param name="phenotype_scrna_target" value="beta" />
                    <param name="phenotype_factors" value="age,bmi,hba1c,gender" />
                    <param name="phenotype_target" value="hba1c" />
                    <param name="phenotype_target_threshold" value="6.5" />
                    <param name="sample_disease_group" value="T2D" />
                    <param name="sample_disease_group_scale" value="5" />
                </conditional>
            </conditional>
            <output name="out_pdf" value="default_output.pdf" compare="sim_size" />
            <output_collection name="summaries" count="5">
                <element name="Log of MuSiC fitting" ftype="txt">
                    <assert_contents>
                        <has_text text="Residual standard error: 0.1704 on 72 degrees of freedom"/>
                    </assert_contents>
                </element>
                <element name="Log of NNLS fitting" ftype="txt">
                    <assert_contents>
                        <has_text text="Residual standard error: 0.0645 on 72 degrees of freedom"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
MuSiC utilizes cell-type specific gene expression from single-cell RNA sequencing (RNA-seq) data to characterize cell type compositions from bulk RNA-seq data in complex tissues. By appropriate weighting of genes showing cross-subject and cross-cell consistency, MuSiC enables the transfer of cell type-specific gene expression information from one dataset to another.

Solid tissues often contain closely related cell types which leads to collinearity. To deal with collinearity, MuSiC employs a tree-guided procedure that recursively zooms in on closely related cell types. Briefly, we first group similar cell types into the same cluster and estimate cluster proportions, then recursively repeat this procedure within each cluster.

    ]]></help>
    <citations>
        <citation type="doi">https://doi.org/10.1038/s41467-018-08023-x</citation>
    </citations>
</tool>