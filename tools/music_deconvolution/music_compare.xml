<tool id="music_compare" name="MuSiC Compare" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@"
      profile="21.09" license="GPL-3.0-or-later" >
    <description>estimate cell type proportions in multiple bulk RNA-seq datasets</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code" ><![CDATA[
Rscript --vanilla '$__tool_directory__/scripts/compare.R' '$conf'
]]></command>
    <configfiles>
        <configfile name="conf" >
null_str_vec = function(gstr){
   tokens = unlist(as.vector(strsplit(gstr, split=",")))
   if (length(tokens) == 0){
      return(NULL)
   }
   if (length(tokens) == 1){
      return(tokens[[1]])
   }
   return(tokens)
}

files = list(
#for $s, $scgroup in enumerate($scrna_groups):
    '$scgroup.name' = list(
        dataset = '$scgroup.scrna_eset',
        label_cell = null_str_vec('$scgroup.adv.celltypes_label'),
        label_sample = null_str_vec('$scgroup.adv.samples_label'),
        celltype = null_str_vec('$scgroup.adv.celltypes'),
        bulk = list(
    #for $b, $bulkgroup in enumerate($scgroup.bulk_groups):
            '$bulkgroup.name' = list(
                dataset = null_str_vec('$bulkgroup.bulk_eset'),
                factor_group = null_str_vec('$bulkgroup.factor_group'),
                pheno_facts = null_str_vec('$bulkgroup.adv.phenotype_factors'),
                pheno_excl = null_str_vec('$bulkgroup.adv.phenotype_factors_always_exclude')
        #if $b &lt; len($scgroup.bulk_groups) - 1:
            ),
        #else
            )
        #end if
    #end for
    #if $s &lt; len($scrna_groups) - 1:
        )
    ),
    #else
        )
    )
    #end if
#end for
)

heat_grouped_p = as.logical('$heat_grouped_p')
out_filt = list(cells = null_str_vec('$filter.out_list_cells'),
                facts = null_str_vec('$filter.out_list_facts'))
est_method = null_str_vec('$est_method')

out_heatmulti_pdf = '$out_heatmulti_pdf'
out_heatsumm_pdf = '$out_heatsumm_pdf'
        </configfile>
    </configfiles>
    <inputs>
        <!-- Define single cell groups for sets of bulk datasets -->
        <repeat name="scrna_groups" title="New scRNA Group"
                help="Cell type proportion comparisons are performed between bulk datasets
                      in each scRNA group. A second summary is performed comparing all cell
                      type proportions across all groups." >
            <!-- Single Cell Options -->
            <param name="name" label="Name of scRNA Dataset" type="text" value="" />
            <param name="scrna_eset" label="scRNA Dataset" type="data" format="@RDATATYPE@" />
            <section name="adv" title="Advanced scRNA Parameters" >
                <param name="celltypes_label" type="text" value="cellType"
                       label="Cell Types Label from scRNA dataset" >
                    <expand macro="validator_text" />
                </param>
                <param name="samples_label" type="text" value="sampleID"
                       label="Samples Identifier from scRNA dataset" >
                    <expand macro="validator_text" />
                </param>
                <expand macro="celltypes_macro" />
            </section>
            <repeat name="bulk_groups" title="Bulk Datasets in scRNA Group"
                    help="Choose bulk RNA datasets" >
                <!-- Bulk Options -->
                <param name="name" label="Name of Bulk Dataset" type="text" value="" />                
                <param name="bulk_eset" label="Bulk RNA Dataset" type="data" format="@RDATATYPE@" />
                <param name="factor_group" type="text" label="Factor Name" optional="false"
                       help="Name of column in phenotype data containing factor values. If column does not exist, it is a new factor that is applied to all samples in the dataset. Plots will be coloured by these factors." />
                <section name="adv" title="Advanced Bulk Parameters" >
                    <param name="phenotype_factors" type="text"
                           label="Phenotype factors"
                           help="List of phenotypes factors to be used in the linear regression. Please make sure that each factor has more than one unique value. Names correspond to column names in the bulk RNA dataset phenotype table. If blank, then treat all bulk phenotype columns as factors." >
                        <expand macro="validator_index_identifiers" />
                    </param>
                    <param name="phenotype_factors_always_exclude" type="text"
                           label="Excluded phenotype factors"
                           help="List of phenotype factors to always exclude in the analysis"
                           value="sampleID,SubjectName" >
                        <expand macro="validator_index_identifiers" />
                    </param>
                </section>
            </repeat>
        </repeat>
        <param name="est_method" type="select" label="Method to use" help="One to compare across all" >
            <option value="MuSiC" selected="true" >MuSiC</option>
            <option value="NNLS" selected="true" >NNLS</option>
        </param>
        <param name="heat_grouped_p" type="boolean" label="Individual heatmaps grouped by scRNA dataset?" checked="true" />
        <section name="filter" title="Filtering" >
            <param name="out_list_cells" type="text" label="Show only these cell types (blank for all)"
                   help="Comma-delimited list. Cell types given in the above scRNA datasets are still used for deconvolution (bulk reads are still assigned to discrete cell types), but we merely select the ones we want to show." />
            <param name="out_list_facts" type="text" label="Show only these factors (blank for all)"
                   help="Comma-delimited list. Factors must exist in those inferred from the above bulk datasets." />
        </section>
    </inputs>
    <outputs>
        <data name="out_heatmulti_pdf" format="pdf" label="${tool.name} on ${on_string}: Individual Heatmaps (${est_method})" />
        <data name="out_heatsumm_pdf" format="pdf" label="${tool.name} on ${on_string}: Summarized Heatmaps (${est_method})" />
    </outputs>
    <tests>
    </tests>
    <help><![CDATA[
MuSiC utilizes cell-type specific gene expression from single-cell RNA sequencing (RNA-seq) data to characterize cell type compositions from bulk RNA-seq data in complex tissues. By appropriate weighting of genes showing cross-subject and cross-cell consistency, MuSiC enables the transfer of cell type-specific gene expression information from one dataset to another.

Solid tissues often contain closely related cell types which leads to collinearity. To deal with collinearity, MuSiC employs a tree-guided procedure that recursively zooms in on closely related cell types. Briefly, we first group similar cell types into the same cluster and estimate cluster proportions, then recursively repeat this procedure within each cluster.

    ]]></help>
    <citations>
        <citation type="doi">https://doi.org/10.1038/s41467-018-08023-x</citation>
    </citations>
</tool>