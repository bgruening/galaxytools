<tool id="glob_report" name="Report_Results" version="0.1">
   <!--parallelism method="multi" split_inputs="input1" split_mode="to_size" split_size="10" shared_inputs="" merge_outputs="output1, output2"></parallelism-->

   <requirements>
       <requirement type="package" version='0.5'>perl-array-utils</requirement>
   </requirements>

    <stdio>
        <exit_code range="1:" />
    </stdio>
    <command>
        <![CDATA[


      ##  cp ~/galaxytools/tools/EteriTools/CollectResults/glob_res.pl ./ &&
      ##  cp ~/galaxytools/tools/EteriTools/CollectResults/gc_res.pl ./ &&
      ##  cp -r ~/galaxytools/tools/EteriTools/CollectResults/Array ./ &&
      ##  cp -r ~/galaxytools/tools/EteriTools/CollectResults/evaluation.py ./ &&

        unzip $FASTA  &&

        #set $inputFiles = ""

        #for $cms_res in $cmsearch_results:
            #set $inputFiles += str($cms_res)+','
        #end for
        #set $inputFiles = $inputFiles[:-1]

		    perl '$__tool_directory__/glob_res.pl' '$inputFiles' $merge_cluster_ol $merge_overlap $min_cluster_size $cm_min_bitscore $cm_max_eval $cm_bitscore_sig $partition_type '$__tool_directory__'
        #if  $iteration_num.iteration_num_selector:
          $iteration_num.CI

          $final_partition_soft
          $final_partition_used_cmsearch
        #end if

        &&
        python '$__tool_directory__/evaluation.py'
]]>
</command>
    <inputs>
        <param type="data" name="FASTA" format="zip" />
        <param type="data" name="cmsearch_results" format="tabular" multiple="True"/>

        <param name="partition_type" type="boolean" checked="True" truevalue="0" falsevalue="1" label="Hard partition"/>


        <conditional name="iteration_num">
            <param name="iteration_num_selector" type="boolean"  checked="no" label="Multiple iterations"  help="for single iteration- NO, for multiple-YES"/>
            <when value="true">

                  <param name="CI" type="integer" value="2" size="5" label="Number of current iteration ">
                   <sanitizer>
                             <valid initial="string.printable">
                                <remove value="&apos;"/>
                             </valid>
                         </sanitizer>
                 </param>

                <param type="data" name="final_partition_soft" format="txt" />
                <param type="data" name="final_partition_used_cmsearch" format="txt" />

            </when>
            <when value="false" >

           </when>
        </conditional>

        <param name="merge_cluster_ol" type="float" value="0.66" size="5" label="merge_cluster_ol" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="merge_overlap" type="float" value="0.51" size="5" label="merge_overlap" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="min_cluster_size" type="integer" value="3" size="5" label="min_cluster_size" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="cm_min_bitscore" type="integer" value="20" size="5" label="cm_min_bitscore" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="cm_max_eval" type="float" value="0.001" size="5" label="cm_max_eval" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>

        <param name="cm_bitscore_sig" type="integer" value="1" size="5" label="cm_bitscore_sig" help="">
            <sanitizer>
                <valid initial="string.printable">
                    <remove value="&apos;"/>
                </valid>
            </sanitizer>
        </param>


    </inputs>
    <outputs>

    <data name="final_stats" format="txt" from_work_dir="RESULTS/cluster.final.stats" label="cluster.final.stats"  />
    <data name="tableForEval" format="tabular" from_work_dir="RESULTS/fullTab.tabular" label="tableForEval"  />
    <data name="final_soft" format="txt" from_work_dir="RESULTS/partitions/final_partition.soft" label="soft_part"   />
    <data name="final_used_cmsearch" format="txt" from_work_dir="RESULTS/partitions/final_partition.used_cmsearch" label="final_partition_used_cmsearch"   />

    <collection name="clusters" type="list" label="CLUSTERS">
      <discover_datasets pattern="(?P&lt;name&gt;^.*\.all$)" directory="RESULTS"  />
    </collection>

    <collection name="partitions" type="list" label="Partitions">
      <discover_datasets pattern="(?P&lt;name&gt;^.*$)" directory="RESULTS/partitions" />
    </collection>

    </outputs>


    <tests>
        <test>
            <param name="FASTA" value="FASTA.zip" ftype="searchgui_archive"/>
            <param name="cmsearch_results" value="1.tabular,2.tabular"/>
            <!--param name="cmsearch_results" value="2.tabular"/-->

            <output name="final_stats" file="RESULTS/cluster.final.stats"/>

            <output_collection name="clusters" >
              <element name="1.cluster.all" file="RESULTS/1.cluster.all"/>
              <element name="2.cluster.all" file="RESULTS/2.cluster.all"/>
            </output_collection>

            <output_collection name="partitions" >
              <element name="final_overlap.map" file="RESULTS/partitions/final_overlap.map"/>
              <element name="final_overlap.matrix" file="RESULTS/partitions/final_overlap.matrix"/>
              <element name="final_partition.hard.best" file="RESULTS/partitions/final_partition.hard.best"/>
              <element name="final_partition.hard.merged" file="RESULTS/partitions/final_partition.hard.merged"/>
              <element name="final_partition.soft" file="RESULTS/partitions/final_partition.soft"/>
              <element name="final_partition.used_cmsearch" file="RESULTS/partitions/final_partition.used_cmsearch"/>
            </output_collection>

        </test>
    </tests>


    <help>
      <![CDATA[

    **What it does**

    Reporting results

    ]]>
    </help>

    <citations>

      </citations>
</tool>
