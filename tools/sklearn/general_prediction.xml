<tool id="sklearn_prediction" name="General Prediction" version="@VERSION@">
    <description>predicts on new data using a preffited model</description>
    <macros>
        <import>main_macros.xml</import>
        <import>keras_macros.xml</import>
    </macros>
    <expand macro="python_requirements"/>
    <expand macro="macro_stdio"/>
    <version_command>echo "@VERSION@"</version_command>
    <command>
        <![CDATA[
        python "$sklearn_prediction_script" '$inputs'
        ]]>
    </command>
    <configfiles>
        <inputs name="inputs" />
        <configfile name="sklearn_prediction_script">
            <![CDATA[
import json
import numpy as np
import pandas as pd
import sys
import warnings
from sklearn.pipeline import Pipeline

from galaxy_ml.utils import (load_model, read_columns,
                             get_module, try_get_attr)


warnings.filterwarnings('ignore')

input_json_path = sys.argv[1]
with open(input_json_path, 'r') as param_handler:
    params = json.load(param_handler)

## load model
with open('$infile_estimator', 'rb') as est_handler:
    estimator = load_model(est_handler)

infile_weights = '$infile_weights'
if infile_weights != 'None':
    if isinstance(estimator, Pipeline):
        estimator.steps[-1][-1].load_weights(infile_weights)
    else:
        estimator.load_weights(infile_weights)

#if $input_options.selected_input == 'tabular'
header = 'infer' if params['input_options']['header1'] else None
column_option = params['input_options']['column_selector_options_1']['selected_column_selector_option']
if column_option in ['by_index_number', 'all_but_by_index_number', 'by_header_name', 'all_but_by_header_name']:
    c = params['input_options']['column_selector_options_1']['col1']
else:
    c = None
infile1 = '$input_options.infile1'
df = pd.read_csv(infile1, sep='\t', header=header, parse_dates=True)

X = read_columns(df, c=c, c_option=column_option).astype(float)

if params['method'] == 'predict':
    predicted = estimator.predict(X)
else:
    predicted = estimator.predict_proba(X)

#elif $input_options.selected_input == 'sparse':
X = mmread('$input_options.infile1')
if params['method'] == 'predict':
    predicted = estimator.predict(X)
else:
    predicted = estimator.predict_proba(X)

#elif $input_options.selected_input == 'seq_fasta'
if not hasattr(estimator, 'data_batch_generator'):
    raise ValueError(
        "To do prediction on sequences in fasta input, "
        "the estimator must be a `KerasGBatchClassifier`"
        "equipped with data_batch_generator!")
fasta_path = '$input_options.fasta_path'
pyfaidx = get_module('pyfaidx')
sequences = pyfaidx.Fasta(fasta_path)
n_seqs = len(sequences.keys())
X = np.arange(n_seqs)[:, np.newaxis]
seq_length = estimator.data_batch_generator.seq_length
batch_size = getattr(estimator, 'batch_size', 32)
steps = (n_seqs + batch_size - 1) // batch_size

seq_type = params['input_options']['seq_type']
pred_data_generator_klass = try_get_attr('galaxy_ml.preprocessors', seq_type)

pred_data_generator = pred_data_generator_klass(
    fasta_path, seq_length=seq_length)

if params['method'] == 'predict':
    predicted = estimator.predict(
        X, data_generator=pred_data_generator, steps=steps)
else:
    predicted = estimator.predict_proba(
        X, data_generator=pred_data_generator, steps=steps)
#end if


if len(predicted.shape) == 1:
    rval = pd.DataFrame(predicted, columns=['Predicted'])
else:
    rval = pd.DataFrame(predicted)

rval.to_csv(path_or_buf='$outfile_predict', sep='\t', header=True, index=False)

            ]]>
        </configfile>
    </configfiles>
    <inputs>
        <param name="infile_estimator" type="data" format="zip" label="Choose the dataset containing pipeline/estimator object"/>
        <param name="infile_weights" type="data" format="h5" optional="true" label="Choose the dataset containing weights for the estimator above" help="Optional. For deep learning only."/>
        <param argument="method" type="select" label="Select invocation method">
            <option value="predict" selected="true">predict</option>
            <option value="predict_proba">predict_proba</option>
        </param>
        <conditional name="input_options">
            <param name="selected_input" type="select" label="Select input data type for prediction">
                <option value="tabular" selected="true">tabular data</option>
                <option value="sparse">sparse matrix</option>
                <option value="seq_fasta">sequnences in a fasta file</option>
            </param>
            <when value="tabular">
                <param name="infile1" type="data" format="tabular" label="Training samples dataset:"/>
                <param name="header1" type="boolean" optional="true" truevalue="booltrue" falsevalue="boolfalse" checked="False" label="Does the dataset contain header:" />
                <conditional name="column_selector_options_1">
                    <expand macro="samples_column_selector_options" multiple="true"/>
                </conditional>
            </when>
            <when value="sparse">
                <param name="infile1" type="data" format="txt" label="Select a sparse matrix" help=""/>
            </when>
            <when value="seq_fasta">
                <param name="fasta_path" type="data" format="fasta" label="Dataset containing fasta genomic/protein sequences" help="Sequences will be one-hot encoded to arrays."/>
                <param name="seq_type" type="select" label="Sequence type">
                    <option value="FastaDNABatchGenerator">DNA</option>
                    <option value="FastaRNABatchGenerator">RNA</option>
                    <option value="FastaProteinBatchGenerator">Protein</option>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="tabular" name="outfile_predict"/>
    </outputs>
    <tests>
        <test>
            <param name="infile_estimator" value="best_estimator_.zip" ftype="zip"/>
            <param name="method" value="predict"/>
            <param name="infile1" value="regression_X.tabular" ftype="tabular"/>
            <param name="header1" value="true" />
            <param name="col1" value="1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17"/>
            <output name="outfile_predict" file="gen_prediction01.tabular"/>
        </test>
        <test>
            <param name="infile_estimator" value="keras_model04" ftype="zip"/>
            <param name="infile_weights" value="train_test_eval_weights02.h5" ftype="h5"/>
            <param name="method" value="predict"/>
            <param name="infile1" value="regression_X.tabular" ftype="tabular"/>
            <param name="header1" value="true" />
            <param name="col1" value="1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17"/>
            <output name="outfile_predict" file="gen_prediction02.tabular"/>
        </test>
    </tests>
    <help>
        <![CDATA[
**What it does**

Given a fitted estimator and new data sets, this tool outpus the prediction results on the data sets via invoking the estimator's `predict` or `predict_proba` method.

For estimator, this tool supports fitted sklearn estimators (pickled) and trained deep learning models (model skeleton + weights). It predicts on three different dataset inputs,

- tabular

- sparse

- bio-sequences in a fasta file

        ]]>
    </help>
    <expand macro="sklearn_citation">
        <expand macro="keras_citation"/>
    </expand>
</tool>
