<tool id="mqwrapper" name="maxquant" version="@VERSION@">
  <macros>
    <import>macros.xml</import>
  </macros>
  <requirements>
    <requirement type="package" version="@VERSION@">maxquant</requirement>
  </requirements>
  <command detect_errors="exit_code"><![CDATA[
    python3 $__tool_directory__/mqwrapper.py
    --tool_dir=$__tool_directory__
    --num_threads="\${GALAXY_SLOTS:-1}"
    --raw_files=$raw_files
    --version=@VERSION@
    #set names = ','.join([str($name.display_name) for $name in $raw_files])
    --raw_file_names=$names
    --fasta_files=$fasta_files
    #if $no_fractions.no_fractions_true=="false"
      --exp_design='$no_fractions.template'
    #end if
    #if $mode.choose_mode == "interactive"
      --missed_cleavages="$mode.missed_cleavages"
      --min_unique_pep="$mode.min_unique_pep"
      $mode.calc_peak_properties
      $mode.write_mztab
      #if $mode.fixed_mods
        --fixed_mods="$mode.fixed_mods"
      #end if
      #if $mode.var_mods
        --var_mods="$mode.var_mods"
      #end if
      #if $mode.proteases
        --proteases="$mode.proteases"
    #end if
    #if $mode.silac.light_mods
    --light_mods=$mode.silac.light_mods
    #end if
    #if $mode.silac.medium_mods
    --medium_mods=$mode.silac.medium_mods
    #end if
    #if $mode.silac.heavy_mods
    --heavy_mods=$mode.silac.heavy_mods
    #end if
    #else
      --mqpar_in=$mode.mqpar_in
    #end if

    --evidence=$evidence
    --msms=$msms
    --parameters=$parameters
    --peptides=$peptides
    --proteinGroups=$proteinGroups
    --allPeptides=$allPeptides
    --libraryMatch=$libraryMatch
    --matchedFeatures=$matchedFeatures
    --modificationSpecificPeptides=$modificationSpecificPeptides
    --ms3Scans=$ms3Scans
    --msmsScans=$msmsScans
    --mzRange=$mzRange
    --peptideSection=$peptideSection
    --summary=$summary
    --mzTab=$mzTab
    --output_all=$output_all
    --mqpar_out=$mqpar_out

    > $log
    ]]></command>
    <inputs>
      <param multiple="true" name="raw_files" type="data"
	     format="raw" label="RAW Files"
	     help="specify one or more .raw files" />
      <param format="fasta" multiple="true" name="fasta_files"
	     type="data" label="FASTA files"
	     help="specify one or more FASTA databases" />

      <conditional name="no_fractions">
	<param name="no_fractions_true" type="boolean"
	       label="no fractions?" checked="true"/>
	<when value="false">
	  <param format="tabular" name="template" type="data"
		 label="specify an experimental design template" />
	</when>
	<when value="true">
	</when>
      </conditional>
      
      <conditional name="mode">
	<param name="choose_mode" type="select" label="choose mode">
	  <option value="interactive">specify search parameters</option>
	  <option value="mqpar">specify mqpar.xml</option>
	</param>
	<when value="interactive">
	  <param type="integer" name="missed_cleavages"
		 label="missed cleavages" value="1"/>
	  <param type="integer" name="min_unique_pep"
		 label="min. unique peptides" value="1" />
	  <param name="calc_peak_properties" type="boolean" checked="false"
		 label="Calculate peak properties?"
		 truevalue="--calc_peak_properties" falsevalue="" />
	  <param name="fixed_mods" type="select" label="fixed modifications"
		 multiple="true" help="select zero or more fixed modifications">
            <expand macro="modification"/>
          </param>
	  <param name="var_mods" type="select" label="variable modifications"
		 multiple="true" help="select zero or more variable modifications">
            <expand macro="modification"/>
          </param>
	  <param name="proteases" type="select" label="proteases"
		 multiple="true" help="select zero or more proteases">
            <expand macro="proteases"/>
          </param>
	  <section title="Silac" name="silac" expanded="true">
	    <param name="light_mods" type="select" label="light modifications"
		 multiple="true" help="select zero or more light modifications">
              <expand macro="label"/>
            </param>
	    <param name="medium_mods" type="select" label="medium modifications"
		 multiple="true" help="select zero or more medium modifications">
              <expand macro="label"/>
            </param>
	    <param name="heavy_mods" type="select" label="heavy modifications"
		 multiple="true" help="select zero or more heavy modifications">
              <expand macro="label"/>
            </param>
	  </section>
	  <param name="write_mztab" type="boolean" checked="false"
		 label="Write mztab file?"
		 truevalue="--write_mztab" falsevalue="" />
	</when>
	<when value="mqpar">
	  <param type="data" name="mqpar_in" format="xml"
		 label="mqpar.xml with your search parameters. Raw file names 
			must match the names displayed in galaxy. Their paths 
			from the local machine are ignored."/>
	</when>
      </conditional>
      <param type="select" name="output" label="Select the desired outputs."
	     multiple="true" optional="false">
	<expand macro="output_option" name="proteinGroups" label="Protein Groups"/>
	<expand macro="output_option" name="mqpar_out" label="mqpar.xml"/>
	<expand macro="output_option" name="peptides" label="Peptides"/>
	<expand macro="output_option" name="evidence" label="Evidence"/>
	<expand macro="output_option" name="parameters" label="Tabular Paramters"/>
	<expand macro="output_option" name="msms" label="MSMS"/>
	<expand macro="output_option" name="mzTab" label="mzTab"/>
	<expand macro="output_option" name="allPeptides" label="all peptides"/>
	<expand macro="output_option" name="libraryMatch" label="library match"/>
	<expand macro="output_option" name="matchedFeatures" label="matched features"/>
	<expand macro="output_option" name="modificationSpecificPeptides"
		label="modification specific peptides"/>
	<expand macro="output_option" name="ms3Scans" label="ms3 scans"/>
	<expand macro="output_option" name="msmsScans" label="msms scans"/>
	<expand macro="output_option" name="mzRange" label="mz range"/>
	<expand macro="output_option" name="peptideSection" label="peptide section"/>
	<expand macro="output_option" name="summary" label="summary"/>
	<expand macro="output_option" name="output_all"
		label="complete 'combined/txt/' directory (compressed)"/>
      </param>
    </inputs>
    
    <outputs>
      <expand macro="output" name="mqpar_out" label="mqpar.xml" format="xml"/>
      <expand macro="output" name="proteinGroups" label="MaxQuant Protein Groups"/>
      <expand macro="output" name="peptides" label="MaxQuant Peptides"/>
      <expand macro="output" name="evidence" label="MaxQuant Evidence"/>
      <expand macro="output" name="parameters" label="MaxQuant Tabular Parameters"/>
      <expand macro="output" name="msms" label="MaxQuant MSMS"/>
      <expand macro="output" name="mzTab" label="mzTab"/>
      <expand macro="output" name="allPeptides" label="all peptides"/>
      <expand macro="output" name="libraryMatch" label="library match"/>
      <expand macro="output" name="matchedFeatures" label="matched features"/>
      <expand macro="output" name="modificationSpecificPeptides"
	      label="modification specific peptides"/>
      <expand macro="output" name="ms3Scans" label="ms3 scans"/>
      <expand macro="output" name="msmsScans"
	      label="msms Scans"/>
      <expand macro="output" name="mzRange"
	      label="mz range"/>
      <expand macro="output" name="peptideSection"
	      label="peptide section"/>
      <expand macro="output" name="summary"
	      label="MaxQuant summary"/>
      <expand macro="output" format="tar" name="output_all"
	      label="'combined/txt/' directory"/>
      <data name="log" format="txt"
	    label="log"/>
    </outputs>

    <tests>
      <test>
	<param name="raw_files" value="single/BSA_min_23.raw" />
	<param name="fasta_files" value="bsa.fasta" />
	<param name="choose_mode" value="interactive" />
	<param name="min_unique_pep" value="0" />
	<param name="fixed_mods" value="Carbamidomethyl (C)" />
	<param name="var_mods" value="Oxidation (M)" />
	<param name="proteases" value="Trypsin/P" />
	<param name="write_mztab" value="true" />
	<param name="output" value="evidence,msms,mzTab,allPeptides,msmsScans,mzRange,parameters,peptides,peptideSection,proteinGroups,summary,modificationSpecificPeptides" />
	<output name="evidence" file="single/combined/txt/evidence.txt" />
	<output name="msms" file="single/combined/txt/msms.txt" />
	<output name="mzTab" file="single/combined/txt/mzTab.mzTab" lines_diff="4"/>
	<output name="allPeptides" file="single/combined/txt/allPeptides.txt" lines_diff="2"/>
	<output name="msmsScans" file="single/combined/txt/msmsScans.txt" />
	<output name="mzRange" file="single/combined/txt/mzRange.txt" />
	<output name="parameters" file="single/combined/txt/parameters.txt" lines_diff="10"/>
	<output name="peptides" file="single/combined/txt/peptides.txt" />
	<output name="peptideSection" file="single/combined/txt/peptideSection.txt" />
	<output name="proteinGroups" file="single/combined/txt/proteinGroups.txt" />
	<output name="summary" file="single/combined/txt/summary.txt" />
	<output name="modificationSpecificPeptides" file="single/combined/txt/modificationSpecificPeptides.txt" />
	</test>
      <test>
	<param name="raw_files" value="two/BSA_min_21.raw,two/BSA_min_22.raw" />
	<param name="fasta_files" value="bsa.fasta" />
	<param name="choose_mode" value="mqpar" />
	<param name="mqpar_in" value="two/mqpar.xml" />
	<param name="no_fractions_true" value="false" />
	<param name="template" value="two/exp_design_template.txt" />
	<param name="output" value="evidence,msms,mzTab,allPeptides,msmsScans,mzRange,parameters,peptides,peptideSection,proteinGroups,summary,modificationSpecificPeptides" />
	<output name="evidence" file="two/combined/txt/evidence.txt" />
	<output name="msms" file="two/combined/txt/msms.txt" />
	<output name="mzTab" file="two/combined/txt/mzTab.mzTab" lines_diff="6"/>
	<output name="allPeptides" file="two/combined/txt/allPeptides.txt" lines_diff="24"/>
	<output name="msmsScans" file="two/combined/txt/msmsScans.txt" />
	<output name="mzRange" file="two/combined/txt/mzRange.txt" />
	<output name="parameters" file="two/combined/txt/parameters.txt" lines_diff="8"/>
	<output name="peptides" file="two/combined/txt/peptides.txt" />
	<output name="peptideSection" file="two/combined/txt/peptideSection.txt" />
	<output name="proteinGroups" file="two/combined/txt/proteinGroups.txt" />
	<output name="summary" file="two/combined/txt/summary.txt" />
	<output name="modificationSpecificPeptides" file="two/combined/txt/modificationSpecificPeptides.txt" />
	</test>
    </tests>
    <help><![CDATA[
    mqwrapper doesn't provide any fasta databases,
    every database has to be provided by the user!
    ]]></help>
    <citations>
      <citation type="bibtex">
	@article{cox2008maxquant,
	title={MaxQuant enables high peptide identification rates, individualized \
	ppb-range mass accuracies and proteome-wide protein quantification},
	author={Cox, J{\"u}rgen and Mann, Matthias},
	journal={Nature biotechnology},
	volume={26},
	number={12},
	pages={1367},
	year={2008},
	publisher={Nature Publishing Group}
      } </citation>
      <citation type="bibtex">
	@article{tyanova2016maxquant,
	title={The MaxQuant computational platform for mass \
	spectrometry-based shotgun proteomics},
	author={Tyanova, Stefka and Temu, Tikira and Cox, J{\"u}rgen},
	journal={Nature protocols},
	volume={11},
	number={12},
	pages={2301},
	year={2016},
	publisher={Nature Publishing Group}
} </citation>
    </citations>

</tool>
