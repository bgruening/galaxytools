<tool id="cp_identify_tertiary_objects" name="IdentifyTertiarxObjects" version="@CP_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>with CellProfiler</description>

    <macros>
        <import>macros.xml</import>
        <token name="@VERSION_SUFFIX@">1</token>
    </macros>

    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">CellProfiler</xref>
        <xref type="biii">cellprofiler</xref>
    </xrefs>

    <expand macro="py_requirements"/>
    <expand macro="cmd_modules" />

    <configfiles>
        <inputs name="inputs" />
        <configfile name="script_file">
import json
import sys
import os

FOURSPACES=@SPACES@

input_json_path = sys.argv[1]
input_pipeline= sys.argv[2]

params = json.load(open(input_json_path, "r"))

def writemoi():
    _str = "\nIdentifyTertiaryObjects:[module_num:%d|svn_version:\\'Unknown\\'|variable_revision_number:3|show_window:False|notes:\\x5B\\x5D|batch_state:array(\\x5B\\x5D, dtype=uint8)|enabled:True|wants_pause:False]\n" % new_count
    
    _str += FOURSPACES + "Select the larger identified objects:%s\n" % params['larger_identify_object']
    _str += FOURSPACES + "Select the smaller identified objects:%s\n" % params['smaller_identify_object']
    _str += FOURSPACES + "Name the tertiary objects to be identified:%s\n" % params['tertiary_object']
    _str += FOURSPACES + "Shrink smaller object prior to subtraction?%s\n" % params['shrink_objects']

    return _str


with open(input_pipeline) as fin:
    lines = fin.readlines()

    k, v = lines[4].strip().split(':')

    module_count = int(v)
    new_count = module_count + 1
    lines[4] = k + ":%d\n" % new_count
    with open("output.cppipe", "w") as f:
        f.writelines(lines)
        f.write(writemoi())

    f.close()
        </configfile>
    </configfiles>

    <inputs>
        <expand macro="input_pipeline_param" />
            <param name="larger_identify_object" label="Select the larger identified objects" type="text">
                <expand macro="text_validator" />
            </param>
            <param name="smaller_identify_object" label="Select the smaller identified objects" type="text">
                <expand macro="text_validator" />
            </param>
            <param name="tertiary_object" label="Name the tertiary objects to be identified" type="text">
                <expand macro="text_validator" />
            </param>
            <param name="shrink_objects" label=" Shrink smaller object prior to subtraction?" type="select">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
            </param>
    </inputs>

    <outputs>
        <expand macro="output_pipeline_param" />
    </outputs>

    <tests>
        <test>
            <expand macro="test_input_pipeline_param" />
            <param name="larger_identify_object" value="Cells" />
            <param name="smaller_identify_object" value="Nuclei" />
            <param name="tertiary_object" value="Cytoplasm" />
            <param name="shrink_objects" value="Yes" />
            <expand macro="test_out_file" file="measure_object_intensity.cppipe" />
        </test>
    </tests>

    <help>
        <![CDATA[

            .. class:: infomark

            **What it does**

           identifies tertiary objects (e.g., cytoplasm) by removing smaller primary objects (e.g. nuclei) from larger secondary objects (e.g., cells), leaving a ring shape. 

            ]]>
    </help>



    <expand macro="citations" />

</tool>